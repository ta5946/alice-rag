## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/DATA/production/gen_topo_helper_functions.sh

**Start chunk id:** c0d80562aeb03c256ee08e0b3338b03f770254b2e96cb7864280194b4ab5951f

## Content

**Question:** What does the `SOURCE_GUARD_FUNCTIONS` variable do in the script?

**Answer:** The `SOURCE_GUARD_FUNCTIONS` variable is used to prevent the script from sourcing itself twice. It is set to 1 the first time the script runs and acts as a flag to check whether the script has already been sourced.

---

**Question:** Which function would you use to check if the workflow includes the calibration reconstruction for a specific detector, and what are the necessary conditions for this function to return true?

**Answer:** To check if the workflow includes the calibration reconstruction for a specific detector, you would use the function `has_detector_calib`. This function returns true if the detector is listed in the `WORKFLOW_DETECTORS` variable and also in the `WORKFLOW_DETECTORS_CALIB` variable.

---

**Question:** What is the sequence of detector checks performed by the `has_detector` function and how does it handle the case when a detector is not specified in the `WORKFLOW_DETECTORS` variable?

**Answer:** The `has_detector` function checks if a specified detector is present in the `WORKFLOW_DETECTORS` variable. It does this by using a regular expression to search for the detector name within the string value of `WORKFLOW_DETECTORS`. If the detector name is found, the function returns true; otherwise, it returns false.

If the detector is not specified in the `WORKFLOW_DETECTORS` variable, the function will return false. This means that the specified detector is not included in the workflow for processing.

---

**Question:** What does the `has_detector_matching` function check?

**Answer:** The `has_detector_matching` function checks if a specified detector is included in the list of detectors for which matching is required, or if matching is required for all detectors. It does this by first checking if the environment variable `WORKFLOW_DETECTORS_MATCHING` contains "ALL", indicating matching is required for all detectors. If not, it checks if the specified detector name is listed in `WORKFLOW_DETECTORS_MATCHING`.

---

**Question:** What conditions must be met for the `has_pid_qc` function to return 0, and how does it handle the TOF detector differently from others?

**Answer:** For the `has_pid_qc` function to return 0, the following conditions must be met:

1. The detector specified by `PIDDETECTOR` must be listed in the `WORKFLOW_DETECTORS_QC` variable.
2. For the TOF detector, an additional condition is checked:
   - It must not have both ITS, TPC, and TOF detectors configured for reconstruction and matching (i.e., `has_detectors_reco ITS TPC TOF` must be false).
   - It must not have matching configured for ITSTPCTOF (i.e., `has_detector_matching ITSTPCTOF` must be false).

For all other detectors (excluding TOF), the function only requires that the detector is listed in the `WORKFLOW_DETECTORS_QC` variable.

The function handles the TOF detector differently by performing an extra check to ensure that the specified condition regarding ITS, TPC, and TOF reconstruction and matching is not met, whereas for other detectors, it solely checks the `WORKFLOW_DETECTORS_QC` variable for the detector's presence.

---

**Question:** What conditions must be met for the `has_pid_qc` function to return 0, considering the specific case where the PID detector is TOF?

**Answer:** For the `has_pid_qc` function to return 0 when the PID detector is TOF, the following conditions must be satisfied:
1. The detector matching must be present for TOF, or all detectors must be included in the matching check.
2. The detector QC must be present for TOF, or all detectors must be included in the QC check.
3. Either the TOF detector is not being used with both ITS, TPC, and TOF detectors, or the ITSTPCTOF matching is not being used.
4. The detector QC must be present for all other PID detectors apart from TOF.

---

**Question:** What does the `has_track_source` function check for in the given document?

**Answer:** The `has_track_source` function checks if a given source name is present in the `TRACK_SOURCES` string. It does this by using a regular expression to search for the exact name or a comma-separated match that includes the name as a substring within `TRACK_SOURCES`.

---

**Question:** What does the `_check_multiple` function do and how is it used in the script?

**Answer:** The `_check_multiple` function checks if a series of conditions specified by the first argument (`CHECKER`) are true for each element in the subsequent arguments. If any condition fails, it returns 1; otherwise, if all conditions are true, it returns 0. This function is used in several other functions to verify the presence of multiple detector-related steps or sources. For example, the `has_detectors` function uses `_check_multiple` with the `has_detector` function to check for the existence of multiple detector steps.

---

**Question:** What specific condition must be met for the `has_detectors_gpu` function to return 1, and how does it relate to the `_check_multiple` function?

**Answer:** The `has_detectors_gpu` function will return 1 if any of the detector-specific functions (e.g., `has_detector_gpu`) that it calls return false for a detector argument. Specifically, it will iterate over all the provided detector arguments and use the `_check_multiple` function to ensure that all these detector functions return true. If any detector function returns false for a given detector, `_check_multiple` will return 1, causing `has_detectors_gpu` to also return 1. Conversely, if all detector functions return true for their respective detectors, `has_detectors_gpu` will return 0.

---

**Question:** What does the `add_comma_separated` function do and what error message does it display if it receives fewer than 2 parameters?

**Answer:** The `add_comma_separated` function concatenates the string in the first parameter by the following ones, forming a comma-separated string. If it receives fewer than 2 parameters, it displays the following error message:

```
1 parameters received
Function name: add_comma_separated expects at least 2 parameters:
it concatenates the string in 1st parameter by the following
ones, forming comma-separated string. 1 parameters received
```

---

**Question:** What is the purpose of the `add_comma_separated` function and how does it handle the case when fewer than two parameters are provided?

**Answer:** The `add_comma_separated` function is designed to concatenate strings in a comma-separated format. It starts by checking if at least two parameters are provided. If fewer than two parameters are given, it outputs an error message detailing the expected parameters and the number received, then exits with an error. When at least two parameters are provided, it iterates through the parameters starting from the second one, appending them to the first parameter with a comma separator if the first parameter is not empty, or directly concatenating without a leading comma if it is.

---

**Question:** What specific conditions must be met for the `add_comma_separated` function to successfully concatenate its parameters into a comma-separated string, and what happens if these conditions are not met?

**Answer:** For the `add_comma_separated` function to successfully concatenate its parameters into a comma-separated string, it must receive at least 2 parameters. The function then iterates from the second parameter to the last, concatenating each subsequent parameter to the first one, separated by commas.

If the function does not receive at least 2 parameters, it will output an error message indicating the number of parameters received, the expected parameters, and the issue with the number of received parameters. It will then exit with an error code.

---

**Question:** What does the `add_pipe_separated` function do if it receives fewer than 2 parameters?

**Answer:** The `add_pipe_separated` function will output the number of parameters received, specify that it expects at least 2 parameters, and then exit with status 1 if fewer than 2 parameters are provided.

---

**Question:** What is the main difference between the `add_pipe_separated` function and the unnamed function provided at the beginning of the document?

**Answer:** The main difference between the `add_pipe_separated` function and the unnamed function provided at the beginning of the document lies in how they concatenate the input parameters.

The unnamed function concatenates the parameters using a semicolon as the separator. It initializes the variable pointed to by the first argument with the value of the second argument and then appends the values of subsequent arguments to it, separated by a semicolon.

On the other hand, the `add_pipe_separated` function uses a pipe symbol as the separator. It starts by checking if at least two parameters are provided. If not, it exits with an error message. Then, it initializes the variable pointed to by the first argument with the value of the second argument and appends the values of the remaining arguments, separated by a pipe symbol.

Both functions utilize similar logic to concatenate strings, but they differ in the delimiter used for separation.

---

**Question:** What is the difference in the string concatenation approach between the `add_pipe_separated` function and the unnamed function provided in the document?

**Answer:** The unnamed function appends elements to the first parameter using a semicolon as a separator, whereas the `add_pipe_separated` function appends elements to the first parameter using a pipe symbol as a separator.

---

**Question:** What is the default value used for the variable "$N_" if no additional name is provided when calling the get_N function?

**Answer:** The default value used for the variable "$N_" if no additional name is provided when calling the get_N function is 1.

---

**Question:** What happens if the `GEN_TOPO_AUTOSCALE_PROCESSES_GLOBAL_WORKFLOW` variable is set to 1, the `GEN_TOPO_AUTOSCALE_PROCESSES` variable is also set to 1, the workflow mode is not "print" or the `GEN_TOPO_RUN_HOME_TEST` variable is set to 1, and the fourth argument is not 0?

**Answer:** If the `GEN_TOPO_AUTOSCALE_PROCESSES_GLOBAL_WORKFLOW` variable is set to 1, the `GEN_TOPO_AUTOSCALE_PROCESSES` variable is set to 1, the workflow mode is not "print" or the `GEN_TOPO_RUN_HOME_TEST` variable is set to 1, and the fourth argument is not 0, then the process scaling multiplier `MULT` is recalculated without using the existing value of `MULT`. Instead, the function will compute a new value for `MULT` as follows:

1. It will multiply the existing value of `MULT` (or 1 if not set) by the value of `N_F_$3` (which is the factor for the type of data - RAW, CTF, or REST).
2. It will then multiply the result by the value of `MULTIPLICITY_FACTOR_DETECTOR_$2` (which is the detector-specific factor).
3. It will multiply the result by the value of `MULTIPLICITY_FACTOR_PROCESS_${1//-/_}` (which is the process-specific factor, with underscores replacing dashes in the process name).
4. Finally, it will multiply the result by the default value of `N_${5:-}` (which is 1 if no fifth argument is provided).

After these multiplications, if the `EPN_GLOBAL_SCALING` variable is not empty and the process name is not "gpu-reconstruction", the result will be further multiplied by the value of `EPN_GLOBAL_SCALING`.

---

**Question:** What is the value of the variable `MULT` if `GEN_TOPO_AUTOSCALE_PROCESSES_GLOBAL_WORKFLOW` is 1, `GEN_TOPO_AUTOSCALE_PROCESSES` is 1, `WORKFLOWMODE` is not "print" or `GEN_TOPO_RUN_HOME_TEST` is 1, and the fourth argument is not 0?

**Answer:** The value of the variable `MULT` in this scenario is calculated as follows:

1. First, the default value of `MULT` is determined by multiplying several factors:
   - `MULTIPLICITY_FACTOR_PROCESS_${1//-/_}`
   - `MULTIPLICITY_FACTOR_DETECTOR_$2`
   - `N_F_$3`
   - `N_${5:-}` (with a default value of 1 if the optional name is not provided)

2. If the environment variable `EPN_GLOBAL_SCALING` is not empty and the processor name is not "gpu-reconstruction", the value of `MULT` is adjusted by multiplying it with the value of `EPN_GLOBAL_SCALING`.

3. If all the conditions specified are met (i.e., `GEN_TOPO_AUTOSCALE_PROCESSES_GLOBAL_WORKFLOW` is 1, `GEN_TOPO_AUTOSCALE_PROCESSES` is 1, `WORKFLOWMODE` is not "print" or `GEN_TOPO_RUN_HOME_TEST` is 1, and the fourth argument is not 0), the value of `MULT` is then recalculated as:

   ```
   MULT=$(($MULT * $4))
   ```

   Where `$4` is the value of the fourth argument provided to the function.

---

**Question:** What will be the output of the function if the value of MULT is 150 and AUTOSCALE_PROCESS_FACTOR is 80?

**Answer:** The output of the function will be 16:$MULT. Given the conditions, since \( \left( \left( 150 \times \frac{80}{100} \right) < 16 \right) \) is false, the function uses the else condition, resulting in 16:$MULT.

---

**Question:** What condition determines when the autoscaled process factor is capped at 16 in the given script?

**Answer:** The condition that determines when the autoscaled process factor is capped at 16 is when the product of $MULT and the autoscale process factor divided by 100 is less than 16.

---

**Question:** What is the minimum value that the autoscaled process factor will never drop below, and under what condition does this occur in the given script?

**Answer:** The minimum value that the autoscaled process factor will never drop below is 16. This occurs when the expression \((\$MULT*\$AUTOSCALE_PROCESS_FACTOR/100) < 16\) evaluates to true. If this condition is met, the script will autoscale the process factor to 16. If the condition is not met, the script will use the original \$MULT value.

---

**Question:** What does the `math_max()` function do?

**Answer:** The `math_max()` function returns the larger of two input values. It compares the two arguments using the '>' operator and echoes the first argument if it is greater, otherwise it echoes the second argument.

---

**Question:** What does the `needs_root_output` function return and how does it determine whether root output is requested for a specific process?

**Answer:** The `needs_root_output` function returns a boolean value, either true or false, indicating whether root output is requested for a specific process. It determines this by checking if an environment variable with a specific name is set. The name of the environment variable is derived from the process name by replacing hyphens with underscores and appending "_ENABLE_ROOT_OUTPUT". If the variable is set, the function returns true, indicating that root output is requested; otherwise, it returns false.

---

**Question:** What is the purpose of the `needs_root_output` function and how does it determine if root output is required for a specific process?

**Answer:** The `needs_root_output` function checks if root output is requested for a specific process. It does this by examining an environment variable that is formed by converting the process name to uppercase and replacing hyphens with underscores, prefixed with `ENABLE_ROOT_OUTPUT_`. For example, for a process named "My-Process", it would check for the existence of the `ENABLE_ROOT_OUTPUT_MY_PROCESS` environment variable. If this variable is defined, the function returns true, indicating that root output is required for that process; otherwise, it returns false.

---

**Question:** What does the `add_W` function do with the `ARGS_ALL_CONFIG` option if it is not provided?

**Answer:** If the `ARGS_ALL_CONFIG` option is not provided, it defaults to 1.

---

**Question:** What happens if the `DISABLE_ROOT_OUTPUT` environment variable is set and the process `$1` needs root output according to the `needs_root_output` function?

**Answer:** If the `DISABLE_ROOT_OUTPUT` environment variable is set and the process `$1` requires root output as determined by the `needs_root_output` function, then the command line option corresponding to `DISABLE_ROOT_OUTPUT` is removed from the workflow command being constructed.

---

**Question:** What specific condition must be met for the `DISABLE_ROOT_OUTPUT` variable to be removed from the `WFADD` command, and how does this affect the workflow addition process?

**Answer:** The `DISABLE_ROOT_OUTPUT` variable will be removed from the `WFADD` command if the `needs_root_output` function returns true for the provided binary name, and the `DISABLE_ROOT_OUTPUT` variable is non-empty. This condition ensures that even if `DISABLE_ROOT_OUTPUT` is set, the addition of root output for the specified binary will still be processed, thereby allowing the workflow to include root output generation for that binary. The removal of `DISABLE_ROOT_OUTPUT` from `WFADD` means that the command to add the binary to the workflow will not be altered by the presence of this variable, ensuring that root output can be generated for the specified binary as intended.

---

**Question:** What happens if the `EPNSYNCMODE` environment variable is not set to 1?

**Answer:** If the `EPNSYNCMODE` environment variable is not set to 1, neither the `GEN_TOPO_QC_CONSUL_SERVER` variable is defined nor the `add_QC_from_consul` function will fetch and apply the QC JSON from Consul. Specifically, the `add_QC_from_consul` function checks for `EPNSYNCMODE == 1` and if this condition is not met, it prints an error message and exits with a status of 1.

---

**Question:** What is the default value of `GEN_TOPO_QC_CONSUL_SERVER` when `GEN_TOPO_DEPLOYMENT_TYPE` is not "ALICE_STAGING"?

**Answer:** The default value of `GEN_TOPO_QC_CONSUL_SERVER` when `GEN_TOPO_DEPLOYMENT_TYPE` is not "ALICE_STAGING" is `alio2-cr1-hv-con01.cern.ch`.

---

**Question:** What is the exact command used to fetch the QC JSON configuration from Consul and what are the conditions under which this command is executed?

**Answer:** The exact command used to fetch the QC JSON configuration from Consul is:

```
curl -s "http://${GEN_TOPO_QC_CONSUL_SERVER}:8500/v1/kv${1}?raw"
```

This command is executed under the following conditions:

1. `EPNSYNCMODE` is set to `1`.
2. The script attempts to fetch the QC JSON configuration by calling the `add_QC_from_consul` function.
3. The function checks if the `GEN_TOPO_QC_JSON_FILE` variable is not empty.
4. If `GEN_TOPO_QC_JSON_FILE` is not empty, the command fetches the content from Consul and saves it to the file specified by `GEN_TOPO_QC_JSON_FILE`.
5. If the command returns a non-zero exit status, an error message is printed and the script exits with an error.

---

**Question:** What is the output of the function if the `EPNSYNCMODE` environment variable is not set to 1?

**Answer:** The function will output an error message stating "Error fetching QC JSON $1: apricot server only set for EPNSYNCMODE == 1" and exit with status 1.

---

**Question:** What does the script do if the `GEN_TOPO_QC_JSON_FILE` environment variable is set and the input string contains a question mark?

**Answer:** The script will execute a curl command to fetch the QC JSON file from the specified apricot server URL, appending the question mark and the query parameter "process=true". If the curl command returns an error (non-zero exit status), it will print an error message and exit. Otherwise, it will set the `QC_CONFIG_ARG` variable to the path of the fetched JSON file.

---

**Question:** What specific conditions must be met for the `add_QC_from_apricot()` function to use the `apricot://${GEN_TOPO_QC_APRICOT_SERVER}$1` format instead of the `json://` format for the QC configuration argument?

**Answer:** For the `add_QC_from_apricot()` function to use the `apricot://${GEN_TOPO_QC_APRICOT_SERVER}$1` format instead of the `json://` format for the QC configuration argument, the `${GEN_TOPO_QC_JSON_FILE}` variable must be empty.