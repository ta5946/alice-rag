## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/test/run_workflow_tests.sh

**Start chunk id:** 0eb665cae58be88073795e0e53fd431802b903ae91d361bd5d1ae3e20f03f465

## Content

**Question:** What actions are taken if changes are detected in the simulation binary files?

**Answer:** If changes are detected in the simulation binary files, the system tests the creation of all workflows against these changes.

---

**Question:** What actions are taken if changes are detected in the central Python scripts located in the `MC/bin/` directory?

**Answer:** If changes are detected in the central Python scripts located in the `MC/bin/` directory, the anchored MC test will be marked to be run.

---

**Question:** What condition must be met for the script to include the execution of workflows in the `execute_workflows` variable?

**Answer:** The script includes the execution of workflows in the `execute_workflows` variable if either `${changed_analysis_qc}` is not an empty string or `${changed_sim_bin}` is set.

---

**Question:** What are the steps taken if the initial condition `[[ "${ret_this}" == "0" ]]` is not met in the given script?

**Answer:** If the initial condition `[[ "${ret_this}" == "0" ]]` is not met, the script does the following:

1. It echoes "[FATAL]: O2DPG_TEST Workflow execution failed" to the log file specified by `${LOG_FILE_WF}`.
2. The script then ends without executing the workflow or performing any further actions related to analysis or quality control.
3. The `return` statement at the end of the script will return the value of `${ret_this}`, which has been incremented but is now non-zero due to the failure condition.

---

**Question:** What action is taken if the workflow creation script does not exit due to a specific condition, but instead contains an "exit" command that is not related to the need for O2DPG?

**Answer:** If the workflow creation script contains an "exit" command that is not related to the need for O2PG, the script will not be tested automatically. Instead, a warning will be issued, indicated by the echo_yellow " -> WARNING" message, and the function will return 0.

---

**Question:** What is the purpose of the `get_git_repo_directory` function and how does it determine the git repository directory?

**Answer:** The `get_git_repo_directory` function aims to identify the root directory of a Git repository given a starting directory. It performs this task by first resolving the absolute path of the provided directory and then stripping off the ".git" subdirectory. The function then attempts to find the actual ".git" directory within the parent directories of the provided path. If a valid Git repository is found, its root directory is determined and returned. If no Git repository is detected, the function returns an empty string.

To accomplish this, the function uses a combination of shell commands and a subshell. It starts by setting the `look_dir` to the provided directory or the current working directory if no argument is given. The `realpath` command is then used to get the absolute path of `look_dir`. The directory is modified to remove the trailing ".git" if present. The function then changes to the `look_dir` and uses `git rev-parse --git-dir` to find the actual location of the ".git" directory. If a valid ".git" directory is found, its absolute path is determined and the ".git" part is removed to get the root of the Git repository. The function finally echoes the determined repository root directory or an empty string if no repository is found.

---

**Question:** What are the commands used to run the AnalysisQC CLI for both MC and data, and what happens if the commands fail?

**Answer:** The commands used to run the AnalysisQC CLI for MC and data are as follows:

For MC:
```
${O2DPG_ROOT}/MC/analysis_testing/o2dpg_analysis_test_workflow.py -f AO2D.root --is-mc -o wokflow_test_mc.json
```

For data:
```
${O2DPG_ROOT}/MC/analysis_testing/o2dpg_analysis_test_workflow.py -f AO2D.root -o wokflow_test_data.json
```

If these commands fail, the script will append "[FATAL]: O2DPG_TEST failed" to the ${LOG_FILE_ANALYSISQC} log file. If the command for MC fails, it sets the return value to the variable `ret`. If the command for data fails, it sets the return value to `ret_data` and if this happens, it also appends the "[FATAL]: O2DPG_TEST failed" message and sets `ret` to `ret_data`.

---

**Question:** What will happen if the `test_anchored` function returns a non-zero exit code?

**Answer:** If the `test_anchored` function returns a non-zero exit code, the script will print "ERROR executing anchored simulation." and then call the `print_error_logs` function to display any relevant logs. The global return code `ret_global_anchored` will be set to the non-zero exit code of `test_anchored`.

---

**Question:** What does the script do if the desired test script specified in the `to_run` variable does not exist?

**Answer:** If the desired test script specified in the `to_run` variable does not exist, the script will print the message "Desired test script ${anchored_script} does not exist. Skip." and continue with the next iteration of the loop.

---

**Question:** What will happen if the directory specified by `REPO_DIR` is not a git repository?

**Answer:** If the directory specified by `REPO_DIR` is not a git repository, the script will output "ERROR: Directory \"${REPO_DIR}\" is not a git repository." and then exit with a status code of 1.

---

**Question:** What does the return value of this script segment indicate based on the echo commands?

**Answer:** The return value of this script segment indicates failure if the variable "ret" does not match "0", which triggers the echo_red command to display " -> FAILED". Conversely, if "ret" equals "0", the echo_green command outputs " -> PASSED".

---

**Question:** What is the purpose of the `O2DPG_TEST_WORKFLOW_MEMLIMIT` environment variable and in which scenario is it used?

**Answer:** The `O2DPG_TEST_WORKFLOW_MEMLIMIT` environment variable is used to specify the memory limit that should be applied when running a workflow with the workflow runner. It is utilized in scenarios where it is necessary to constrain the amount of memory a workflow is allowed to use during execution.

---

**Question:** What is the purpose of the `test_single_wf` function call within the loop, and how does it affect the overall workflow creation process?

**Answer:** The `test_single_wf` function is called within the loop to execute individual workflow scripts. For each script specified in the `wf_scripts` variable, this function tests and runs the workflow creation process. If the `--execute` flag is provided, the function will actually run the workflow scripts, otherwise, it will perform a test run without executing them. The return value of `test_single_wf` is stored in the `ret_this` variable and used to update the `RET` variable, which keeps track of any failures encountered during the process. If `test_single_wf` returns a non-zero value, indicating a failure, the `RET` variable is set to this value, signaling an error in the workflow creation process.

---

**Question:** What action is taken if the `changed_analysis_qc` variable is not empty?

**Answer:** If the `changed_analysis_qc` variable is not empty, the following actions are taken:

1. The directory `${TEST_PARENT_DIR_BIN}` is recursively removed, with errors being suppressed.
2. The directory `${TEST_PARENT_DIR_BIN}` is created if it does not already exist, with errors being suppressed.
3. The current directory is changed to `${TEST_PARENT_DIR_BIN}`.
4. A message is printed indicating the start of the block for testing the workflow with AnalysisQC.
5. The command line interface for AnalysisQC is tested.
6. The return code from the command line interface test is stored in `ret_analysis_qc`.
7. If the return code is 0, all bin test WF creations are run and the return code is updated.
8. If the return code is not 0, an error message is printed, and error logs are printed.
9. A message is printed indicating the end of the block for testing the workflow with AnalysisQC.

---

**Question:** What command is used to run the O2DPG workflow if the initial workflow creation is successful and the `execute` variable is set?

**Answer:** The command used to run the O2DPG workflow if the initial workflow creation is successful and the `execute` variable is set is:

${O2DPG_ROOT}/MC/bin/o2_dpg_workflow_runner.py -f workflow.json --cpu-limit 8 -tt aod ${memlimit} >> ${LOG_FILE_WF} 2>&1

This command is executed after the initial workflow creation is successful and the `execute` variable is not empty. It runs the O2DPG workflow with specific parameters and appends the output to the log file.

---

**Question:** What happens to the `O2DPG_TEST_HASH_BASE` variable if neither `ALIBUILD_BASE_HASH` nor a specific base hash is provided, and there are unstaged changes in the repository?

**Answer:** If neither `ALIBUILD_BASE_HASH` nor a specific base hash is provided, and there are unstaged changes in the repository, the `O2DPG_TEST_HASH_BASE` variable will be set to `HEAD`.

---

**Question:** What is the purpose of the `run_workflow_creation` function call and how does the script handle potential errors during workflow creation?

**Answer:** The `run_workflow_creation` function call is used to test the creation of workflows related to PWG (Physics Working Groups) in the ALICE O2 simulation environment. Its primary purpose is to validate that the necessary workflows can be successfully generated based on the `changed_workflows` input.

If errors occur during the workflow creation process, the script captures the return value of `run_workflow_creation`. If the return value is not 0, indicating a failure, a warning message is printed: "WARNING for workflows creations, some could not be built." Additionally, the script executes `print_error_logs ./` to display any error logs associated with the failed workflow creations.

Overall, the script ensures that any issues in workflow creation are promptly identified and reported, allowing for necessary adjustments to be made.