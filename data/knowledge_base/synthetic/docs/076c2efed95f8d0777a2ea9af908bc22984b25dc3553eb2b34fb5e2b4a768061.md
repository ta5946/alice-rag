## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/DATA/production/setenv_calib.sh

**Start chunk id:** 076c2efed95f8d0777a2ea9af908bc22984b25dc3553eb2b34fb5e2b4a768061

## Content

# Calibrations regardless of whether the run is COSMIC or non-COSMIC:

# if feasible, execute RCT updater
if [[ $CAN_DO_CALIB_RCT_UPDATER == 1 ]]; then
  if [[ -z ${CALIB_RCT_UPDATER+x} ]]; then CALIB_RCT_UPDATER=1; fi
fi

# IDCs (by default, they are activated for synchronization reconstruction on EPNs, but not on staging due to the limited number of calibration nodes)
if [[ $CAN_DO_CALIB_TPC_IDC == 1 ]]; then
  if [[ -z ${CALIB_TPC_IDC+x} ]]; then
    if [[ $EPNSYNCMODE == 1 ]] && [[ "${GEN_TOPO_DEPLOYMENT_TYPE:-}" != "ALICE_STAGING" ]]; then
      CALIB_TPC_IDC=1;
    else
      CALIB_TPC_IDC=0;
    fi
  fi
fi
# SAC (by default, it is activated for synchronization reconstruction on EPNs)
if [[ $CAN_DO_CALIB_TPC_SAC == 1 ]]; then
  if [[ -z ${CALIB_TPC_SAC+x} ]]; then
    if [[ $EPNSYNCMODE == 1 ]]; then
      CALIB_TPC_SAC=1;
    else
      CALIB_TPC_SAC=0;
    fi
  fi
fi

---

if the workflow includes the CALIB_LOCAL_AGGREGATOR parameter; then
    CONNECTION+=",transport=zeromq,address=ipc://${UDS_PREFIX}aggregator-shm-$1"
else
    CONNECTION+=",transport=zeromq"
fi
  local PROXY_CONN="$NAMEPROXY $NAMEPROXYCHANNEL --channel-config \"name=aggregator-proxy-$1,$CONNECTION,rateLogging=10\""
  when EPNSYNCMODE is set to 1, append --network-interface ib0 to PROXY_CONN
  if the second argument is "input" and TIMEFRAME_SHM_LIMIT is defined, add --timeframes-shm-limit $TIMEFRAME_SHM_LIMIT to PROXY_CONN
  if the second argument is "output", then based on the third argument:
    if it is "timeframe", add --environment DPL_OUTPUT_PROXY_ORDERED=1 to PROXY_CONN
    if it is "sporadic", add --environment "DPL_OUTPUT_PROXY_WHENANY=1 DPL_DONT_DROP_OLD_TIMESLICE=1" --sporadic-inputs to PROXY_CONN
  else, if the third argument is neither "sporadic" nor "timeframe", print "invalid option $3, must be (sporadic|timeframe)" to stderr and exit with status 1
  if the second argument is "input" and the third argument is "sporadic", append --sporadic-outputs to PROXY_CONN

---

if [[ "0${GEN_TOPO_VERBOSE:-}" == "01" ]]; then
  echo "CALIB_RCT_UPDATER = ${CALIB_RCT_UPDATER:-}" 1>&2
  echo "CALIB_PRIMVTX_MEANVTX = $CALIB_PRIMVTX_MEANVTX" 1>&2
  echo "CALIB_TOF_LHCPHASE = $CALIB_TOF_LHCPHASE" 1>&2
  echo "CALIB_TOF_CHANNELOFFSETS = $CALIB_TOF_CHANNELOFFSETS" 1>&2
  echo "CALIB_TOF_DIAGNOSTICS = $CALIB_TOF_DIAGNOSTICS" 1>&2
  echo "CALIB_TOF_INTEGRATEDCURR = $CALIB_TOF_INTEGRATEDCURR" 1>&2
  echo "CALIB_EMC_BADCHANNELCALIB = $CALIB_EMC_BADCHANNELCALIB" 1>&2
  echo "CALIB_EMC_TIMECALIB = $CALIB_EMC_TIMECALIB" 1>&2
  echo "CALIB_PHS_ENERGYCALIB = $CALIB_PHS_ENERGYCALIB" 1>&2
  echo "CALIB_PHS_BADMAPCALIB = $CALIB_PHS_BADMAPCALIB" 1>&2
  echo "CALIB_PHS_TURNONCALIB = $CALIB_PHS_TURNONCALIB" 1>&2
  echo "CALIB_PHS_RUNBYRUNCALIB = $CALIB_PHS_RUNBYRUNCALIB" 1>&2
  echo "CALIB_PHS_L1PHASE = $CALIB_PHS_L1PHASE" 1>&2
  echo "CALIB_TRD_VDRIFTEXB = $CALIB_TRD_VDRIFTEXB" 1>&2
  echo "CALIB_TRD_GAIN = $CALIB_TRD_GAIN" 1>&2
  echo "CALIB_TRD_T0 = $CALIB_TRD_T0" 1>&2

---

( [[ -z ${CALIB_CPV_GAIN:-} ]] || [[ $CAN_DO_CALIB_CPV_GAIN == 0 ]] ) && CALIB_CPV_GAIN=0
( [[ -z ${CALIB_ZDC_TDC:-} ]] || [[ $CAN_DO_CALIB_ZDC_TDC == 0 ]] ) && CALIB_ZDC_TDC=0
( [[ -z ${CALIB_ITS_DEADMAP_TIME:-} ]] || [[ $CAN_DO_CALIB_ITS_DEADMAP_TIME == 0 ]] ) && CALIB_ITS_DEADMAP_TIME=0
( [[ -z ${CALIB_MFT_DEADMAP_TIME:-} ]] || [[ $CAN_DO_CALIB_MFT_DEADMAP_TIME == 0 ]] ) && CALIB_MFT_DEADMAP_TIME=0
( [[ -z ${CALIB_RCT_UPDATER:-} ]] || [[ $CAN_DO_CALIB_RCT_UPDATER == 0 ]] ) && CALIB_RCT_UPDATER=0
# for asynchronous operations:
( [[ -z ${CALIB_EMC_ASYNC_RECALIB:-} ]] || [[ $CAN_DO_CALIB_EMC_ASYNC_RECALIB == 0 ]] ) && CALIB_EMC_ASYNC_RECALIB=0
( [[ -z ${CALIB_ASYNC_EXTRACTTPCCURRENTS:-} ]] || [[ $CAN_DO_CALIB_ASYNC_EXTRACTTPCCURRENTS == 0 ]] ) && CALIB_ASYNC_EXTRACTTPCCURRENTS=0
( [[ -z ${CALIB_ASYNC_DISABLE3DCURRENTS:-} ]] || [[ $CAN_DO_CALIB_ASYNC_DISABLE3DCURRENTS == 0 ]] ) && CALIB_ASYNC_DISABLE3DCURRENTS=0
: ${ON_SKIMMED_DATA:=0}

---

DOCUMENT:
  if [[ $CAN_DO_CALIB_CPV_GAIN == 1 ]]; then
    if [[ -z ${CALIB_CPV_GAIN+x} ]]; then CALIB_CPV_GAIN=1; fi
  fi

  if [[ $CAN_DO_CALIB_ZDC_TDC == 1 ]]; then
    if [[ -z ${CALIB_ZDC_TDC+x} ]]; then CALIB_ZDC_TDC=1; fi
  fi

  if [[ $CAN_DO_CALIB_FT0_TIMEOFFSET == 1 ]]; then
    if [[ -z ${CALIB_FT0_TIMEOFFSET+x} ]]; then CALIB_FT0_TIMEOFFSET=1; fi
  fi
  if [[ $CAN_DO_CALIB_FT0_INTEGRATEDCURR == 1 ]]; then
    if [[ -z ${CALIB_FT0_INTEGRATEDCURR+x} ]]; then CALIB_FT0_INTEGRATEDCURR=1; fi
  fi
  if [[ $CAN_DO_CALIB_FV0_INTEGRATEDCURR == 1 ]]; then
    if [[ -z ${CALIB_FV0_INTEGRATEDCURR+x} ]]; then CALIB_FV0_INTEGRATEDCURR=1; fi
  fi
  if [[ $CAN_DO_CALIB_FDD_INTEGRATEDCURR == 1 ]]; then
    if [[ -z ${CALIB_FDD_INTEGRATEDCURR+x} ]]; then CALIB_FDD_INTEGRATEDCURR=1; fi
  fi
fi

# Calibrations that apply regardless of whether it is a cosmic or non-cosmic run:

---

( [[ -z ${CALIB_TRD_T0:-} ]] || [[ $CAN_DO_CALIB_TRD_T0 == 0 ]] ) && CALIB_TRD_T0=0
( [[ -z ${CALIB_EMC_BADCHANNELCALIB:-} ]] || [[ $CAN_DO_CALIB_EMC_BADCHANNELCALIB == 0 ]] ) && CALIB_EMC_BADCHANNELCALIB=0
( [[ -z ${CALIB_EMC_TIMECALIB:-} ]] || [[ $CAN_DO_CALIB_EMC_TIMECALIB == 0 ]] ) && CALIB_EMC_TIMECALIB=0
( [[ -z ${CALIB_PHS_ENERGYCALIB:-} ]] || [[ $CAN_DO_CALIB_PHS_ENERGYCALIB == 0 ]] ) && CALIB_PHS_ENERGYCALIB=0
( [[ -z ${CALIB_PHS_BADMAPCALIB:-} ]] || [[ $CAN_DO_CALIB_PHS_BADMAPCALIB == 0 ]] ) && CALIB_PHS_BADMAPCALIB=0
( [[ -z ${CALIB_PHS_TURNONCALIB:-} ]] || [[ $CAN_DO_CALIB_PHS_TURNONCALIB == 0 ]] ) && CALIB_PHS_TURNONCALIB=0
( [[ -z ${CALIB_PHS_RUNBYRUNCALIB:-} ]] || [[ $CAN_DO_CALIB_PHS_RUNBYRUNCALIB == 0 ]] ) && CALIB_PHS_RUNBYRUNCALIB=0
( [[ -z ${CALIB_PHS_L1PHASE:-} ]] || [[ $CAN_DO_CALIB_PHS_L1PHASE == 0 ]] ) && CALIB_PHS_L1PHASE=0
( [[ -z ${CALIB_CPV_GAIN:-} ]] || [[ $CAN_DO_CALIB_CPV_GAIN == 0 ]] ) && CALIB_CPV_GAIN=0

---

DOCUMENT:
  if [[ $CAN_DO_CALIB_EMC_BADCHANNELCALIB == 1 ]]; then
    if [[ -z ${CALIB_EMC_BADCHANNELCALIB+x} ]]; then
      CALIB_EMC_BADCHANNELCALIB=1
    fi
  fi
  if [[ $CAN_DO_CALIB_EMC_TIMECALIB == 1 ]]; then
    if [[ -z ${CALIB_EMC_TIMECALIB+x} ]]; then
      CALIB_EMC_TIMECALIB=1
    fi
  fi

  # calibrations for PHS
  if [[ $CAN_DO_CALIB_PHS_ENERGYCALIB == 1 ]]; then
    if [[ -z ${CALIB_PHS_ENERGYCALIB+x} ]]; then
      CALIB_PHS_ENERGYCALIB=1
    fi
  fi
  if [[ $CAN_DO_CALIB_PHS_BADMAPCALIB == 1 ]]; then
    if [[ -z ${CALIB_PHS_BADMAPCALIB+x} ]]; then
      CALIB_PHS_BADMAPCALIB=1
    fi
  fi
  if [[ $CAN_DO_CALIB_PHS_TURNONCALIB == 1 ]]; then
    if [[ -z ${CALIB_PHS_TURNONCALIB+x} ]]; then
      CALIB_PHS_TURNONCALIB=1
    fi
  fi
  if [[ $CAN_DO_CALIB_PHS_RUNBYRUNCALIB == 1 ]]; then
    if [[ -z ${CALIB_PHS_RUNBYRUNCALIB+x} ]]; then
      CALIB_PHS_RUNBYRUNCALIB=1
    fi
  fi
  if [[ $CAN_DO_CALIB_PHS_L1PHASE == 1 ]]; then
    if [[ -z ${CALIB_PHS_L1PHASE+x} ]]; then
      CALIB_PHS_L1PHASE=1
    fi
  fi

---

: ${ON_SKIMMED_DATA:=0}
( [[ -z ${CALIB_ASYNC_EXTRACTTIMESERIES:-} ]] || [[ $CAN_DO_CALIB_ASYNC_EXTRACTTIMESERIES == 0 ]] ) && CALIB_ASYNC_EXTRACTTIMESERIES=0

---

if [[ $2 == "input" && $3 == "sporadic" ]]; then
  PROXY_CONN+=" --sporadic-outputs"
fi
if [[ "0${GEN_TOPO_VERBOSE:-}" == "01" ]]; then
  echo PROXY_CONN = $PROXY_CONN 1>&2
fi
echo $PROXY_CONN
}
fi # setenv_calib.sh sourced

---

# additional individual settings for calibration workflows
if the detector is CTP; then set CALIB_TPC_SCDCALIB_CTP_INPUT="--enable-ctp"; else set CALIB_TPC_SCDCALIB_CTP_INPUT=""; fi
if [[ ${DISABLE_TRD_PH:-} == 1 ]]; then set CAN_DO_CALIB_TRD_T0=0; fi

: ${CALIB_TPC_SCDCALIB_SLOTLENGTH:=600} # the slot length must be known both on the aggregator and the processing nodes, so it is defined here (in seconds!)
: ${CALIB_TPC_SCDCALIB_SENDTRKDATA:=1}  # by default, we include track information along with unbinned residuals to facilitate more detailed offline filtering

if [[ $BEAMTYPE != "cosmic" ]] || [[ ${FORCECALIBRATIONS:-} == 1 ]] ; then # calibrations are enabled in non-COSMIC runs

  # we will not handle calibrations specifically for async! e.g. EMC_ASYNC_RECALIB; they should always be explicitly enabled

---

#!/bin/bash

# ---------------------------------------------------------------------------------------------------------------------

# Verify that the prerequisites for enabling the calibrations are satisfied, and
# activate them by default if they haven't been enabled or
# if they are not explicitly disabled.
# Subsequently, configure the data specification based on the enabled calibrations.

# Utilized to prevent sourcing this file more than once
if [[ -z ${SOURCE_GUARD_SETENV_CALIB:-} ]]; then
SOURCE_GUARD_SETENV_CALIB=1

---

DOCUMENT:
  if [[ $CAN_DO_CALIB_PRIMVTX_MEANVTX == 1 ]]; then
    if [[ -z ${CALIB_PRIMVTX_MEANVTX+x} ]]; then CALIB_PRIMVTX_MEANVTX=1; fi
  fi
  
  if [[ $CAN_DO_CALIB_ITS_DEADMAP_TIME == 1 ]]; then
    if [[ -z ${CALIB_ITS_DEADMAP_TIME+x} ]]; then CALIB_ITS_DEADMAP_TIME=1; fi
  fi
  
  if [[ $CAN_DO_CALIB_MFT_DEADMAP_TIME == 1 ]]; then
    if [[ -z ${CALIB_MFT_DEADMAP_TIME+x} ]]; then CALIB_MFT_DEADMAP_TIME=1; fi
  fi
  
  if [[ $CAN_DO_CALIB_TOF_DIAGNOSTICS == 1 ]]; then
    if [[ -z ${CALIB_TOF_DIAGNOSTICS+x} ]]; then CALIB_TOF_DIAGNOSTICS=1; fi
  fi
  if [[ $CAN_DO_CALIB_TOF_LHCPHASE == 1 ]]; then
    if [[ -z ${CALIB_TOF_LHCPHASE+x} ]]; then CALIB_TOF_LHCPHASE=1; fi
  fi
  if [[ $CAN_DO_CALIB_TOF_CHANNELOFFSETS == 1 ]]; then
    if [[ -z ${CALIB_TOF_CHANNELOFFSETS+x} ]]; then CALIB_TOF_CHANNELOFFSETS=1; fi
  fi
  if [[ $CAN_DO_CALIB_TOF_INTEGRATEDCURR == 1 ]]; then

---

# configuring the connection type
  if [[ $2 == "input" ]]; then
    local CONNECTION="method=bind"
    local NAMEPROXY="--proxy-name aggregator-proxy-$1"
    local NAMEPROXYCHANNEL=
    if workflow_has_parameter CALIB_LOCAL_AGGREGATOR; then
      CONNECTION+=",type=pull"
    else
      CONNECTION+=",type=sub"
    fi
  elif [[ $2 == "output" ]]; then
    local CONNECTION="method=connect"
    local NAMEPROXY="--proxy-name calib-output-proxy-$1"
    local NAMEPROXYCHANNEL="--proxy-channel-name aggregator-proxy-$1"
    if workflow_has_parameter CALIB_LOCAL_AGGREGATOR; then
      CONNECTION+=",type=push"
    else
      CONNECTION+=",type=pub"
    fi
  else
    echo "parameter 2 must be either 'input' or 'output'"
    exit 2
  fi

---

# TRD
  if [[ $CALIB_TRD_VDRIFTEXB == 1 ]]; then add_semicolon_separated CALIBDATASPEC_BARREL_TF "angResHistoTRD:TRD/ANGRESHISTS/0"; fi
  if [[ $CALIB_TRD_GAIN == 1 ]]; then add_semicolon_separated CALIBDATASPEC_BARREL_TF "gainHistoTRD:TRD/GAINCALIBHISTS/0"; fi
  if [[ $CALIB_TRD_T0 == 1 ]]; then add_semicolon_separated CALIBDATASPEC_BARREL_TF "trdph:TRD/PULSEHEIGHT/0"; fi
fi

---

# Proxy Properties
get_proxy_connection()
{
  if (( $# < 3 )); then
    echo "Number of parameters received: $#"
    echo "Function ${FUNCNAME} requires a minimum of 3 parameters:"
    echo "The first parameter should be the string ID of the proxy"
    echo "The second parameter should specify the type of connection (input/output)"
    echo "The third parameter should indicate whether the connection is sporadic or within a timeframe"
    exit 1
  fi
}

---

( [[ -z ${CALIB_FT0_INTEGRATEDCURR:-} ]] || [[ $CAN_DO_CALIB_FT0_INTEGRATEDCURR == 0 ]] ) && CALIB_FT0_INTEGRATEDCURR=0
( [[ -z ${CALIB_FV0_INTEGRATEDCURR:-} ]] || [[ $CAN_DO_CALIB_FV0_INTEGRATEDCURR == 0 ]] ) && CALIB_FV0_INTEGRATEDCURR=0
( [[ -z ${CALIB_FDD_INTEGRATEDCURR:-} ]] || [[ $CAN_DO_CALIB_FDD_INTEGRATEDCURR == 0 ]] ) && CALIB_FDD_INTEGRATEDCURR=0
( [[ -z ${CALIB_FT0_TIMEOFFSET:-} ]] || [[ $CAN_DO_CALIB_FT0_TIMEOFFSET == 0 ]] ) && CALIB_FT0_TIMEOFFSET=0
( [[ -z ${CALIB_PRIMVTX_MEANVTX:-} ]] || [[ $CAN_DO_CALIB_PRIMVTX_MEANVTX == 0 ]] ) && CALIB_PRIMVTX_MEANVTX=0
( [[ -z ${CALIB_TOF_LHCPHASE:-} ]] || [[ $CAN_DO_CALIB_TOF_LHCPHASE == 0 ]] ) && CALIB_TOF_LHCPHASE=0
( [[ -z ${CALIB_TOF_CHANNELOFFSETS:-} ]] || [[ $CAN_DO_CALIB_TOF_CHANNELOFFSETS == 0 ]] ) && CALIB_TOF_CHANNELOFFSETS=0
( [[ -z ${CALIB_TOF_DIAGNOSTICS:-} ]] || [[ $CAN_DO_CALIB_TOF_DIAGNOSTICS == 0 ]] ) && CALIB_TOF_DIAGNOSTICS=0

---

if the TPC detector calibration is available and ITS TPC detectors are present with matching ITSTPC; then CAN_DO_CALIB_TPC_SCDCALIB=1; otherwise CAN_DO_CALIB_TPC_SCDCALIB=0; fi
if TPC detector calibration is available and the TPC processing step TPC_DEDX is present; then CAN_DO_CALIB_TPC_TIMEGAIN=1 and CAN_DO_CALIB_TPC_RESPADGAIN=1; otherwise CAN_DO_CALIB_TPC_TIMEGAIN=0 and CAN_DO_CALIB_TPC_RESPADGAIN=0; fi
if TPC detector calibration is available and ITS TPC detectors are present with matching ITSTPC; then CAN_DO_CALIB_TPC_VDRIFTTGL=1; otherwise CAN_DO_CALIB_TPC_VDRIFTTGL=0; fi
if TPC detector calibration is available; then CAN_DO_CALIB_TPC_IDC=1 and CAN_DO_CALIB_TPC_SAC=1; otherwise CAN_DO_CALIB_TPC_IDC=0 and CAN_DO_CALIB_TPC_SAC=0; fi
if FLP_IDS is not empty and does not include "145", or if GEN_TOPO_DEPLOYMENT_TYPE is "ALICE_STAGING"; then CAN_DO_CALIB_TPC_SAC=0; fi

---

if [[ "0${GEN_TOPO_VERBOSE:-}" == "01" ]]; then
  # debug printing
  echo CALIBDATASPEC_BARREL_TF = ${CALIBDATASPEC_BARREL_TF:-} 1>&2
  echo CALIBDATASPEC_BARREL_SPORADIC = ${CALIBDATASPEC_BARREL_SPORADIC:-} 1>&2
  echo CALIBDATASPEC_TPCIDC_A = ${CALIBDATASPEC_TPCIDC_A:-} 1>&2
  echo CALIBDATASPEC_TPCIDC_C = ${CALIBDATASPEC_TPCIDC_C:-} 1>&2
  echo CALIBDATASPEC_CALO_TF = ${CALIBDATASPEC_CALO_TF:-} 1>&2
  echo CALIBDATASPEC_CALO_SPORADIC = ${CALIBDATASPEC_CALO_SPORADIC:-} 1>&2
  echo CALIBDATASPEC_MUON_TF = ${CALIBDATASPEC_MUON_TF:-} 1>&2
  echo CALIBDATASPEC_MUON_SPORADIC = ${CALIBDATASPEC_MUON_SPORADIC:-} 1>&2
  echo CALIBDATASPEC_FORWARD_TF = ${CALIBDATASPEC_FORWARD_TF:-} 1>&2
  echo CALIBDATASPEC_FORWARD_SPORADIC = ${CALIBDATASPEC_FORWARD_SPORADIC:-} 1>&2
fi

---

# specify proxy for TPC IDCs - Side C
if [[ -z ${CALIBDATASPEC_TPCIDC_C:-} ]]; then
  # TPC
  if [[ $CALIB_TPC_IDC == 1 ]]; then add_semicolon_separated CALIBDATASPEC_TPCIDC_C "idcsgroupc:TPC/IDCGROUPC"; fi
fi

# specify proxy for TPC SAC
if [[ -z ${CALIBDATASPEC_TPCSAC:-} ]]; then
  # TPC
  if [[ $CALIB_TPC_SAC == 1 ]]; then
    add_semicolon_separated CALIBDATASPEC_TPCSAC "sacdec:TPC/DECODEDSAC/0"
    add_semicolon_separated CALIBDATASPEC_TPCSAC "sacreftime:TPC/REFTIMESAC/0"
  fi
fi

# specify proxy for TF-based outputs from CALO
if [[ -z ${CALIBDATASPEC_CALO_TF:-} ]]; then
  # EMC
  if [[ $CALIB_EMC_BADCHANNELCALIB == 1 ]] || [[ $CALIB_EMC_TIMECALIB == 1 ]]; then
    add_semicolon_separated CALIBDATASPEC_CALO_TF "cellsEMC:EMC/CELLS/0"
    add_semicolon_separated CALIBDATASPEC_CALO_TF "cellsTrgREMC:EMC/CELLSTRGR/0"
    if has_detector CTP; then
      add_semicolon_separated CALIBDATASPEC_CALO_TF "ctpdigi:CTP/DIGITS/0"
    fi
  fi
fi

---

if [[ $CAN_DO_CALIB_TOF_INTEGRATEDCURR == 1 ]]; then
  if [[ -z ${CALIB_TOF_INTEGRATEDCURR+x} ]]; then
    CALIB_TOF_INTEGRATEDCURR=1
  fi
fi

---

# calibrations for TPC
  if [[ $CAN_DO_CALIB_TPC_SCDCALIB == 1 ]] ; then
    if [[ -z ${CALIB_TPC_SCDCALIB+x} ]]; then CALIB_TPC_SCDCALIB=1; fi
  fi
  if [[ $CAN_DO_CALIB_TPC_TIMEGAIN == 1 ]]; then
    if [[ -z ${CALIB_TPC_TIMEGAIN+x} ]]; then CALIB_TPC_TIMEGAIN=1; fi
  fi
  if [[ $CAN_DO_CALIB_TPC_RESPADGAIN == 1 ]]; then
    if [[ -z ${CALIB_TPC_RESPADGAIN+x} ]]; then CALIB_TPC_RESPADGAIN=1; fi
  fi
  if [[ $CAN_DO_CALIB_TPC_VDRIFTTGL == 1 ]]; then
    if [[ -z ${CALIB_TPC_VDRIFTTGL+x} ]]; then CALIB_TPC_VDRIFTTGL=1; fi
  fi

  # calibrations for TRD
  if [[ $CAN_DO_CALIB_TRD_VDRIFTEXB == 1 ]] ; then
    if [[ -z ${CALIB_TRD_VDRIFTEXB+x} ]]; then CALIB_TRD_VDRIFTEXB=1; fi
  fi
  if [[ $CAN_DO_CALIB_TRD_GAIN == 1 ]] ; then
    if [[ -z ${CALIB_TRD_GAIN+x} ]]; then CALIB_TRD_GAIN=1; fi
  fi
  if [[ $CAN_DO_CALIB_TRD_T0 == 1 ]] ; then
    if [[ -z ${CALIB_TRD_T0+x} ]]; then CALIB_TRD_T0=1; fi
  fi

---

# define specification for proxy of TF-based outputs from forward detectors
if [[ -z ${CALIBDATASPEC_FORWARD_TF:-} ]]; then
  # FT0
  if [[ $CALIB_FT0_TIMEOFFSET == 1 ]]; then
    add_semicolon_separated CALIBDATASPEC_FORWARD_TF "timeSpectraFT0:FT0/TIME_SPECTRA/0"
  fi
fi

---

DOCUMENT:
    echo "CALIB_TRD_GAIN = $CALIB_TRD_GAIN" 1>&2
  echo "CALIB_TRD_T0 = $CALIB_TRD_T0" 1>&2
  echo "CALIB_TPC_TIMEGAIN = $CALIB_TPC_TIMEGAIN" 1>&2
  echo "CALIB_TPC_RESPADGAIN = $CALIB_TPC_RESPADGAIN" 1>&2
  echo "CALIB_TPC_IDC = $CALIB_TPC_IDC" 1>&2
  echo "CALIB_TPC_SAC = $CALIB_TPC_SAC" 1>&2
  echo "CALIB_CPV_GAIN = $CALIB_CPV_GAIN" 1>&2
  echo "CALIB_ZDC_TDC = $CALIB_ZDC_TDC" 1>&2
  echo "CALIB_FT0_TIMEOFFSET = $CALIB_FT0_TIMEOFFSET" 1>&2
  echo "CALIB_FT0_INTEGRATEDCURR = $CALIB_FT0_INTEGRATEDCURR" 1>&2
  echo "CALIB_FV0_INTEGRATEDCURR = $CALIB_FV0_INTEGRATEDCURR" 1>&2
  echo "CALIB_FDD_INTEGRATEDCURR = $CALIB_FDD_INTEGRATEDCURR" 1>&2
  echo "Calibrations for asynchronous settings:" 1>&2
  echo "CALIB_EMC_ASYNC_RECALIB = $CALIB_EMC_ASYNC_RECALIB" 1>&2
fi

---

# define specification for proxy of BARREL's sporadic outputs
if [[ -z ${CALIBDATASPEC_BARREL_SPORADIC:-} ]]; then
  # TPC
  if [[ $CALIB_TPC_RESPADGAIN == 1 ]]; then add_semicolon_separated CALIBDATASPEC_BARREL_SPORADIC "trackGainHistoTPC:TPC/TRACKGAINHISTOS/0"; fi
  if [[ $CALIB_TPC_TIMEGAIN == 1 ]]; then add_semicolon_separated CALIBDATASPEC_BARREL_SPORADIC "tpcmips:TPC/MIPS/0"; fi
  # TOF
  if [[ $CALIB_TOF_INTEGRATEDCURR == 1 ]]; then
    add_semicolon_separated CALIBDATASPEC_BARREL_SPORADIC "integrCurrNTOF:TOF/ITOFCN/0"
    add_semicolon_separated CALIBDATASPEC_BARREL_SPORADIC "integrCurrQTOF:TOF/ITOFCQ/0"
  fi
fi

# define specification for proxy of TPC IDCs - Side A
if [[ -z ${CALIBDATASPEC_TPCIDC_A:-} ]]; then
  # TPC
  if [[ $CALIB_TPC_IDC == 1 ]]; then add_semicolon_separated CALIBDATASPEC_TPCIDC_A "idcsgroupa:TPC/IDCGROUPA"; fi
fi

---

# TPC
if [[ $CALIB_TPC_SCDCALIB == 1 ]]; then
  add_semicolon_separated CALIBDATASPEC_BARREL_TF "unbinnedTPCResiduals:GLO/UNBINNEDRES/0"
  add_semicolon_separated CALIBDATASPEC_BARREL_TF "trackReferences:GLO/TRKREFS/0"
fi
if [[ $CALIB_TPC_SCDCALIB == 1 ]] && [[ ${CALIB_TPC_SCDCALIB_SENDTRKDATA:-} == "1" ]]; then
  add_semicolon_separated CALIBDATASPEC_BARREL_TF "tpcInterpTrkData:GLO/TRKDATA/0"
fi
if [[ $CALIB_TPC_SCDCALIB == 1 ]] && [[ ${CALIB_TPC_SCDCALIB_CTP_INPUT:-} == "--enable-ctp" ]]; then
  add_semicolon_separated CALIBDATASPEC_BARREL_TF "lumi:CTP/LUMI/0"
  add_semicolon_separated CALIBDATASPEC_BARREL_TF "ctpdigi:CTP/DIGITS/0"
fi
if [[ $CALIB_TPC_VDRIFTTGL == 1 ]]; then
  add_semicolon_separated CALIBDATASPEC_BARREL_TF "tpcvdtgl:GLO/TPCITS_VDTGL/0"
fi

---

# define specification for proxy of sporadic forward detector outputs
if [[ -z ${CALIBDATASPEC_FORWARD_SPORADIC:-} ]]; then
  # FIT
  if [[ $CALIB_FT0_INTEGRATEDCURR -eq 1 ]]; then
    add_semicolon_separated CALIBDATASPEC_FORWARD_SPORADIC "integrCurrFT0:FT0/IFT0C/0"
  fi
  if [[ $CALIB_FV0_INTEGRATEDCURR -eq 1 ]]; then
    add_semicolon_separated CALIBDATASPEC_FORWARD_SPORADIC "integrCurrFV0:FV0/IFV0C/0"
  fi
  if [[ $CALIB_FDD_INTEGRATEDCURR -eq 1 ]]; then
    add_semicolon_separated CALIBDATASPEC_FORWARD_SPORADIC "integrCurrFDD:FDD/IFDDC/0"
  fi
  # ZDC
  if [[ $CALIB_ZDC_TDC -eq 1 ]]; then
    add_semicolon_separated CALIBDATASPEC_FORWARD_SPORADIC "tdcZDC:ZDC/TDCCALIBDATA/0"
    add_semicolon_separated CALIBDATASPEC_FORWARD_SPORADIC "histoZDC:ZDC/TDC_1DH"
  fi
fi

---

# define specifications for the proxy used for TF-based outputs from BARREL
if [[ -z ${CALIBDATASPEC_BARREL_TF:-} ]]; then
  # RCT updater
  if [[ $CALIB_RCT_UPDATER == 1 ]]; then add_semicolon_separated CALIBDATASPEC_BARREL_TF "calibRCT:CTF/DONE/0"; fi
  # primary vertex
  if [[ $CALIB_PRIMVTX_MEANVTX == 1 ]]; then add_semicolon_separated CALIBDATASPEC_BARREL_TF "pvtx:GLO/PVTX/0"; fi

  # ITS
  if [[ $CALIB_ITS_DEADMAP_TIME == 1 ]]; then add_semicolon_separated CALIBDATASPEC_BARREL_TF "itsChipStatus:ITS/CHIPSSTATUS/0"; fi

  # MFT
  if [[ $CALIB_MFT_DEADMAP_TIME == 1 ]]; then add_semicolon_separated CALIBDATASPEC_BARREL_TF "mftChipStatus:MFT/CHIPSSTATUS/0"; fi

  # TOF
  if [[ $CALIB_TOF_LHCPHASE == 1 ]] || [[ $CALIB_TOF_CHANNELOFFSETS == 1 ]]; then add_semicolon_separated CALIBDATASPEC_BARREL_TF "calibTOF:TOF/CALIBDATA/0"; fi
  if [[ $CALIB_TOF_DIAGNOSTICS == 1 ]]; then add_semicolon_separated CALIBDATASPEC_BARREL_TF "diagWords:TOF/DIAFREQ/0"; fi

---

if the FT0 detector has been calibrated and the FT0 reconstruction step is available; then CAN_DO_CALIB_FT0_TIMEOFFSET=1; CAN_DO_CALIB_FT0_INTEGRATEDCURR=1; else set CAN_DO_CALIB_FT0_TIMEOFFSET=0; CAN_DO_CALIB_FT0_INTEGRATEDCURR=0; fi
if the FV0 detector has been calibrated and the FV0 reconstruction step is performed; then CAN_DO_CALIB_FV0_INTEGRATEDCURR=1; else set CAN_DO_CALIB_FV0_INTEGRATEDCURR=0; fi
if the FDD detector has been calibrated and the FDD reconstruction step is performed; then CAN_DO_CALIB_FDD_INTEGRATEDCURR=1; else set CAN_DO_CALIB_FDD_INTEGRATEDCURR=0; fi
if the ZDC detector has been calibrated and the ZDC reconstruction step is performed; then CAN_DO_CALIB_ZDC_TDC=1; else set CAN_DO_CALIB_ZDC_TDC=0; fi
if the SYNCMODE is set to 1 and the ENTROPY_ENCODER processing step is active, and the WORKFLOW_DETECTORS_CTF is defined and not "NONE"; then set CAN_DO_CALIB_RCT_UPDATER=1; else set CAN_DO_CALIB_RCT_UPDATER=0; fi
# for asynchronous recalibration
if the EMC detector has been calibrated, the EMC reconstruction step is available, and the SYNCMODE is not set to 1; then set CAN_DO_CALIB_EMC_ASYNC_RECALIB=1; else set CAN_DO_CALIB_EMC_ASYNC_RECALIB=0; fi

---

DOCUMENT:
  if [[ $CALIB_PHS_ENERGYCALIB == 1 ]] || [[ $CALIB_PHS_TURNONCALIB == 1 ]] || [[ $CALIB_PHS_RUNBYRUNCALIB == 1 ]] || [[ $CALIB_PHS_L1PHASE == 1 ]]; then
    add_semicolon_separated CALIBDATASPEC_CALO_TF "clsPHS:PHS/CLUSTERS/0"
    add_semicolon_separated CALIBDATASPEC_CALO_TF "clTRPHS:PHS/CLUSTERTRIGREC/0"
  fi
  if [[ $CALIB_PHS_ENERGYCALIB == 1 ]]; then add_semicolon_separated CALIBDATASPEC_CALO_TF "cluelementsPHS:PHS/CLUELEMENTS/0"; fi
  if [[ $CALIB_PHS_BADMAPCALIB == 1 ]] || [[ $CALIB_PHS_TURNONCALIB == 1 ]]; then add_semicolon_separated CALIBDATASPEC_CALO_TF "cellsPHS:PHS/CELLS/0"; fi
  if [[ $CALIB_PHS_TURNONCALIB == 1 ]]; then add_semicolon_separated CALIBDATASPEC_CALO_TF "cellsTRPHS:PHS/CELLTRIGREC/0"; fi

  # CPV
  if [[ $CALIB_CPV_GAIN == 1 ]]; then
    add_semicolon_separated CALIBDATASPEC_CALO_TF "calibdCPV:CPV/CALIBDIGITS/0"
  fi
fi

---

if [[ $SYNCMODE != 1 ]] && has_detector_reco TPC; then CAN_DO_CALIB_ASYNC_EXTRACTTPCCURRENTS=1; else CAN_DO_CALIB_ASYNC_EXTRACTTPCCURRENTS=0; fi
if [[ $SYNCMODE != 1 ]] && has_detector_reco TPC && has_detector_reco ITS && has_detector_reco FT0; then CAN_DO_CALIB_ASYNC_EXTRACTTIMESERIES=1; else CAN_DO_CALIB_ASYNC_EXTRACTTIMESERIES=0; fi

---

( [[ -z ${CALIB_TOF_INTEGRATEDCURR:-} ]] || [[ $CAN_DO_CALIB_TOF_INTEGRATEDCURR == 0 ]] ) && CALIB_TOF_INTEGRATEDCURR=0
( [[ -z ${CALIB_TPC_SCDCALIB:-} ]] || [[ $CAN_DO_CALIB_TPC_SCDCALIB == 0 ]] ) && CALIB_TPC_SCDCALIB=0
( [[ -z ${CALIB_TPC_TIMEGAIN:-} ]] || [[ $CAN_DO_CALIB_TPC_TIMEGAIN == 0 ]] ) && CALIB_TPC_TIMEGAIN=0
( [[ -z ${CALIB_TPC_RESPADGAIN:-} ]] || [[ $CAN_DO_CALIB_TPC_RESPADGAIN == 0 ]] ) && CALIB_TPC_RESPADGAIN=0
( [[ -z ${CALIB_TPC_IDC:-} ]] || [[ $CAN_DO_CALIB_TPC_IDC == 0 ]] ) && CALIB_TPC_IDC=0
( [[ -z ${CALIB_TPC_SAC:-} ]] || [[ $CAN_DO_CALIB_TPC_SAC == 0 ]] ) && CALIB_TPC_SAC=0
( [[ -z ${CALIB_TPC_VDRIFTTGL:-} ]] || [[ $CAN_DO_CALIB_TPC_VDRIFTTGL == 0 ]] ) && CALIB_TPC_VDRIFTTGL=0
( [[ -z ${CALIB_TRD_VDRIFTEXB:-} ]] || [[ $CAN_DO_CALIB_TRD_VDRIFTEXB == 0 ]] ) && CALIB_TRD_VDRIFTEXB=0
( [[ -z ${CALIB_TRD_GAIN:-} ]] || [[ $CAN_DO_CALIB_TRD_GAIN == 0 ]] ) && CALIB_TRD_GAIN=0
( [[ -z ${CALIB_TRD_T0:-} ]] || [[ $CAN_DO_CALIB_TRD_T0 == 0 ]] ) && CALIB_TRD_T0=0

---

if the detector calibration for TRD is present and the detectors ITS, TPC, and TRD are available and have matching conditions; then set CAN_DO_CALIB_TRD_VDRIFTEXB to 1, CAN_DO_CALIB_TRD_GAIN to 1, and CAN_DO_CALIB_TRD_T0 to 1; otherwise, set these values to 0. 
if the detector calibration for EMC is present and the EMC reconstruction is available; then set CAN_DO_CALIB_EMC_BADCHANNELCALIB to 1 and CAN_DO_CALIB_EMC_TIMECALIB to 1; otherwise, set these values to 0. 
if the detector calibration for PHS is present and the PHS reconstruction is available; then set CAN_DO_CALIB_PHS_BADMAPCALIB to 1, CAN_DO_CALIB_PHS_TURNONCALIB to 1, CAN_DO_CALIB_PHS_RUNBYRUNCALIB to 1, and CAN_DO_CALIB_PHS_L1PHASE to 1; otherwise, set all these values to 0. 
if the detector calibration for CPV is present and the CPV reconstruction is available; then set CAN_DO_CALIB_CPV_GAIN to 1; otherwise, set it to 0.

---

# define the conditions for each calibration
if the ITS detector calibration is present and ITS detector reconstruction is available, and the primary vertex sources are defined, then set CAN_DO_CALIB_PRIMVTX_MEANVTX to 1; otherwise, set it to 0.
if the ITS detector calibration is present, then set CAN_DO_CALIB_ITS_DEADMAP_TIME to 1; otherwise, set it to 0.
if the MFT detector calibration is present, then set CAN_DO_CALIB_MFT_DEADMAP_TIME to 1; otherwise, set it to 0.
if TOF detector calibration is present and TOF detector reconstruction is available, then set CAN_DO_CALIB_TOF_DIAGNOSTICS to 1 and CAN_DO_CALIB_TOF_INTEGRATEDCURR to 1; otherwise, set both to 0.
if TOF detector calibration is present, TOF detector reconstruction is available, and either ITS-TPC or ITS-TPC-TRD matching is defined, then set CAN_DO_CALIB_TOF_LHCPHASE and CAN_DO_CALIB_TOF_CHANNELOFFSETS to 1; otherwise, set both to 0.