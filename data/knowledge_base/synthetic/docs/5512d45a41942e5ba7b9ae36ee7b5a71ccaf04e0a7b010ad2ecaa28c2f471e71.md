## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/RelVal/run/run_data_rel_val.sh

**Start chunk id:** 5512d45a41942e5ba7b9ae36ee7b5a71ccaf04e0a7b010ad2ecaa28c2f471e71

## Content

DOCUMENT:
    rel_val_aod()
{
    local file1=${1}
    local file2=${2}
    local label1=${3}
    local label2=${4}
    local output=${OUTPUT}/AOD
    local output_all=${output}/all
    local output_all_bad=${output_all}_BAD
    rm -r ${output} 2>/dev/null

    echo "Performing Full RelVal to ${output_all}" | tee -a ${LOGFILE}
    ${O2DPG_ROOT}/RelVal/o2dpg_release_validation.py rel-val -i ${file1} -j ${file2} -o ${output_all} --labels ${label1} ${label2} 2>&1 | tee -a ${LOGFILE}
    echo "Extracting BAD entries from ${output_all} and saving them to ${output_all_bad}" | tee -a ${LOGFILE}
    ${O2DPG_ROOT}/RelVal/o2dpg_release_validation.py inspect --path ${output_all} --output ${output_all_bad} --interpretations BAD 2>&1 | tee -a ${LOGFILE}
}

print_help()
{
    echo "Usage:"
    echo "run_data_rel_val.sh [--qc <QCfile1> <QCfile2>] [--aod <AODfile1> <AODfile2>] [--labels <label1> <label2>]"
}

# Files and labels
AOD1=
AOD2=
QC1=
QC2=
LABEL1="label1"
LABEL2="label2"

while [[ $# -gt 0 ]]; do
    key="$1"

---

DOCUMENT:
    while [[ $# -gt 0 ]]; do
    key="$1"

    case $key in
        --qc)
            shift
            QC1=${1}
            shift
            QC2=${1}
            shift
            ;;
        --aod)
            shift
            AOD1=${1}
            shift
            AOD2=${1}
            shift
            ;;
        --labels)
            shift
            LABEL1=${1}
            shift
            LABEL2=${1}
            shift
            ;;
        --help|-h)
            print_help
            exit 0
            ;;
        *)
            echo "ERROR: Unknown argument ${1}"
            print_help
            exit 1
            ;;
    esac
done

QC_RET=0
AOD_RET=0

mkdir ${OUTPUT} 2>/dev/null
echo "Execute the validation and save results in ${OUTPUT}" | tee -a ${LOGFILE}

---

DOCUMENT:
    echo "Full RelVal to ${output_all}" | tee -a ${LOGFILE}
    ${O2DPG_ROOT}/RelVal/o2dpg_release_validation.py rel-val -i ${file1} -j ${file2} -o ${output_all} --labels ${label1} ${label2} 2>&1 | tee -a ${LOGFILE}
    echo "Process ${output_all} to identify BAD elements and save to ${output_all_bad}" | tee -a ${LOGFILE}
    ${O2DPG_ROOT}/RelVal/o2dpg_release_validation.py inspect --path ${output_all} --output ${output_all_bad} --interpretations BAD >> ${LOGFILE} 2>&1
    echo "Perform RelVal for each detector..." | tee -a ${LOGFILE}
    for det in CPV EMC FDD FT0 FV0 GLO ITS MCH MFT MID PHS TOF TPC TRD ZDC ; do
        echo "Specifically for ${det}, output to ${output_det}_${det}, using 'int_${det}_' as the include pattern; this might need adjustment based on the internal file structure of the QC ROOT file" | tee -a ${LOGFILE}
        ${O2DPG_ROOT}/RelVal/o2dpg_release_validation.py inspect --path ${output_all} --output ${output_det}_${det} --include-patterns "int_${det}_" >> ${LOGFILE} 2>&1 &

---

#!/bin/bash

if [[ -z ${O2DPG_ROOT+x} ]] ; then
    echo "O2DPG is not loaded, indicating potential absence of other necessary packages in this environment."
    exit 1
fi

DATE=$(date '+%Y-%m-%d_%H-%M')
OUTPUT=rel_val_${DATE}
LOGFILE=${OUTPUT}/"rel_val.log"

function wait_for_jobs()
{
    local n_parallel=${1:-5}
    local sleep_time=${2:-2}
    while true
    do
        n_packing=$(jobs | grep "include-patterns" | grep "Running" | wc -l )
        if (( $n_packing >= ${n_parallel} ))
        then
            sleep $sleep_time
        else
            break
        fi
    done
}

rel_val_qc()
{
    local file1=${1}
    local file2=${2}
    local label1=${3}
    local label2=${4}
    local output=${OUTPUT}/QC
    local output_all=${output}/all
    local output_all_bad=${output_all}_BAD
    local output_det="${output}/det"
    rm -r ${output} 2>/dev/null

---

mkdir ${OUTPUT} 2>/dev/null
echo "Starting RelVal and output to ${OUTPUT}" | tee -a ${LOGFILE}

if [[ "${QC1}" != "" && "${QC2}" != "" ]]; then
    rel_val_qc ${QC1} ${QC2} ${LABEL1} ${LABEL2}
    QC_RET=${?}
else
    echo "No QC RelVal" | tee -a ${LOGFILE}
fi

if [[ "${AOD1}" != "" && "${AOD2}" != "" ]]; then
    rel_val_aod ${AOD1} ${AOD2} ${LABEL1} ${LABEL2}
    AOD_RET=${?}
else
    echo "No AOD RelVal" | tee -a ${LOGFILE}
fi

RET=$((QC_RET + AOD_RET))
echo "Exiting with ${RET}" | tee -a ${LOGFILE}
exit ${RET}

---

wait_for_jobs 3
done
wait_for_jobs 1
}