## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/MC/run/ANCHOR/anchorMC.sh

**Start chunk id:** 0a3c477ab6725d7e85429587f969396d2da3fd0c93899802f2c361b0006f4cd5

## Content

# these parameters will be processed by o2dpg_sim_workflow_anchored.py
baseargs="-tf ${NTIMEFRAMES} --split-id ${SPLITID} --prod-split ${PRODSPLIT} --cycle ${CYCLE} --run-number ${ALIEN_JDL_LPMRUNNUMBER}                               \
          ${ALIEN_JDL_RUN_TIME_SPAN_FILE:+--run-time-span-file ${ALIEN_JDL_RUN_TIME_SPAN_FILE} ${ALIEN_JDL_INVERT_IRFRAME_SELECTION:+--invert-irframe-selection}}       \
          ${ALIEN_JDL_MC_ORBITS_PER_TF:+--orbitsPerTF ${ALIEN_JDL_MC_ORBITS_PER_TF}} ${PUBLISH_MCPRODINFO_OPTION}"

---

if [ "${ENABLEPW}" == "0" ]; then
  if [ -f "$PWD/its_GeometryTGeo.root" ]; then
    mkdir -p "$ALICEO2_CCDB_LOCALCACHE/ITS/Config/Geometry"
    ln -s -f "$PWD/its_GeometryTGeo.root" "$ALICEO2_CCDB_LOCALCACHE/ITS/Config/Geometry/snapshot.root"
  fi
fi
if [ -f "$PWD/mft_GeometryTGeo.root" ]; then
  mkdir -p "$ALICEO2_CCDB_LOCALCACHE/MFT/Config/Geometry"
  ln -s -f "$PWD/mft_GeometryTGeo.root" "$ALICEO2_CCDB_LOCALCACHE/MFT/Config/Geometry/snapshot.root"
fi

---

#<----- START OF part that should run under a clean alternative software environment if this was given ------
if [ "${ALIEN_JDL_O2DPG_ASYNC_RECO_TAG}" ]; then
  if [ "${LOADEDMODULES}" ]; then
    export > env_before_stashing.env
    echo "Saving initial module environment"
    module save initial_modules.list # we save the current modules environment
    module list --no-pager
    module purge --no-pager
    export > env_after_stashing.env
    echo "Module environment after purge"
    module list --no-pager
  fi
  echo_info "Using tag ${ALIEN_JDL_O2DPG_ASYNC_RECO_TAG} to setup anchored MC"
  /cvmfs/alice.cern.ch/bin/alienv printenv "${ALIEN_JDL_O2DPG_ASYNC_RECO_TAG}" &> async_environment.env
  source async_environment.env
  export > env_async.env
fi

# default async_pass.sh script
DPGRECO=$O2DPG_ROOT/DATA/production/configurations/asyncReco/async_pass.sh
# default destenv_extra.sh script
DPGSETENV=$O2DPG_ROOT/DATA/production/configurations/asyncReco/setenv_extra.sh

---

# It is assumed that an async_pass.sh script is available in the current directory, and if so, it should be used.
if [[ -f async_pass.sh ]]; then
    # Make the script executable if it isn't already.
    chmod +x async_pass.sh
    DPGRECO=./async_pass.sh
else
    cp -v $DPGRECO .
fi

# If setenv_extra.sh is not present in this directory, indicating no special version is included with this production, copy the default one.
if [[ ! -f setenv_extra.sh ]]; then
    cp ${DPGSETENV} .
    echo_info "Using the default setenv_extra.sh from ${DPGSETENV}."
else
    echo_info "setenv_extra.sh is found in the current working directory, using it."
fi

chmod u+x setenv_extra.sh

echo_info "Setting up DPGRECO to ${DPGRECO}"

# Remove the line that runs the workflow if there is no data input specified.
[ ${CTF_TEST_FILE} ] || sed -i '/WORKFLOWMODE=run/d' async_pass.sh

# Generate the workflow file that can be parsed.
export IGNORE_EXISTING_SHMFILES=1
touch list.list

---

[[ -n "${DISABLE_QC}" ]] && echo_info "QC is disabled, skipping it."

if [[ -z "${DISABLE_QC}" && "${MCRC}" == "0" && "${remainingargs}" == *"--include-local-qc"* ]] ; then
  # execute QC tasks
  echo_info "Executing QC"
  ${O2DPG_ROOT}/MC/bin/o2_dpg_workflow_runner.py -f workflow.json --target-labels QC --cpu-limit ${ALIEN_JDL_CPULIMIT:-8} -k
  # NOTE that the -k|--keep-going option ensures the runner continues executing even if some tasks fail.
  # As a result, a failing QC task will not necessarily cause the return code to be non-zero.
  MCRC=$?
fi

---

NWORKERS, define the number of workers for detector transport, with a default of 8;
ALIEN_JDL_SIMENGINE or SIMENGINE, select the transport engine, with a default of TGeant4;
ALIEN_JDL_WORKFLOWDETECTORS, specify the detectors to be included, with a default of ITS,TPC,TOF,FV0,FT0,FDD,MID,MFT,MCH,TRD,EMC,PHS,CPV,HMP,CTP;
ALIEN_JDL_ANCHOR_SIM_OPTIONS, add extra options to the workflow creation, with a default of -gen pythia8;
ALIEN_JDL_ADDTIMESERIESINMC, execute TPC time series. Default is on (1); disable by setting to 0;
ALIEN_JDL_MC_ORBITS_PER_TF=N, enforce a fixed number of orbits per timeframe, instead of relying on CCDB;
ALIEN_JDL_RUN_TIME_SPAN_FILE=FILE, utilize a run-time-span file to exclude periods of poor data-taking;
ALIEN_JDL_INVERT_IRFRAME_SELECTION, reverse the choice made by ALIEN_JDL_RUN_TIME_SPAN_FILE;
ALIEN_JDL_CCDB_CONDITION_NOT_AFTER, set the condition_not_after timestamp for CCDB queries.

---

# these arguments will also be provided but will ultimately be processed by o2dpg_sim_workflow.py, which is invoked by o2dpg_sim_workflow_anchored.py
remainingargs="-seed ${SEED} -ns ${NSIGEVENTS} --include-local-qc --pregenCollContext"
remainingargs="${remainingargs} -e ${ALIEN_JDL_SIMENGINE} -j ${NWORKERS}"
remainingargs="${remainingargs} -productionTag ${ALIEN_JDL_LPMPRODUCTIONTAG:-alibi_anchorTest_tmp}"
# prepend(!) ALIEN_JDL_ANCHOR_SIM_OPTIONS
# because the last argument takes precedence, e.g., -productionTag cannot be altered by the user
remainingargs="${ALIEN_JDL_ANCHOR_SIM_OPTIONS} ${remainingargs} --anchor-config config-json.json"
# apply the software tagging choice
# remainingargs="${remainingargs} ${ALIEN_JDL_O2DPG_ASYNC_RECO_TAG:+--alternative-reco-software ${ALIEN_JDL_O2DPG_ASYNC_RECO_TAG}}"
ALIEN_JDL_O2DPG_ASYNC_RECO_FROMSTAGE=${ALIEN_JDL_O2DPG_ASYNC_RECO_FROMSTAGE:-RECO}

---

DOCUMENT:
    ALIEN_JDL_O2DPG_ASYNC_RECO_FROMSTAGE=${ALIEN_JDL_O2DPG_ASYNC_RECO_FROMSTAGE:-RECO}
remainingargs="${remainingargs} ${ALIEN_JDL_O2DPG_ASYNC_RECO_TAG:+--alternative-reco-software ${PWD}/env_async.env@${ALIEN_JDL_O2DPG_ASYNC_RECO_FROMSTAGE}}"
# potentially add CCDB timemachine timestamp
remainingargs="${remainingargs} ${ALIEN_JDL_CCDB_CONDITION_NOT_AFTER:+--condition-not-after ${ALIEN_JDL_CCDB_CONDITION_NOT_AFTER}}"

---

[[ "${BASEDIR}" == /cvmfs/* ]] && ONCVMFS=1
if [ ! "${MODULEPATH}" ]; then
  export MODULEPATH=${BASEDIR}/../Modules/modulefiles
  if [ "${ONCVMFS}" == "1" ]; then
    PLATFORM=$(echo "${BASEDIR}" | sed -E 's|.*/([^/]+)/Packages|\1|')
    export MODULEPATH=${MODULEPATH}:${BASEDIR}/../../etc/toolchain/modulefiles/${PLATFORM}
  fi
  echo "The determined Modulepath is ${MODULEPATH}"
fi

---

# check for the validity of the configuration
if [[ "${ASYNC_WF_RC}" != "0" || `grep "ConfigParams" config-json.json 2> /dev/null | wc -l` == "0" ]]; then
  echo_error "Issue detected in anchor configuration. Stopping the process."
  exit 1
fi

# -- GENERATE THE MC JOB DESCRIPTION TIED TO THE RUN --

MODULES="--skipModules ZDC"
# Ensure this is specified clearly
ALICEO2_CCDB_LOCALCACHE=${ALICEO2_CCDB_LOCALCACHE:-$(pwd)/ccdb}

# publish MCPRODINFO for the initial jobs in a production run
# if an external script sets PUBLISH_MCPRODINFO, it will be published regardless
if [ -z "$PUBLISH_MCPRODINFO" ] && [ "$SPLITID" -lt 20 ]; then
  PUBLISH_MCPRODINFO_OPTION="--publish-mcprodinfo"
  echo "MCProdInfo will be published"
else
  echo "MCProdInfo will not be published"
fi

---

DOCUMENT:
    echo_info "baseargs passed to o2dpg_sim_workflow_anchored.py: ${baseargs}"
echo_info "remainingargs forwarded to o2dpg_sim_workflow.py: ${remainingargs}"

anchoringLogFile=timestampsampling_${ALIEN_JDL_LPMRUNNUMBER}.log
# query to CCDB has changed, without "_"
${O2DPG_ROOT}/MC/bin/o2dpg_sim_workflow_anchored.py ${baseargs} -- ${remainingargs} &> ${anchoringLogFile}
WF_RC="${?}"
if [ "${WF_RC}" != "0" ] ; then
    echo_error "Issue encountered during anchor timestamp sampling and workflow creation. Exiting."
    exit ${WF_RC}
fi

TIMESTAMP=`grep "Determined timestamp to be" ${anchoringLogFile} | awk '//{print $6}'`
echo_info "TIMESTAMP IS ${TIMESTAMP}"

---

if [ -z "${CYCLE}" ]; then
  echo_info "No CYCLE number specified ... setting it to 0"
  CYCLE=0
fi

# this script produces a precise reproduction script for this job
# which can be used for local debugging and similar purposes.
if [[ -n "${ALIEN_PROC_ID}" && -n "${JALIEN_WSPORT}" ]]; then
  ${O2DPG_ROOT}/GRID/utils/getReproducerScript.sh ${ALIEN_PROC_ID}
fi

# maintain a genuine default
NWORKERS=${NWORKERS:-8}
# set a default seed if it's not provided
SEED=${ALIEN_PROC_ID:-${SEED:-1}}

ONCVMFS=0

if [ "${ALIEN_JDL_O2DPG_OVERWRITE}" ]; then
  echo "Setting O2DPG_ROOT to the overwritten path ${ALIEN_JDL_O2DPG_OVERWRITE}"
  export O2DPG_ROOT=${ALIEN_JDL_O2DPG_OVERWRITE}
fi

export > env_base.env

if ! declare -F module > /dev/null; then
  module() {
    eval "$(/usr/bin/modulecmd bash "$@")";
  }
  export -f module
fi

---

[ -z "${NTIMEFRAMES}" ] && { echo_error "Set NTIMEFRAMES" ; exit 1 ; }
[ -z "${SPLITID}" ] && { echo_error "Set SPLITID" ; exit 1 ; }
[ -z "${PRODSPLIT}" ] && { echo_error "Set PRODSPLIT" ; exit 1 ; }

# The number of signal events can be specified, but it's generally only relevant in specific expert scenarios. By default, the final event count is decided by the timeframe length.
if [ -z "${NSIGEVENTS}" ]; then
  NSIGEVENTS=10000 # this is just a large number; in the simulation, the event count is the lesser of this number and what can fit into a single timeframe, based on the interaction rate. This number is a reasonable upper limit corresponding to approximately 5696 collisions that fit into 32 LHC orbits at a 2MHz interaction rate.
fi

if [ -z "${CYCLE}" ]; then
  echo_info "No CYCLE number provided ... defaulting to 0"
  CYCLE=0
fi

---

DOCUMENT:
    echo "DISABLE_QC, use this to turn off quality control, for example, setting it to 1"
    echo "CYCLE, to specify a cycle number other than 0"
    echo "NSIGEVENTS, to set a maximum number of events within a timeframe (excluding orbit-early) events"
}

---

# remove the temporary software environment
if [ "${ALIEN_JDL_O2DPG_ASYNC_RECO_TAG}" ]; then
  module purge --no-pager
  # revert to the initial software configuration
  echo "Reverting to initial configuration"
  module --no-pager restore initial_modules.list
  module saverm initial_modules.list
  if [ "${ALIEN_JDL_O2DPG_OVERWRITE}" ]; then
    echo "Resetting O2DPG_ROOT to the overwritten path ${ALIEN_JDL_O2DPG_OVERWRITE}"
    export O2DPG_ROOT=${ALIEN_JDL_O2DPG_OVERWRITE}
  fi
fi
#<----- END OF section that should revert to the clean initial environment if needed ------

# proceed to generate the local MC configuration file --> config-json.json
# the new configuration output will include blacklist functionality
ASYNC_CONFIG_BLACKLIST=${ASYNC_CONFIG_BLACKLIST:-${O2DPG_ROOT}/MC/run/ANCHOR/anchor-dpl-options-blacklist.json}
${O2DPG_ROOT}/MC/bin/o2dpg_dpl_config_tools.py workflowconfig.log ${ASYNC_CONFIG_BLACKLIST} config-json.json
ASYNC_WF_RC=${?}

---

# Prevent the script from sourcing to avoid unexpected outcomes when exit is used
SCRIPT_NAME="$(basename "$(test -L "$0" && readlink "$0" || echo "$0")")"
if [ "${SCRIPT_NAME}" != "$(basename ${BASH_SOURCE[0]})" ] ; then
    echo_error "This script cannot be sourced" >&2
    return 1
fi

while [ "$1" != "" ] ; do
    case $1 in
        --help|-h ) shift
                    print_help
                    exit 0
                    ;;
        * ) echo "Unknown argument ${1}"
            exit 1
            ;;
    esac
done

# ensure that O2DPG and O2 are loaded
[ ! "${O2DPG_ROOT}" ] && echo_error "O2DPG needs to be loaded" && exit 1
[ ! "${O2_ROOT}" ] && echo_error "O2 needs to be loaded" && exit 1

# verify that jq is installed
which jq >/dev/null 2>&1
[ "${?}" != "0" ] && { echo_error "jq is not installed. Please install or load via alienv." ; exit 1 ; }

alien-token-info >/dev/null 2>&1
[ "${?}" != "0" ] && { echo_error "No GRID token found, necessary for running the script." ; exit 1 ; }

---

EXPORT ALIEN_JDL_LPMPASSNAME=ALIEN_JDL_LPMANCHORPASSNAME
EXPORT ALIEN_JDL_LPMRUNNUMBER=ALIEN_JDL_LPMRUNNUMBER \[${ALIEN_JDL_LPMRUNNUMBER}:-${RUNNUMBER}\]
EXPORT ALIEN_JDL_LPMPRODUCTIONTYPE=ALIEN_JDL_LPMPRODUCTIONTYPE \[${ALIEN_JDL_LPMPRODUCTIONTYPE}:-${PRODUCTIONTYPE}\]
EXPORT ALIEN_JDL_LPMINTERACTIONTYPE=ALIEN_JDL_LPMINTERACTIONTYPE \[${ALIEN_JDL_LPMINTERACTIONTYPE}:-${INTERACTIONTYPE}\]
EXPORT ALIEN_JDL_LPMPRODUCTIONTAG=ALIEN_JDL_LPMPRODUCTIONTAG \[${ALIEN_JDL_LPMPRODUCTIONTAG}:-${PRODUCTIONTAG}\]
EXPORT ALIEN_JDL_LPMANCHORRUN=ALIEN_JDL_LPMANCHORRUN \[${ALIEN_JDL_LPMANCHORRUN}:-${ANCHORRUN}\]
EXPORT ALIEN_JDL_LPMANCHORPRODUCTION=ALIEN_JDL_LPMANCHORPRODUCTION \[${ALIEN_JDL_LPMANCHORPRODUCTION}:-${ANCHORPRODUCTION}\]
EXPORT ALIEN_JDL_LPMANCHORYEAR=ALIEN_JDL_LPMANCHORYEAR \[${ALIEN_JDL_LPMANCHORYEAR}:-${ANCHORYEAR}\]
# determine if TPC time series should be run; default is on, can be disabled by setting to 0
EXPORT ALIEN_JDL_ADDTIMESERIESINMC=ALIEN_JDL_ADDTIMESERIESINMC \[${ALIEN_JDL_ADDTIMESERIESINMC}:-1\}

---

#
# All logs, including quality control (QC) logs, are tarred for output regardless of error codes or validation...
#
if [[ -n "$ALIEN_PROC_ID" ]]; then
  find ./ \( -name "*.log*" -o -name "*mergerlog*" -o -name "*serverlog*" -o -name "*workerlog*" -o -name "pythia8.cfg" -o -name "reproducer*.sh" \) | tar -czvf debug_log_archive.tgz -T -
  if [[ "$ALIEN_JDL_CREATE_TAR_IN_MC" == "1" ]]; then
    find ./ \( -name "*.log*" -o -name "*mergerlog*" -o -name "*serverlog*" -o -name "*workerlog*" -o -name "*.root" \) | tar -czvf debug_full_archive.tgz -T -
  fi
fi

unset FAIRMQ_IPC_PREFIX

exit ${MCRC}

---

# verify required variables are set
[ -z "${ALIEN_JDL_LPMANCHORPASSNAME}" ] && { echo_error "Configure ALIEN_JDL_LPMANCHORPASSNAME or ANCHORPASSNAME" ; exit 1 ; }
[ -z "${ALIEN_JDL_LPMRUNNUMBER}" ] && { echo_error "Configure ALIEN_JDL_LPMRUNNUMBER or RUNNUMBER" ; exit 1 ; }
[ -z "${ALIEN_JDL_LPMPRODUCTIONTYPE}" ] && { echo_error "Configure ALIEN_JDL_LPMPRODUCTIONTYPE or PRODUCTIONTYPE" ; exit 1 ; }
[ -z "${ALIEN_JDL_LPMINTERACTIONTYPE}" ] && { echo_error "Configure ALIEN_JDL_LPMINTERACTIONTYPE or INTERACTIONTYPE" ; exit 1 ; }
[ -z "${ALIEN_JDL_LPMPRODUCTIONTAG}" ] && { echo_error "Configure ALIEN_JDL_LPMPRODUCTIONTAG or PRODUCTIONTAG" ; exit 1 ; }
[ -z "${ALIEN_JDL_LPMANCHORRUN}" ] && { echo_error "Configure ALIEN_JDL_LPMANCHORRUN or ANCHORRUN" ; exit 1 ; }
[ -z "${ALIEN_JDL_LPMANCHORPRODUCTION}" ] && { echo_error "Configure ALIEN_JDL_LPMANCHORPRODUCTION or ANCHORPRODUCTION" ; exit 1 ; }
[ -z "${ALIEN_JDL_LPMANCHORYEAR}" ] && { echo_error "Configure ALIEN_JDL_LPMANCHORYEAR or ANCHORYEAR" ; exit 1 ; }

---

# verify if the job should be skipped due to it being within a bad data-taking period
ISEXCLUDED=$(grep "TIMESTAMP IS EXCLUDED IN RUN" ${anchoringLogFile})
if [ "${ISEXCLUDED}" ]; then
  # we can stop here as there is no further action required
  # (except perhaps creating a dummy AO2D.root file or similar)
  echo "Timestamp is excluded from run. No further action required."
  exit 0
fi

# -- Generate aligned geometry using ITS ideal alignment to prevent overlaps in geant
ENABLEPW=0
if [[ ${remainingargs} == *"GeometryManagerParam.useParallelWorld=1"* ]]; then
  ENABLEPW=1
fi

if [ "${ENABLEPW}" == "0" ]; then
  CCDBOBJECTS_IDEAL_MC="ITS/Calib/Align"
  TIMESTAMP_IDEAL_MC=1
  ${O2_ROOT}/bin/o2-ccdb-downloadccdbfile --host http://alice-ccdb.cern.ch/ -p ${CCDBOBJECTS_IDEAL_MC} -d ${ALICEO2_CCDB_LOCALCACHE} --timestamp ${TIMESTAMP_IDEAL_MC}
  CCDB_RC="${?}"
  if [ ! "${CCDB_RC}" == "0" ]; then
    echo_error "Problem during CCDB prefetching of ${CCDBOBJECTS_IDEAL_MC}. Exiting."
    exit ${CCDB_RC}
  fi
fi

---

# TODO This can potentially be removed or, if necessary, should be managed by o2dpg_sim_workflow_anchored.py and O2_dpg_workflow_runner.py
if [ "${ENABLEPW}" == "0" ]; then
  echo "run with echo in pipe" | ${O2_ROOT}/bin/o2-create-aligned-geometry-workflow ${ALIEN_JDL_CCDB_CONDITION_NOT_AFTER:+--condition-not-after ${ALIEN_JDL_CCDB_CONDITION_NOT_AFTER}} --configKeyValues "HBFUtils.startTime=${TIMESTAMP}" --condition-remap=file://${ALICEO2_CCDB_LOCALCACHE}=ITS/Calib/Align -b --run
else
  echo "run with echo in pipe" | ${O2_ROOT}/bin/o2-create-aligned-geometry-workflow ${ALIEN_JDL_CCDB_CONDITION_NOT_AFTER:+--condition-not-after ${ALIEN_JDL_CCDB_CONDITION_NOT_AFTER}} --configKeyValues "HBFUtils.startTime=${TIMESTAMP}" -b --run
fi
mkdir -p $ALICEO2_CCDB_LOCALCACHE/GLO/Config/GeometryAligned
ln -s -f $PWD/o2sim_geometry-aligned.root $ALICEO2_CCDB_LOCALCACHE/GLO/Config/GeometryAligned/snapshot.root
if [ "${ENABLEPW}" == "0" ]; then

---

print_help()
{
  echo "Usage: ./anchorMC.sh"
  echo
  echo "It requires O2 and O2DPG to be loaded from alienv."
  echo
  echo "Ensure that the following environment variables are set:"
  echo "ALIEN_JDL_LPMANCHORPASSNAME or ANCHORPASSNAME,"
  echo "ALIEN_JDL_MCANCHOR or MCANCHOR,"
  echo "ALIEN_JDL_LPMPASSNAME or PASSNAME,"
  echo "ALIEN_JDL_LPMRUNNUMBER or RUNNUMBER,"
  echo "ALIEN_JDL_LPMPRODUCTIONTYPE or PRODUCTIONTYPE,"
  echo "ALIEN_JDL_LPMINTERACTIONTYPE or INTERACTIONTYPE,"
  echo "ALIEN_JDL_LPMPRODUCTIONTAG or PRODUCTIONTAG,"
  echo "ALIEN_JDL_LPMANCHORRUN or ANCHORRUN,"
  echo "ALIEN_JDL_LPMANCHORPRODUCTION or ANCHORPRODUCTION,"
  echo "ALIEN_JDL_LPMANCHORYEAR or ANCHORYEAR,"
  echo
  echo "Additionally, set:"
  echo "NTIMEFRAMES,"
  echo "SPLITID,"
  echo "PRODSPLIT."
  echo
  echo "Optional settings include:"
  echo "ALIEN_JDL_CPULIMIT or CPULIMIT, to define the CPU limit of the workflow runner, with a default of 8,"
  echo "NWORKERS, to specify the number of workers for detector transport, with a default of 8,"

}

---

#################################################################
# Set all necessary variables to identify an anchored production #
#################################################################

# Accept both "ALIEN_JDL_LPM<KEY>" and "KEY" formats

Note: The original text is quite short, and the paraphrasing maintains its essence and length.

---

# -- RUN THE MC WORKLOAD TO GENERATE AOD --

export FAIRMQ_IPC_PREFIX=./

echo_info "Prepared to execute the main workflow"

${O2DPG_ROOT}/MC/bin/o2_dpg_workflow_runner.py -f workflow.json -tt ${ALIEN_JDL_O2DPGWORKFLOWTARGET:-aod} --cpu-limit ${ALIEN_JDL_CPULIMIT:-8} --dynamic-resources
MCRC=$?  # <--- we'll report back this code
if [[ "${MCRC}" == "0" && "${ALIEN_JDL_ADDTIMESERIESINMC}" != "0" ]]; then
  # Default value is 1, so this step is executed by default.
  echo_info "Starting TPC time series analysis"
  ${O2DPG_ROOT}/MC/bin/o2_dpg_workflow_runner.py -f workflow.json -tt tpctimes
  # Note: We could potentially remove this if-else condition by integrating `tpctimes` into the workflow-targets above.
fi

if [[ "${MCRC}" == "0" && "${ALIEN_JDL_DOTPCRESIDUALEXTRACTION}" = "1" ]]; then
  echo_info "Performing TPC residuals extraction, aggregation, and merging"
  ${O2DPG_ROOT}/MC/bin/o2_dpg_workflow_runner.py -f workflow.json -tt tpcresidmerge
fi

[[ -n "${DISABLE_QC}" ]] && echo_info "QC is turned off, skipping it."

---

#!/bin/bash

# incorporate distortion maps
# https://alice.its.cern.ch/jira/browse/O2-3346?focusedCommentId=300982&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-300982
#
# export O2DPG_ENABLE_TPC_DISTORTIONS=ON
# SCFile=$PWD/distortions_5kG_lowIR.root # file needs to be downloaded
# export O2DPG_TPC_DIGIT_EXTRA=" --distortionType 2 --readSpaceCharge ${SCFile} "

#
# process for setting up and running an anchored MC
#

########################
# supporting functions #
########################

echo_info()
{
  echo "INFO [anchorMC]: ${*}"
}

echo_error()
{
  echo "ERROR [anchorMC]: ${*}"
}

---

# the default values are provided for only four of these
export ALIEN_JDL_CPULIMIT=${ALIEN_JDL_CPULIMIT:-${CPULIMIT:-8}}
export ALIEN_JDL_SIMENGINE=${ALIEN_JDL_SIMENGINE:-${SIMENGINE:-TGeant4}}
export ALIEN_JDL_WORKFLOWDETECTORS=${ALIEN_JDL_WORKFLOWDETECTORS:-ITS,TPC,TOF,FV0,FT0,FDD,MID,MFT,MCH,TRD,EMC,PHS,CPV,HMP,CTP}
# these can include extra options to be passed to o2dpg_sim_workflow_anchored.py and subsequently to o2dpg_sim_workflow.py
export ALIEN_JDL_ANCHOR_SIM_OPTIONS=${ALIEN_JDL_ANCHOR_SIM_OPTIONS:--gen pythia8}
# all other values must be defined by the user or externally
export ALIEN_JDL_LPMANCHORPASSNAME=${ALIEN_JDL_LPMANCHORPASSNAME:-${ANCHORPASSNAME}}
# LPMPASSNAME is utilized in O2 and O2DPG scripts, while ALIEN_JDL_LPMANCHORPASSNAME is the parameter set in JDL templates; therefore, use ALIEN_JDL_LPMANCHORPASSNAME and define ALIEN_JDL_LPMPASSNAME accordingly
export ALIEN_JDL_LPMPASSNAME=${ALIEN_JDL_LPMANCHORPASSNAME}

---

# store the production tag temporarily; it will be replaced with an anchor tag later
ALIEN_JDL_LPMPRODUCTIONTAG_KEEP=$ALIEN_JDL_LPMPRODUCTIONTAG
echo_info "Replacing ALIEN_JDL_LPMPRODUCTIONTAG=$ALIEN_JDL_LPMPRODUCTIONTAG with ALIEN_JDL_LPMANCHORPRODUCTION=$ALIEN_JDL_LPMANCHORPRODUCTION for simulating the reco pass..."
ALIEN_JDL_LPMPRODUCTIONTAG=$ALIEN_JDL_LPMANCHORPRODUCTION

if [[ $ALIEN_JDL_ANCHOR_SIM_OPTIONS == *"--tpc-distortion-type 2"* ]]; then
  export O2DPG_ENABLE_TPC_DISTORTIONS=ON
  # specify the SCALING SOURCE as CTP for MC if not explicitly defined
  export ALIEN_JDL_TPCSCALINGSOURCE=${ALIEN_JDL_TPCSCALINGSOURCE:-"CTP"}
fi

---

# execute the async_pass.sh script and direct its output to a log file for review and data extraction
./async_pass.sh ${CTF_TEST_FILE:-""} 2>&1 > async_pass_log.log
RECO_RC=$?

echo_info "async_pass.sh completed with return code ${RECO_RC}"

if [[ "${RECO_RC}" != "0" ]]; then
  exit ${RECO_RC}
fi

# verify that workflowconfig.log was generated correctly
if [[ ! -f workflowconfig.log ]]; then
  echo "workflowconfig.log file not found"
  exit 1
fi

export ALIEN_JDL_LPMPRODUCTIONTAG=$ALIEN_JDL_LPMPRODUCTIONTAG_KEEP
echo_info "Restoring ALIEN_JDL_LPMPRODUCTIONTAG to $ALIEN_JDL_LPMPRODUCTIONTAG"