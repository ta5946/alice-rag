## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/DATA/common/gen_topo_helper_functions.sh

**Start chunk id:** 0c14c5dbc1975f1a328c4fc70bc7aba7715abc5e718d1970fceb30bf9cbd322f

## Content

DOCUMENT:
    add_W() # Add binary to workflow command USAGE: add_W [BINARY] [COMMAND_LINE_OPTIONS] [CONFIG_KEY_VALUES] [Add ARGS_ALL_CONFIG, optional, default = 1]
{
  local PROC_NAME_ARGS="ARGS_EXTRA_PROCESS_${1//-/_}"
  local PROC_NAME_CONFIG="CONFIG_EXTRA_PROCESS_${1//-/_}"
  local CONFIG_KEY_VALUES=
  [[ "0${4:-}" != "00" ]] && CONFIG_KEY_VALUES+="$ARGS_ALL_CONFIG;"
  [[ ! -z "${3:-}" ]] && CONFIG_KEY_VALUES+="$3;"
  [[ ! -z ${!PROC_NAME_CONFIG:-} ]] && CONFIG_KEY_VALUES+="${!PROC_NAME_CONFIG};"
  [[ ! -z "$CONFIG_KEY_VALUES" ]] && CONFIG_KEY_VALUES="--configKeyValues \"$CONFIG_KEY_VALUES\""
  local WFADD="$1 $ARGS_ALL ${2:-} ${!PROC_NAME_ARGS:-} $CONFIG_KEY_VALUES | "
  local PROC_ENABLE_ROOT_OUTPUT="ENABLE_ROOT_OUTPUT_${1//-/_}"
  if [[ ! -z $DISABLE_ROOT_OUTPUT ]] && needs_root_output $1 ; then
      WFADD=${WFADD//$DISABLE_ROOT_OUTPUT/}
  fi
  WORKFLOW+=$WFADD
}

---

DOCUMENT:
    echo $1:\$\(\(\($MULT*\$AUTOSCALE_PROCESS_FACTOR/100\) \< 16 ? \($MULT*\$AUTOSCALE_PROCESS_FACTOR/100\) : 16\)\)
  else
    echo $1:$MULT
  fi
}

    PARAPHRASED DOCUMENT:

---

DOCUMENT:
    for ((i = 2; i <= $#; i++ )); do
    if [[ -z ${!1:-} ]]; then
      eval $1+="${!i}"
    else
      eval $1+="\;${!i}"
    fi
  done
}

add_pipe_separated()
{
  if (( $# < 2 )); then
    echo "$# parameters received"
    echo "Function name: ${FUNCNAME} requires at least 2 parameters:"
    echo "it concatenates the string in the first parameter with the subsequent ones, creating a pipe-separated string. $# parameters received"
    exit 1
  fi

  for ((i = 2; i <= $#; i++ )); do
    eval $1+="\|${!i}"
  done
}

# ---------------------------------------------------------------------------------------------------------------------
# Helper functions for multiplicities

---

if [[ ${EPNSYNCMODE:-0} == 1 ]]; then
  if [[ "${GEN_TOPO_DEPLOYMENT_TYPE:-}" == "ALICE_STAGING" ]]; then
    GEN_TOPO_QC_CONSUL_SERVER=ali-staging.cern.ch
  else
    GEN_TOPO_QC_CONSUL_SERVER=alio2-cr1-hv-con01.cern.ch
  fi
  GEN_TOPO_QC_APRICOT_SERVER=$(curl -s "http://${GEN_TOPO_QC_CONSUL_SERVER}:8500/v1/kv/o2/runtime/aliecs/vars/apricot_endpoint?raw")
fi

add_QC_from_consul()
{
  if [[ ${EPNSYNCMODE:-0} != 1 ]]; then
    echo "Error fetching QC JSON $1: consul server only set for EPNSYNCMODE == 1" 1>&2
    exit 1
  fi
  if [[ ! -z ${GEN_TOPO_QC_JSON_FILE:-} ]]; then
    curl -s -o $GEN_TOPO_QC_JSON_FILE "http://${GEN_TOPO_QC_CONSUL_SERVER}:8500/v1/kv${1}?raw"
    if [[ $? != 0 ]]; then
      echo "Error fetching QC JSON $1 (1)" 1>&2
      exit 1
    fi
    QC_CONFIG_ARG="json://${GEN_TOPO_QC_JSON_FILE}"
  else
    QC_CONFIG_ARG="consul-json://alio2-cr1-hv-con01.cern.ch:8500$1"
  fi
  add_W o2-qc "--config $QC_CONFIG_ARG $2"
}

---

DOCUMENT:
    has_track_source()
    {
      [[ $TRACK_SOURCES =~ (^|,)"$1"(,|$) ]]
    }

    has_tof_matching_source()
    {
      [[ $TOF_SOURCES =~ (^|,)"$1"(,|$) ]]
    }

    workflow_has_parameter()
    {
      [[ $WORKFLOW_PARAMETERS =~ (^|,)"$1"(,|$) ]]
    }

    has_processing_step()
    {
      [[ ${WORKFLOW_EXTRA_PROCESSING_STEPS:-} =~ (^|,)"$1"(,|$) ]]
    }

    _check_multiple()
    {
      CHECKER=$1
      shift
      while true; do
        if [[ -z ${1:-} ]]; then return 0; fi
        if ! $CHECKER $1; then return 1; fi
        shift
      done
    }

    has_detectors()
    {
      _check_multiple has_detector "$@"
    }

    has_detectors_qc()
    {
      _check_multiple has_detector_qc "$@"
    }

    has_detectors_calib()
    {
      _check_multiple has_detector_calib "$@"
    }

    has_detectors_reco()
    {
      _check_multiple has_detector_reco "$@"
    }

    has_detectors_ctf()
    {
      _check_multiple has_detector_ctf "$@"
    }

    has_detectors_flp_processing()
    {
      _check_multiple has_detector_flp_processing "$@"
    }

    has_detectors_gpu()
    {
      _check_multiple has_detector_gpu "$@"
    }

---

DOCUMENT:
    math_max()
    {
      echo $(($1 > $2 ? $1 : $2))
    }
    math_min()
    {
      echo $(($1 < $2 ? $1 : $2))
    }

    # ---------------------------------------------------------------------------------------------------------------------
    # Function to determine if root output is required for a specific process

    needs_root_output()
    {
      local NAME_PROC_ENABLE_ROOT_OUTPUT="ENABLE_ROOT_OUTPUT_${1//-/_}"
      [[ ! -z ${!NAME_PROC_ENABLE_ROOT_OUTPUT+x} ]]
    }

    # ---------------------------------------------------------------------------------------------------------------------
    # Function to include binaries in the workflow, incorporating both default and user-defined arguments

---

add_QC_from_apricot()
{
  if [[ ${EPNSYNCMODE:-0} -ne 1 ]]; then
    echo "Error fetching QC JSON $1: apricot server only set for EPNSYNCMODE == 1" 1>&2
    exit 1
  fi
  if [[ -n ${GEN_TOPO_QC_JSON_FILE:-} ]]; then
    if [[ $1 == "?" ]]; then
      curl -s -o $GEN_TOPO_QC_JSON_FILE "${GEN_TOPO_QC_APRICOT_SERVER}/${1}&process=true"
    else
      curl -s -o $GEN_TOPO_QC_JSON_FILE "${GEN_TOPO_QC_APRICOT_SERVER}/${1}?process=true"
    fi
    if [[ $? -ne 0 ]]; then
      echo "Error fetching QC JSON $1 (2)" 1>&2
      exit 1
    fi
    QC_CONFIG_ARG="json://${GEN_TOPO_QC_JSON_FILE}"
  else
    QC_CONFIG_ARG="apricot://${GEN_TOPO_QC_APRICOT_SERVER}$1"
  fi
  add_W o2-qc "--config $QC_CONFIG_ARG $2"
}

fi # functions.sh sourced

---

{
  local FACTOR_NAME="N_F_$3"
  local DETECTOR_NAME="MULTIPLICITY_FACTOR_DETECTOR_$2"
  local PROCESS_NAME="MULTIPLICITY_PROCESS_${1//-/_}"
  local PROCESS_FACTOR_NAME="MULTIPLICITY_FACTOR_PROCESS_${1//-/_}"
  local DEFAULT_NAME="N_${5:-}"
  local MULT=${!PROCESS_NAME:-$((${!FACTOR_NAME} * ${!DETECTOR_NAME:-1} * ${!PROCESS_FACTOR_NAME:-1} * ${!DEFAULT_NAME:-1}))}
  [[ ! -z ${EPN_GLOBAL_SCALING:-} && $1 != "gpu-reconstruction" ]] && MULT=$(($MULT * $EPN_GLOBAL_SCALING))
  if [[ ${GEN_TOPO_AUTOSCALE_PROCESSES_GLOBAL_WORKFLOW:-} == 1 && -z ${!PROCESS_NAME:-} && ${GEN_TOPO_AUTOSCALE_PROCESSES:-} == 1 && ($WORKFLOWMODE != "print" || ${GEN_TOPO_RUN_HOME_TEST:-} == 1) && ${4:-} != 0 ]]; then
}

---

DOCUMENT:
    has_detectors_gpu()
    {
      _check_multiple has_detector_gpu "$@"
    }

    workflow_has_parameters()
    {
      _check_multiple workflow_has_parameter "$@"
    }

    add_comma_separated()
    {
      if (( $# < 2 )); then
        echo "$# parameters received"
        echo "Function name: ${FUNCNAME} requires at least 2 parameters:"
        echo "it joins the content of the first parameter with the subsequent ones using commas. $# parameters received"
        exit 1
      fi

      for ((i = 2; i <= $#; i++ )); do
        if [[ -z ${!1:-} ]]; then
          eval $1+="${!i}"
        else
          eval $1+=",${!i}"
        fi
      done
    }

    add_semicolon_separated()
    {
      if (( $# < 2 )); then
        echo "$# parameters received"
        echo "Function name: ${FUNCNAME} requires at least 2 parameters:"
        echo "it joins the content of the first parameter with the subsequent ones using semicolons. $# parameters received"
        exit 1
      fi

      for ((i = 2; i <= $#; i++ )); do
        if [[ -z ${!1:-} ]]; then
          eval $1+="${!i}"
        else
          eval $1+=";${!i}"
        fi
      done
    }

---

#!/bin/bash

# to prevent sourcing this file multiple times
if [[ -z ${SOURCE_GUARD_FUNCTIONS:-} ]]; then
SOURCE_GUARD_FUNCTIONS=1

check_detector()
{
  [[ $WORKFLOW_DETECTORS =~ (^|,)"$1"(,|$) ]]
}

check_global_reader_clusters()
{
  [[ $WORKFLOW_DETECTORS_USE_GLOBAL_READER_CLUSTERS =~ (^|,)"$1"(,|$) ]]
}

check_global_reader_tracks()
{
  [[ $WORKFLOW_DETECTORS_USE_GLOBAL_READER_TRACKS =~ (^|,)"$1"(,|$) ]]
}

check_global_reader()
{
  check_global_reader_tracks $1 || check_global_reader_clusters $1
}

check_calib()
{
  check_detector $1 && [[ $WORKFLOW_DETECTORS_CALIB =~ (^|,)"$1"(,|$) ]]
}

check_reco()
{
  check_detector $1 && [[ $WORKFLOW_DETECTORS_RECO =~ (^|,)"$1"(,|$) ]]
}

check_ctf()
{
  check_detector $1 && [[ $WORKFLOW_DETECTORS_CTF =~ (^|,)"$1"(,|$) ]]
}

check_flp_processing()
{
  check_detector $1 && [[ $WORKFLOW_DETECTORS_FLP_PROCESSING =~ (^|,)"$1"(,|$) ]]
}

---

DOCUMENT:
    has_detector_matching()
    {
      [[ $WORKFLOW_DETECTORS_MATCHING =~ (^|,)"ALL"(,|$) ]] || [[ $WORKFLOW_DETECTORS_MATCHING =~ (^|,)"$1"(,|$) ]]
    }

    has_detector_gpu()
    {
      has_detector $1 && [[ $WORKFLOW_DETECTORS_GPU =~ (^|,)"$1"(,|$) ]]
    }

    has_secvtx_source()
    {
      [[ $SVERTEXING_SOURCES =~ (^|,)"ALL"(,|$) ]] || [[ $SVERTEXING_SOURCES =~ (^|,)"$1"(,|$) ]]
    }

    has_detector_qc()
    {
      has_detector $1 && [[ $WORKFLOW_DETECTORS_QC =~ (^|,)"$1"(,|$) ]]
    }

    has_matching_qc()
    {
      has_detector_matching $1 && [[ $WORKFLOW_DETECTORS_QC =~ (^|,)"$1"(,|$) ]]
    }

    has_pid_qc()
    {
      PIDDETECTORS=$(echo $1 | tr "-" "\n")
      for PIDDETECTOR in $PIDDETECTORS; do
        if [[ $PIDDETECTOR == "TOF" ]]; then
          (! has_detectors_reco ITS TPC TOF || ! has_detector_matching ITSTPCTOF) && return 1
        fi
        ! has_detector_qc $PIDDETECTOR && return 1
      done
      return 0
    }

    has_track_source()
    {
      [[ $TRACK_SOURCES =~ (^|,)"$1"(,|$) ]]
    }