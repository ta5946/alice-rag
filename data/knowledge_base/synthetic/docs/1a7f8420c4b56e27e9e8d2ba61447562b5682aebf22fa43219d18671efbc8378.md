## Metadata

**Document link:** https://github.com/AliceO2Group/AliceO2/blob/dev/doc/CMakeMigration.md

**Start chunk id:** 1a7f8420c4b56e27e9e8d2ba61447562b5682aebf22fa43219d18671efbc8378

## Content

```
> cd build-RelWithDebInfo
> rm -rf *
> cmake $HOME/alice/cmake/O2 -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=../install-RelWithDebInfo -DCMAKE_GENERATOR=Ninja -DALIBUILD_BASEDIR=$HOME/alice/cmake/sw/osx_x86-64
```

Use `ninja` for building and `cmake .` to trigger a rerun of CMake. Repeat the process on Mac (10.14) and CentOS7.

The tests for this step (with a failing test only on CentOS7 in Debug mode):

```
~/alice/cmake/standalone/O2/build-Debug$ ctest --progress -j32
Test project /home/aphecetche/alice/cmake/standalone/O2/build-Debug
50/85 Test #34: O2test-dplutils-RootTreeWriterWorkflow..............***Failed    2.07 sec
85/85 Test #24: O2test-detectorsbase-MatBudLUT
99% tests passed, 1 tests failed out of 85
```

---

LABEL TIME SUMMARY:
dummy      =   0.11 sec*proc (2 tests)
example    =   0.05 sec*proc (1 test)
fast       =   0.16 sec*proc (3 tests)
gpu        =   2.13 sec*proc (2 tests)
its        =   0.16 sec*proc (1 test)
mch        =   0.42 sec*proc (8 tests)
mft        =   0.16 sec*proc (1 test)
mid        =  20.33 sec*proc (5 tests)
obvious    =   0.06 sec*proc (1 test)
slow       =  14.10 sec*proc (1 test)
steer      =   3.10 sec*proc (2 tests)
tpc        =  28.64 sec*proc (10 tests)

TOTAL TEST TIME (REAL) =  23.29 sec

THE FOLLOWING TESTS FAILED:
         34 - O2test-dplutils-RootTreeWriterWorkflow (Failed)
ERRORS WHILE RUNNING CTEST
```

## TIPS

### OBTAINING THE LIST OF TARGETS

IN THE BUILD DIRECTORY, EXECUTE:

```
mkdir -p .cmake/api/v1/query/
touch .cmake/api/v1/query/codemodel-v2
```

AFTER THE CMAKE CONFIGURATION STAGE (IF USING CMAKE >= 3.14), YOU'LL RECEIVE A LIST OF JSON FILES DESCRIBING THE TARGETS IN THE REPLY SUBDIRECTORY:

---

In contrast to earlier implementations, a new `stage` directory was incorporated into the build tree, serving as the primary location for most build outputs, such as `bin`, `lib`, and `share` directories, rather than at the top-level build directory.

### External Dependencies

Third-party dependencies are managed through [dependencies/CMakeLists.txt](../dependencies/CMakeLists.txt). Typically, `find_package` commands employ the `CONFIG` mode, unless a specific use case necessitates the `MODULE` variant.
Notably:

---

All the `o2_` functions listed above require the _basename_ of a target as their initial, unnamed argument. However, the actual target name differs from this _basename_ as part of the preparation for the packaging stage. The handling of the final target name is managed by the `o2_name_target` function. Nonetheless, developers typically do not need to know the exact final name; they just need to ensure their targets are referenced as `basename` when used as the first parameter in `o2_xxx` functions or as `O2::basename` in their dependencies.

## Migration Strategy

The approach will be gradual.

1. Rewrite all primary CMakeLists.txt files to achieve a functional build, while ignoring more complex or less critical elements such as a) GPU-related features (both critical and challenging) b) testing of Root macros (challenging) c) generating a proper O2Config.cmake (related to packaging). This initial step acts as a proof-of-concept, nearly full-scale. Discuss the implementation choices during this phase.

2. Incorporate GPU/HIP/OpenCL features.

---

<!-- doxy
\page refdocModernCMakeMigration Modern CMake Migration
/doxy -->

# Transition to "Modern" CMake

## Overview

The primary goal is to eliminate the entire bucket system, which has proven to be a poor way to address the dependency issues we face in our build system.

To achieve this, the main strategy is to shift our CMake practices towards the latest recommended methods by the CMake community.

For more detailed information, refer to various online resources such as a [blog post](https://pabloariasal.github.io/2018/02/19/its-time-to-do-cmake-right/), a [video](https://www.youtube.com/watch?v=bsXLMQ6WgIk), or a [book](https://crascit.com/professional-cmake/). The fundamental concept is to base everything on **targets** and minimize the use of variables and directory-specific functions.

---

## Steps 3 and 4

The creation of the O2Config.cmake (Step 3) file is complete, prepared for use by QualityControl.

The macro testing (Step 4) is functional, but exclusively within the correct environment (i.e., within an alibuild build). Executing ctest without setting up the environment beforehand must be postponed for now, as it involves more complexity (and diverges from current practices).

[ ] Still to be completed: generation of the O2ConfigVersion.cmake file.

---

## Custom CMake Functions

All our CMake functions are located in the [cmake](../cmake) directory. Each file within this directory defines a single function. The filenames follow the [UpperCamelCase](https://en.wikipedia.org/wiki/Camel_case) convention, whereas the function names use [snake_case](https://en.wikipedia.org/wiki/Snake_case) (CMake function names are case-insensitive, but the modern convention is to use lowercase). For example, `o2_add_executable` is defined in `cmake/O2AddExecutable.cmake`. Each function is documented in its corresponding `.cmake` file.

The primary functions currently defined are:

- [o2_add_executable](../cmake/O2AddExecutable.cmake)
- [o2_add_library](../cmake/O2AddLibrary.cmake)
- [o2_add_header_only_library](../cmake/O2AddHeaderOnleLibrary.cmake)
- [o2_add_test](../cmake/O2AddTest.cmake)
- [o2_add_test_wrapper](../cmake/O2AddTestWrapper.cmake)
- [o2_target_root_dictionary](../cmake/O2TargetRootDictionary.cmake)

---

```

## Step 2

This step aims to re-enable the GPU targets. There are three versions to consider: [HIP](../GPU/GPUTracking/Base/hip), [OpenCL](../GPU/GPUTracking/Base/opencl), and CUDA (for [TPC](..GPU/GPUTracking/Base/cuda) and [ITS](../Detectors/ITSMFT/ITS/tracking/cuda)).

In the `GPUTracking` module, all AliRoot-specific references have been removed. These references need to be reinstated if required.

This step was validated on a CentOS7 server with OpenCL, HIP, and CUDA development kits installed.

Additionally, a temporary [O2RecipeAdapter](../dependencies/O2RecipeAdapter.cmake) CMake include was introduced to facilitate testing without significantly altering the existing o2 recipe and CI.

## Step 3

To ensure the O2Suite builds successfully, Step 3 involves the creation of a proper O2Config.cmake file, allowing consumer packages like QualityControl to utilize the defined targets.

## Step 3 and 4

```

---

```
> tree .cmake/api/v1/reply
├── codemodel-v2-83681dd2d17b5fde868d.json
├── index-2019-06-11T10-25-54-0072.json
├── target-O2bench-mch-segmentation3-Debug-9c692e4e44d81a3a3a92.json
├── target-O2bench-mid-clusterizer-Debug-1340ba249c9a02e67ed5.json
├── target-O2bench-mid-tracker-Debug-3e2229d129fb77d3b863.json
├── target-O2exe-alicehlt-eventsampler-device-Debug-3bd0b54283972d791f58.json
├── target-O2exe-alicehlt-runcomponent-Debug-80eb80e9623ee42d3fb2.json
├── target-O2exe-alicehlt-wrapper-device-Debug-10621b10deb5caf32c18.json
├── target-O2exe-ccdb-conditions-client-Debug-07e6fca14004fe227979.json
├── target-O2exe-ccdb-conditions-server-Debug-ab5afdf6854abca507b7.json
├── target-O2exe-ccdb-standalone-client-Debug-aaff2add767f9b354708.json

```

---

- [FindRapidJSON](../dependencies/FindRapidJSON.cmake) establishes a `RapidJSON::RapidJSON` target that corresponds to the header-only library.

---

- [FindFairRoot](../dependencies/FindFairRoot.cmake) creates imported targets to allow the use of `FairRoot::XXX` targets even if they haven't (yet) been created by FairRoot itself. This file will be removed when FairRoot completes its own CMake migration.
- [FindGeant3](../dependencies/FindGeant3.cmake), [FindGeant4](../dependencies/FindGeant4.cmake), and [Geant4VMC](../dependencies/FindGeant4VMC.cmake) provide light Find modules that add missing include paths to the imported targets defined in those MC projects, despite these projects already defining targets.
- [Findpythia](../dependencies/Findpythia.cmake) (for Pythia8) and [Findpythia6](../dependencies/Findpythia6.cmake) create imported targets for the respective libraries.
- [Findms_gsl](../dependencies/Findms_gsl.cmake) defines a `ms_gsl` target for the header-only library.

---

Since the initial CMakeLists.txt files were created a few years ago, many third-party libraries have adopted newer CMake practices, offering well-formatted `XXXConfig.cmake` files that can be utilized with `find_package(XXX)`. We should prefer these over crafting intricate `FindXXX.cmake` scripts whenever possible.

Targets are typically defined using CMake's built-in functions such as `add_library` and `add_executable`, and are further configured with functions like `target_include_directories` and `target_link_libraries`.

For a long time, we debated whether to rely solely on these native CMake functions for our builds. However, doing so would result in a significant amount of redundant code across our CMakeLists.txt files and would complicate enforcing certain standards. Therefore, we opted to continue using our custom functions, as we did in the previous build system.

In contrast to the earlier system, we have attempted to:

-

---

COMPARED TO THE PREVIOUS SYSTEM, WE ATTEMPTED:

- To adopt function and parameter names that closely resemble those of the original CMake ones, reducing confusion for those familiar with CMake
- To utilize functions exclusively rather than macros (unless necessary), ensuring parameters do not inadvertently affect the parent scope
- To minimize the use of custom variables (while recognizing that variables are not inherently bad), as most of our CMakeLists.txt can be authored without them

## Custom CMake Functions

---

As a side note, to facilitate the development of the new CMake system, we created a [o2_find_dependencies_from_alibuild](../dependencies/O2FindDependenciesFromAliBuild.cmake) function that "detects" third-party dependencies from an AliBuild installation zone. This could be useful for others, especially those using IDEs such as CLion.

### Definition of All Targets

This section of the CMakeLists.txt file primarily involves including relevant subdirectories, but there's a catch: the order is crucial! Dependencies that were previously hidden by the bucket system are now apparent.

### Testing

In the `tests` subdirectory, some setup for testing is performed. This part is still somewhat in progress, but it contains the shell scripts used for testing.

## Status at End of Step 1

The development process involved first performing a regular install of O2@dev using aliBuild. Then, switch to the `cmake-migration-step-1` branch. Create a build directory and run cmake there:

---

The key differences from the previous setup are summarized below.

### Preamble

CMake 3.13 remains the minimum required version. Although 3.14 would be beneficial, it's not essential. It's worth noting that with our planned CMake 3.15, some new generator expressions features, like [REMOVE_DUPLICATES](https://gitlab.kitware.com/cmake/cmake/issues/18210), may be useful, potentially justifying a CMake version upgrade at that time.

### Project-wide Setup

This section includes essential checks (such as prohibiting in-source builds), conducts CXX compiler feature checks, sets default build options ([details here](../cmake/O2DefineOptions.cmake)), defines output directories and RPATH settings. The `BUILD_SIMULATION` option is highlighted: currently, it's used mainly to fetch additional dependencies, but we might consider integrating all simulation-related components of O2 into an optional component in the future, though that isn't the current plan.

---

1. Incorporate GPU/HIP/OpenCL functionalities

2. Develop O2Config.cmake creation

3. Implement Root macro validation

4. Refine and resolve any remaining inconsistencies (e.g., test labeling, etc.)

## Step 1

This step involves modifying only `CMakeLists.txt` and `*.cmake` files, with source code changes restricted to essential cases. The primary [CMakeLists.txt](../CMakeLists.txt) was restructured, comprising several sections:

- preamble: basic project definition, CMake version requirements, ctest integration
- project-wide setup: C++ checks, build options, output directories, rpath configurations
- external dependencies: all `find_package` calls
- target definitions: i.e., inclusion of all sub-directories in the correct sequence
- conclusion with testing and documentation

A key change for developers is that testing (still using ctest) can now be performed directly from the build directory, eliminating the need for installation.