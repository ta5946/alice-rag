## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/MC/run/ANCHOR/2021/OCT/pass4/anchorMC.sh

**Start chunk id:** 0d5ec0993a1d83744439e52ae6fd213b882f334024ee90ef75b99859b4cbd0bb

## Content

RUNNUMBER=${ALIEN_JDL_LPMRUNNUMBER:-505673}
INTERACTIONRATE=${INTERACTIONRATE:-2000}

# obtain the asynchronous script (this needs to be adjusted)
# the script's location can be customized with a JDL option
cp ${ALIEN_JDL_ASYNCRECOSCRIPT:-$O2DPG_ROOT/DATA/production/configurations/2021/OCT/apass4/async_pass.sh} async_pass.sh
cp $O2DPG_ROOT/DATA/production/configurations/2021/OCT/${ALIEN_JDL_LPMPASSNAME:-apass4}/setenv_extra.sh .
# settings specific to MC
sed -ibak 's/GPU_global.dEdxUseFullGainMap=1;GPU_global.dEdxDisableResidualGainMap=1/GPU_global.dEdxSplineTopologyCorrFile=splines_for_dedx_V1_MC_iter0_PP.root;GPU_global.dEdxDisableTopologyPol=1;GPU_global.dEdxDisableGainMap=1;GPU_global.dEdxDisableResidualGainMap=1;GPU_global.dEdxDisableResidualGain=1/' setenv_extra.sh
chmod +x async_pass.sh

# remove the line that runs the workflow if there is no data input
[ ${CTF_TEST_FILE} ] || sed -ibak '/WORKFLOWMODE=run/d' async_pass.sh

---

remainingargs="${remainingargs} -e ${SIMENGINE} -j ${NWORKERS}"
remainingargs="${remainingargs} -productionTag ${ALIEN_JDL_LPMPRODUCTIONTAG:-alibi_anchorTest_tmp}"
remainingargs="${remainingargs} --anchor-config config-json.json"

echo "baseargs: ${baseargs}"
echo "remainingargs: ${remainingargs}"

${O2DPG_ROOT}/MC/bin/o2dpg_sim_workflow_anchored.py ${baseargs} -- ${remainingargs} &> timestampsampling.log
[ "$?" != "0" ] && echo "Issue with anchor timestamp sampling" && exit 1

TIMESTAMP=`grep "Determined timestamp to be" timestampsampling.log | awk '//{print $6}'`
echo "TIMESTAMP IS ${TIMESTAMP}"

# -- PREPARE CCDB OBJECTS ON DISK      --
# (ensure the correct objects at the specified timestamp are available
#  until https://alice.its.cern.ch/jira/browse/O2-2852 is resolved)
export ALICEO2_CCDB_LOCALCACHE=$PWD/.ccdb
[ ! -d .ccdb ] && mkdir .ccdb

---

# remove comments to configure ALIEN_JDL parameters
# if not already set
if [ ! ${ALIEN_JDL_LPMRUNNUMBER} ]; then
  sed -ibak 's/# export ALIEN/export ALIEN/' async_pass.sh
fi
# correct the typo
sed -ibak 's/JDL_ANCHORYEAR/JDL_LPMANCHORYEAR/' async_pass.sh

# set NTIMEFRAMES to xx if needed
sed -ibak 's/NTIMEFRAMES=-1/NTIMEFRAMES=1/' async_pass.sh

if [[ ! -f commonInput.tgz ]]; then
  alien.py cp /alice/cern.ch/user/a/alidaq/OCT/apass4/commonInput.tgz file:.
fi

if [[ ! -f runInput_${RUNNUMBER} ]]; then
  alien.py cp /alice/cern.ch/user/a/alidaq/OCT/apass4/runInput_${RUNNUMBER}.tgz file:.
fi

if [[ ! -f TPC_calibdEdx.220301.tgz ]]; then
  alien.py cp /alice/cern.ch/user/a/alidaq/OCT/apass4/TPC_calibdEdx.220301.tgz file:.
fi

tar -xzf TPC_calibdEdx.220301.tgz
cp calibdEdx.pol/*.root .
tar -xzf commonInput.tgz

---

DOCUMENT:
    CCDBOBJECTS="/CTP/Calib/OrbitReset /GLO/Config/GRPMagField/ /GLO/Config/GRPLHCIF /ITS/Calib/DeadMap /ITS/Calib/NoiseMap /ITS/Calib/ClusterDictionary /TPC/Calib/PadGainFull /TPC/Calib/TopologyGain /TPC/Calib/TimeGain /TPC/Calib/PadGainResidual /TPC/Config/FEEPad /TOF/Calib/Diagnostic /TOF/Calib/LHCphase /TOF/Calib/FEELIGHT /TOF/Calib/ChannelCalib /MFT/Calib/DeadMap /MFT/Calib/NoiseMap /MFT/Calib/ClusterDictionary /MFT/Calib/Align /FT0/Calibration/ChannelTimeOffset /FV0/Calibration/ChannelTimeOffset"

${O2_ROOT}/bin/o2-ccdb-downloadccdbfile --host http://alice-ccdb.cern.ch/ -p ${CCDBOBJECTS} -d .ccdb --timestamp ${TIMESTAMP}
if [ ! "$?" -eq "0" ]; then
  echo "Issue encountered during CCDB pre-fetching of ${CCDBOBJECTS}. Exiting."
  exit 1
fi

---

#!/bin/bash

#
# This script outlines a workflow for MC->RECO->AOD generation for a simple pp minimum bias scenario, tailored for test beam conditions.
#
# Additionally, it aims to validate the entire chain of anchoring mechanisms, including:
# - Incorporating reconstruction pass settings from O2DPG scripts
# - Anchoring to a specific run's timestamp to ensure correct CCDB access
# - Applying supplementary settings like vertex/beam spot, which are currently not sourced from elsewhere


# Ensure O2DPG and O2 are loaded
[ ! "${O2DPG_ROOT}" ] && echo "Error: O2DPG needs to be loaded" && exit 1
[ ! "${O2_ROOT}" ] && echo "Error: O2 needs to be loaded" && exit 1

# ------ CREATE AN MC CONFIG STARTING FROM RECO SCRIPT --------
# - This step should not be performed on the GRID; instead, point to an existing configuration in O2DPG, local storage, or other sources.

RUNNUMBER=${ALIEN_JDL_LPMRUNNUMBER:-505673}
INTERACTIONRATE=${INTERACTIONRATE:-2000}

---

DOCUMENT:
    ALIEN_JDL_LPMPRODUCTIONTAG=$ALIEN_JDL_LPMPRODUCTIONTAG_KEEP
echo "Resetting ALIEN_JDL_LPMPRODUCTIONTAG to $ALIEN_JDL_LPMPRODUCTIONTAG"

# now generate the local MC configuration file --> config-config.json
${O2DPG_ROOT}/UTILS/parse-async-WorkflowConfig.py

# ensure the configuration was created correctly
if [[ `grep "o2-ctf-reader-workflow-options" config-json.json 2> /dev/null | wc -l` == "0" ]]; then
  echo "Issue with anchor configuration. Stopping."
  exit 1
fi

# confirm the necessary input file exists
[ ! -f splines_for_dedx_V1_MC_iter0_PP.root ] && echo "TPC calibration input file missing" && exit 1

# -- CREATE THE MC JOB DESCRIPTION WITH ANCHORING TO RUN --

NWORKERS=${NWORKERS:-8}
MODULES="--skipModules ZDC"
SIMENGINE=${SIMENGINE:-TGeant4}
SIMENGINE=${ALIEN_JDL_SIMENGINE:-${SIMENGINE}}
NTIMEFRAMES=${NTIMEFRAMES:-50}
NSIGEVENTS=${NSIGEVENTS:-22}

# construct the workflow
# THIS NEEDS TO COME FROM OUTSIDE
# echo "$" | awk -F' -- ' '{print $1, $3}'

---

# -- RUN THE MC WORKLOAD TO GENERATE AOD --

export FAIRMQ_IPC_PREFIX=./

${O2DPG_ROOT}/MC/bin/o2_dpg_workflow_runner.py -f workflow.json -tt ${ALIEN_JDL_O2DPGWORKFLOWTARGET:-aod} --cpu-limit ${ALIEN_JDL_CPULIMIT:-8}
MCRC=$?  # <--- we'll report this code

if [[ "${MCRC}" -eq 0 && "${remainingargs}" == *"--include-local-qc"* ]] ; then
  # proceed with QC tasks
  echo "Executing QC"
  ${O2DPG_ROOT}/MC/bin/o2_dpg_workflow_runner.py -f workflow.json --target-labels QC --cpu-limit ${ALIEN_JDL_CPULIMIT:-8}
  RC=$?
fi

#
# compress all logs into a tar archive, irrespective of the error code or validation - to capture QC logs as well...
#
if [[ -n "$ALIEN_PROC_ID" ]]; then
  find ./ \( -name "*.log*" -o -name "*mergerlog*" -o -name "*serverlog*" -o -name "*workerlog*" \) | tar -czvf debug_log_archive.tgz -T -
fi

unset FAIRMQ_IPC_PREFIX

return ${MCRC} 2>/dev/null || exit ${MCRC}

---

# workaround to ensure o2sim_geometry.root exists when not included in the download but -aligned is
if [[ -f o2sim_geometry-aligned.root && ! -f o2sim_geometry.root ]]; then
   ln -s o2sim_geometry-aligned.root o2sim_geometry.root
fi

# generate workflow ---> produces a file that can be processed
export IGNORE_EXISTING_SHMFILES=1
touch list.list
ALIEN_JDL_LPMPRODUCTIONTAG_KEEP=$ALIEN_JDL_LPMPRODUCTIONTAG
echo "Substituting ALIEN_JDL_LPMPRODUCTIONTAG=$ALIEN_JDL_LPMPRODUCTIONTAG with ALIEN_JDL_LPMANCHORPRODUCTION=$ALIEN_JDL_LPMANCHORPRODUCTION for simulation reconstruction..."
ALIEN_JDL_LPMPRODUCTIONTAG=$ALIEN_JDL_LPMANCHORPRODUCTION
./async_pass.sh ${CTF_TEST_FILE:-""} 2&> async_pass_log.log
RECO_RC=$?
echo "Reconstruction completed with return code ${RECO_RC}"
if [ "${NO_MC}" ]; then
  return ${RECO_RC} 2>/dev/null || exit ${RECO_RC} # optionally terminate here without Monte Carlo (useful for testing)
fi

---

# create workflow
# THIS NEEDS TO COME FROM OUTSIDE
# echo "$" | awk -F' -- ' '{print $1, $3}'

baseargs="-tf ${NTIMEFRAMES} --split-id ${ALIEN_JDL_SPLITID:-1} --prod-split ${ALIEN_JDL_PRODSPLIT:-100} --run-number ${RUNNUMBER} -eCM 900 -col pp"

# THIS NEEDS TO COME FROM OUTSIDE
remainingargs="-gen pythia8 -proc cdiff -ns ${NSIGEVENTS}                                                                                                                 \
               -interactionRate ${INTERACTIONRATE}                                                                                                                        \
               -confKey \"Diamond.width[2]=6.0;Diamond.width[0]=0.01;Diamond.width[1]=0.01;Diamond.position[0]=0.0;Diamond.position[1]=-0.035;Diamond.position[2]=0.41\"  \
              --include-local-qc --include-analysis"

---

# -- Generate aligned geometry using ITS ideal alignment to prevent overlaps in geant
CCDBOBJECTS_IDEAL_MC="ITS/Calib/Align"
TIMESTAMP_IDEAL_MC=1
${O2_ROOT}/bin/o2-ccdb-downloadccdbfile --host http://alice-ccdb.cern.ch/ -p ${CCDBOBJECTS_IDEAL_MC} -d .ccdb --timestamp ${TIMESTAMP_IDEAL_MC}
if [ ! "$?" == "0" ]; then
  echo "Issue during CCDB pre-fetching of ${CCDBOBJECTS_IDEAL_MC}. Exiting."
  exit 1
fi

${O2_ROOT}/bin/o2-create-aligned-geometry-workflow --configKeyValues "HBFUtils.startTime=${TIMESTAMP}" --condition-remap=file://${ALICEO2_CCDB_LOCALCACHE}=ITS/Calib/Align,MFT/Calib/Align -b 
mkdir -p $ALICEO2_CCDB_LOCALCACHE/GLO/Config/GeometryAligned
ln -s -f $PWD/o2sim_geometry-aligned.root $ALICEO2_CCDB_LOCALCACHE/GLO/Config/GeometryAligned/snapshot.root

# -- EXECUTE THE MC TASK TO CREATE AOD --