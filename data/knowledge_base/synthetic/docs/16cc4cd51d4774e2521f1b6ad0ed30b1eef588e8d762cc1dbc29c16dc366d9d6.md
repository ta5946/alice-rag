## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/DATA/aliecs_documentation/README.md

**Start chunk id:** 16cc4cd51d4774e2521f1b6ad0ed30b1eef588e8d762cc1dbc29c16dc366d9d6

## Content

<p align="center"><img src='gui_manual.png' width=80%></p>

The panel includes the following settings:
- **Topology**: The absolute path to the topology XML file located in the EPN's shared home folder.
- **# of EPNs**: The number of EPN nodes to allocate from the *online* zone. Note that this number must correspond to the count specified in the XML file.

<hr>

# Configuration Method Using O2DPG Path
This method leverages the [O2DPG repository](../) to dynamically generate the topology, without the need for pregenerated files. It represents the "*new*" approach to configuring the workflow. This image illustrates an example in **shifter** mode, followed by a description of the two settings:

<p align="center"><img src='gui_path.png' width=80%></p>

---

<p align="center"><img src='gui_path.png' width=80%></p>

- **O2 Data Processing Path**: The full path on the EPN farm to the O2DPG repository to be utilized.
- **# of EPNs**: The number of EPN nodes to allocate from the *online* zone. This is consistent with the [manual XML file](#manual-xml-file-configuration-method) scenario. Here, a workflow is generated dynamically, and thus an automatic workflow for the specified number of EPNs is created.

For all other configuration options, refer to the [expert panel](#expert-panel).

<hr>

---

- `GPU`: Carry out the TPC reconstruction on the GPU.
  - `CTF`: Save the CTF. By default, the reconstruction process will perform CTF encoding. However, CTF encoding can be turned off by customizing the settings in the *EXTRA ENV variables* option (refer to the documentation below). To test CTF creation without saving the CTF, remove this parameter.
  - `EVENT_DISPLAY`: Generate JSONs for the event display.
- **# of compute nodes**: The count of compute nodes utilized for DPL processing. If `-1` is specified, the number of EPNs is used. If `0` is specified, the default number defined in the workflow within the topology library file is applied. This setting is required only for specific tests.

---

- **Detector list (QC)**: A comma-separated list of detectors to run quality control checks for, if the workflow parameter `QC` is activated (refer to documentation for more details). The keywords `default` and `ALL` function identically to those in *Detector list (Global)*. A detector not included in *Detector list (Global)* will not undergo any processing and consequently no EPN quality control, even if it is listed here.
- **Detector list (Calibration)**: A comma-separated list of detectors to run calibration for, if the workflow parameter `CALIB` is activated (refer to documentation for more details). It functions in exactly the same way as *Detector list (QC)*.
- **Workflow parameters**: A comma-separated list of workflow parameters. These parameters generally enable specific features within the workflow but can also represent special options. Currently, the following parameters are available:
  - `QC`: Enable EPN quality control for the detectors listed in *Detector list (QC)*.
  - `CALIB`: Enable calibration for the detectors listed in *Detector list (Calibration)*.
  - `GPU`: Perform TPC reconstruction on the GPU.

---

- **Topology description library file** (default: `production/production.desc`): Chooses the file in the DATA path of the O2DPG repository that contains the topology description for the partition. By default, the GUI employs the standard production workflow. For detector standalone tests, detectors can either opt for their own library files or continue with the default global workflow if it includes all the necessary processes. 

- **Workflow name** (default: `synchronous-workflow-1numa`): Determines the workflow name to be utilized within the topology library file. For more details, refer to [here](../README.md). Two default global workflows are provided:
  - `synchronous-workflow-1numa`: The standard production workflow that uses 4 GPUs and operates within a single NUMA domain on the EPN. Although it offers less processing power, its faster startup time makes it the current default.

---

- **Clear workflow cache**: The O2DPG workflow system caches XML files for auto-generated workflows when the configuration mode is set to *O2DPG hash*. If the same configuration is used, it reuses the cached XML, which speeds up the run start. This is feasible only if the configuration is set to *O2DPG hash*, as the topology is fully versioned and uniquely identified by the triplet [O2DPG hash, Workflow name, Topology library file]. For *O2DPG path*, the repository is not versioned and the topology is not cached. This option clears the cache; currently, it is required if the QC JSON files have been modified, as they are not yet versioned in consul.
- **Determine beam type**: The beam type is passed to the reconstruction. Eventually, this should be set automatically by AliECS, but for now, it must be specified here.

---

# AliECS PDP Workflow Configuration Guide.
Please note that this guide is specifically for the AliECS GUI; for more detailed information about the PDP workflows, refer to [this](../README.md). The PDP Workflow GUI supports two modes, which can be chosen as *panel mode*:
- A **shifter mode** designed for operators, which includes two primary settings: the number of EPN nodes and the workflow or workflow version.
- An **expert mode** that allows for intricate adjustments to the executed workflow. ([further details](#expert-panel))

The GUI can configure the workflow using three distinct methods: [Manual XML File Configuration](#manual-xml-file-configuration-method), [O2DPG path](#o2dpg-path-configuration-method), or [O2DPG hash / version](#o2dpg-hash-configuration-method). The chosen method can be set in the [expert panel](#expert-panel). Each of the three methods is elaborated upon below:

<hr>

---

<hr>

# Standard and Detector-specific Tests.
The shifter panel is straightforward, offering limited options for workflow selection. Users can configure either an XML file or the O2DPG path and version. By default, it employs the production workflow from the `production/production.desc` topology library file. To use a different library or workflow name, the expert panel is necessary. Consequently, detectors must utilize the expert panel for non-standard runs.

<hr>

# Manual XML File Setup
This setup method is primarily kept for compatibility. It is currently the default due to its use in all existing saved configurations. The workflow is not dynamically generated; instead, a pre-generated workflow from the EPN farm is utilized. The image below illustrates an example of the panel:

<p align="center"><img src='gui_manual.png' width=80%></p>

---

- **Heartbeat Frames per Time Frame**: The count of heartbeat frames within each time frame. It needs to align with the detector settings or CTP configuration. Ideally, this should be configured automatically by AliECS, but for now, it must be specified manually here.
- **EPN Partition Cleanup**: Remove outdated EPN or ODC partitions. Consult AliECS or ODC specialists for more information.

---

- `CONFIG_EXTRA_PROCESS_o2_itsmft_stf_decoder_workflow="ITSTAlpideParam.roFrameLengthInBC=891;MFTAlpideParam.roFrameLengthInBC=198"` : Configures the readout frame lengths for the ITS and MFT in terms of bunches (default values are provided). These settings can be adjusted if necessary.
 - `ARGS_EXTRA_PROCESS_o2_tpcits_match_workflow=" --ignore-bc-check "` : Disables the validation of the matched tracks based on the interaction bunch time (this is helpful if the timing calibration is not accurate).
 - `ITS_STROBE="891"`, `MFT_STROBE="198"` : Specifies the readout frame lengths for the ITS and MFT in the number of bunches (current defaults are shown).

---

- **Raw decoder multiplicity factor**: If the processing on the EPN is too slow and there is still available CPU capacity on the EPN nodes, this option (and the following two: *CTF encoder multiplicity factor* and *Reconstruction process multiplicity factor*) can increase the number of parallel raw decoder processes running on the EPN. The default number is scaled by the provided factor. It is worth noting that the workflows also support more detailed multiplicity settings (described [here](../production/README.md)), which can be configured via the *Extra ENV variables* option below.
- **CTF encoder multiplicity factor**: See *Raw decoder multiplicity factor*. This setting influences all CTF encoders rather than the raw decoders.
- **Reconstruction process multiplicity factor**: See *Raw decoder multiplicity factor*. This setting impacts all other reconstruction processes, distinct from CTF encoders or raw decoders.

---

<p align="center"><img src='gui_version.png' width=80%></p>

- **O2 Data Processing Hash**: The specific version (*commit hash* or *tag*) found in the official O2DPG repository.
- **# of EPNs**: The count of EPN nodes to be allocated from the *online* zone. This number is equivalent to that set in the [O2DPG path](#o2dpg-path-configuration-method) configuration.

For any other configuration options, refer to the [expert panel](#expert-panel).

<hr>

# Expert panel
The expert panel offers numerous additional configuration options for both methods of configuring the O2DPG repository. Some options are also available for the manual XML file method. This image illustrates the expert panel with default settings. Detailed descriptions of each option are provided below.

<p align="center"><img src='gui_expert_default.png' width=80%></p>

---

- `CONFIG_EXTRA_PROCESS_o2_gpu_reco_workflow=GPU_proc.debugLevel=1;` : Activate the GPU serialization fix to prevent random crashes.
- `CONFIG_EXTRA_PROCESS_o2_gpu_reco_workflow=TPCGasParam.DriftV=2.69;` : Set the non-default TPC VDrift for TPC tracking.
    If the DriftV parameter is changed, it must also be configured in `CONFIG_EXTRA_PROCESS_o2_primary_vertexing_workflow`, `CONFIG_EXTRA_PROCESS_o2_tpcits_match_workflow`, `CONFIG_EXTRA_PROCESS_o2_tof_matcher_workflow`, and `CONFIG_EXTRA_PROCESS_o2_trd_global_tracking`.

---

- **Detector list (Global)**: A comma-separated list of detectors utilized in the DPL workflow for processing. If set to `default`, the list is automatically generated by AliECS based on the detectors in the partition. Should the list include detectors not present in the partition, synchronous reconstruction for these detectors will initiate but will only process empty dummy data, suitable for testing purposes. If the list has fewer detectors than those in the partition, processing for the missing detectors will be entirely disabled. When the *TF Builder mode* is configured as `disk` or `processing-disk`, raw TFs for these detectors will still be stored, but they will not be included in the CTF. The term `ALL` can denote all ALICE detectors, including those outside the partition.

---

- **Additional ENV variables**: This free text field allows for providing extra custom options to the DPL workflow. The syntax is `OPTION_NAME='OPTION_VALUE'`, with optional single quotes if needed, and multiple options can be specified in a space-separated format. For a complete list of available options, refer to [here](../production/README.md). An example includes `WORKFLOW_DETECTORS_MATCHING='ITS-TPC,ITS-TPC-TRD' WORKFLOW_DETECTORS_FLP_PROCESSING=TOF WORKFLOW_DETECTORS_CTF=NONE`.

---

- **TF Builder mode** (default: `processing`): This determines the DataDistribution TfBuilder mode, with four supported options: `processing`, `processing-disk`, `discard`, and `disk`. The default setting is `processing`. For `processing-disk`, which includes raw TF storage, the `production/no-processing.desc` topology library file and `no-processing` workflow name are required. 
- **discard**: TfBuilder creates the time frame on the EPN but immediately discards it without storing or further processing.
- **disk**: The raw time frame is saved to disk, with no additional processing.
- **processing**: Time frames are constructed and forwarded to DPL for processing. The raw time frame is not saved. The CTF may be stored based on the DPL workflow configuration (refer to *Workflow parameters*).
- **processing-disk**: This mode combines `disk` and `processing`: Time frames are built, raw TFs are stored to disk, and DPL processing is active.

---

- `CONFIG_EXTRA_PROCESS_o2_its_reco_workflow=ITSCATrackerParam.sysErrY2[0]=9e-4;ITSCATrackerParam.sysErrZ2[0]=9e-4;ITSCATrackerParam.sysErrY2[1]=9e-4;ITSCATrackerParam.sysErrZ2[1]=9e-4;ITSCATrackerParam.sysErrY2[2]=9e-4;ITSCATrackerParam.sysErrZ2[2]=9e-4;ITSCATrackerParam.sysErrY2[3]=1e-2;ITSCATrackerParam.sysErrZ2[3]=1e-2;ITSCATrackerParam.sysErrY2[4]=1e-2;ITSCATrackerParam.sysErrZ2[4]=1e-2;ITSCATrackerParam.sysErrY2[5]=1e-2;ITSCATrackerParam.sysErrZ2[5]=1e-2;ITSCATrackerParam.sysErrY2[6]=1e-2;ITSCATrackerParam.sysErrZ2[6]=1e-2` : incorporates additional systematic errors into ITS clusters to address potential misalignment
If these adjustments are made, it is recommended to apply them similarly in `CONFIG_EXTRA_PROCESS_o2_tof_matcher_workflow`, `CONFIG_EXTRA_PROCESS_o2_tpcits_match_workflow`, and `CONFIG_EXTRA_PROCESS_o2_trd_global_tracking` where ITS refitting occurs.

---

The example below illustrates a screenshot of the expert panel with certain custom options highlighted.

<p align="center"><img src='gui_expert_example.png' width=80%></p>

# Additional Environment Variables
This part lists the pertinent `Extra ENV Variables` to be utilized in the AliECS GUI. If multiple settings are required for the `CONFIG_EXTRA_PROCESS_XXX` or `ARGS_EXTRA_PROCESS_XXX` of the same workflow `XXX`, they should be combined using `;` or a space.

---

<hr>

# O2DPG hash configuration method
This is largely the same as the [O2DPG path](#o2dpg-path-configuration-method) method, with the key difference being the specification of a repository version rather than the path to the repository on the EPN farm. This ensures correct versioning and reproducibility. Unlike the [O2DPG path](#o2dpg-path-configuration-method) method, which can generate topologies from any private O2DPG fork on the EPN farm, the **O2DPG hash** method is limited to workflows that are checked into the official [O2DPG/DATA](../) repository. The referenced version can be either a commit or a tag. Tags are used for official tagged versions of the production workflow, whereas detectors can use commit hashes for standalone runs without needing to create or wait for an official tag. This method will become the default when the workflows have stabilized and no longer change on a daily basis. In the following screenshot, the *tag* `v0.20` is selected:

---

- **Resources** (default: `default`): The ODC resources to be utilized for the partition. If set to `default`, which is the default value, the ODC resources will be requested automatically based on the setting in *# of EPNs*. Alternatively, a manual request can be made, for example, `{"zone": "online", "n": "10"}` to request 10 nodes from the `online` zone, or `[ {"zone": "online", "n": "10"}, {"zone": "calib", "n": "1"} ]` to request 1 additional node from the `calib` zone.
- **Data Distribution mode** (default: `physics`): By default, `physics` mode should be used. Other modes are required for specific cases. Consult the EPN experts for more details.

---

- **Number of EPNs** (also viewable in shifter mode): This setting determines the default number of EPNs used for partitioning. However, it can be overridden by other settings such as **Resources** and **Number of compute nodes**. When these other settings are at their default, the **Number of EPNs** controls the exclusive number of EPNs utilized.
- **Workflow configuration mode**: This feature enables switching between the *Manual XML file* mode, *O2DPG path* mode, and *O2DPG hash* mode.
- **O2DPG Path** (also accessible in shifter view): When the workflow configuration mode is set to *O2DPG path*, this field becomes visible for selecting the DATA path of the O2DPG repository.

---

- `synchronous-workflow`: Utilizes all 8 GPUs and both NUMA domains of the EPN for production workflow. Offers maximum processing power but suffers from a notably extended start-of-run time, which is why it’s not enabled by default at present. It will be required for Pb-Pb runs.