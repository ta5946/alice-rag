## Metadata

**Document link:** https://github.com/AliceO2Group/AliceO2/blob/dev/Detectors/TPC/calibration/doc/CalibPadGainTracks.md

**Start chunk id:** 4ef0dbd527f832dcb608639cc4a25a1b8d63caf91154ffc71a5d7d0ef0a42f88

## Content

Track cuts:
--momMin            Minimum momentum for tracks
--momMax            Maximum momentum for tracks
--etaMax            Maximum eta for tracks
--minClusters       Minimum number of clusters per track

Additional settings:
--field             Magnetic field strength in kG, required for track propagation, this will be overridden if a grp file is available
--debug             Output debug files when objects are processed
--publish-after-tfs Number of TFs before sending pad-by-pad histograms

The `o2-tpc-calibrator-gainmap-tracks` workflow should be executed on an aggregation node. It utilizes pad-by-pad histograms provided by `o2-tpc-calib-gainmap-tracks` to generate a pad-by-pad residual gainmap for each time slot. The following options are available:

```
--tf-per-slot   Number of TFs per calibration slot
--max-delay     Number of past slots to include
```

---

To simulate the EPN/Agregation node topology, follow these steps:

For the Aggregator:

```
o2-dpl-raw-proxy --dataspec A:TPC/TRACKGAINHISTOS/0 --channel-config "name=readout-proxy,type=pull,method=bind,address=tcp://localhost:30453,rateLogging=1,transport=zeromq" \
| o2-tpc-calibrator-gainmap-tracks --ccdb-uri "http://localhost:8080" --min-entries 0 --tf-per-slot 100
```

For the EPN, run the `o2-tpc-calib-gainmap-tracks` workflow in a separate shell:

```
o2-tpc-file-reader --input-type "clusters,tracks" --disable-mc \
| o2-tpc-calib-gainmap-tracks --publish-after-tfs 100 --overflowBin true --condition-tf-per-query -1 \
| o2-dpl-output-proxy --channel-config "name=downstream,method=connect,address=tcp://localhost:30453,type=push,transport=zeromq" --dataspec downstream:TPC/TRACKGAINHISTOS -b
```

---

<!-- doxy
\page refTPCcalibrationCalibPadGainTracks Residual gainmap calibration
/doxy -->

# Residual Gainmap Calibration Workflow
The workflow `o2-tpc-calib-gainmap-tracks` operates on EPNs. It normalizes the cluster charge qMax to the dE/dx of the track and stores this for each pad in a histogram. This process requires tracks and clusters, which can be supplied by the `o2-tpc-file-reader` workflow. Configuration for the histograms and track cuts can be adjusted using these command-line options:


```
Histogram configuration:
--nBins             Number of histogram bins
--reldEdxMin        Minimum x-coordinate for the Q/(dE/dx) binning
--reldEdxMax        Maximum x-coordinate for the Q/(dE/dx) binning
--underflowBin      Enable underflow bin usage
--overflowBin       Enable overflow bin usage
--useEveryNthTF     Use only every nth timestamp frame (TF)
```

---

---
--min-entries   Minimum count of entries needed per pad-by-pad histogram.
--lowTrunc      Lower boundary for the range used in residual gain calculation from the pad-by-pad histogram.
--upTrunc       Upper boundary for the range used in residual gain calculation from the pad-by-pad histogram.

--file-dump     Save the calibration class object to a file.
```

## Execution

The complete process for extracting the residual gainmap can be run as follows:

```
o2-tpc-file-reader --input-type "clusters,tracks" --disable-mc \
| o2-tpc-calib-gainmap-tracks --publish-after-tfs 100 --overflowBin true --condition-tf-per-query -1 --debug true \
| o2-tpc-calibrator-gainmap-tracks --min-entries 0 --tf-per-slot 100 --file-dump true --shm-segment-size 100000000000 -b
```


## Simulating the EPN Workflow

To simulate the EPN/Agregation node topology, one can execute the following:

For the Aggregator: