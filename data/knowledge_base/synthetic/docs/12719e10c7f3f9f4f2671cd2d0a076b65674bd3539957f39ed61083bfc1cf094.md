## Metadata

**Document link:** https://github.com/AliceO2Group/AliceO2/blob/dev/run/SimExamples/TParticle/README.md

**Start chunk id:** 12719e10c7f3f9f4f2671cd2d0a076b65674bd3539957f39ed61083bfc1cf094

## Content

Then we can write the script `MyEG.macro` (full code) as follows:

```cpp
void MyEG(Int_t nev, const TString& out, Int_t every=1)
{
  MyGenerator* eg = new MyGenerator();
  eg->Initialize(2212, 2212, 5200);

  MySteer steer(eg, out, every);
  steer.run(nev);
}
```

And a straightforward shell script `myeg.sh` to pass arguments to `MyEG.macro`:

```sh
#!/bin/sh

nev=1
out=particles.root

while test $# -gt 0 ; do
    case $1 in
    -n) nev=$2 ; shift ;;
    -o) out=$2 ; shift ;;
    *) ;;
    esac
    shift
done

root -l MyEG.macro -- $nev \"$out\"
```

Using these, we can execute:

```sh
o2-sim -g tgenerator --configKeyValues "GeneratorFileOrCmd.cmd=./myeg.sh"
```

to generate events using our custom generator `MyGenerator`.

### Implementation Details

Internally, `GeneratorTParticle`:

1. generates a unique temporary file name in the working directory,
2. constructs a command line, such as:

      eg options -o temporary-name &

---

Refer to the script `child.sh` for more details, by running:

    ./child.sh --help

As for the program `eg`, it has certain requirements that must be met.

---

If a program fails to meet these requirements, it will usually be straightforward to create a simple wrapper script to ensure compliance.

### Configurations

Same as above.

### Example EG

The child-process feature enables us to utilize almost any EG that provides a `TGenerator` interface without integrating it into O2. Assume we have developed the class `MyGenerator` to generate events.

```cpp
class MyGenerator : public TGenerator {
public:
  MyGenerator();
  void Initialize(Long_t projectile, Long_t target, Double_t sqrts);
  void GenerateEvent();
  Int_t ImportParticles(TClonesArray* particles, Option_t* option = "");
};
```

and a steering class.

---

Therefore, as long as the generator adheres to the established convention, we can also include supplementary data (such as impact parameter, Npart, etc.) from the input files alongside the particle data.

---

./myeg.sh --help

for a list of options.

### Configurations

- The `TTree` name to read can be specified via the configuration key `GeneratorTParticle.treeName`, with `T` as the default.
- The `TBranch` name containing the `TClonesArray` of `TParticle` objects can be configured using the key `GeneratorTParticle.branchName`, with `Particles` as the default.

For example,

    o2-sim -g tparticle --configKeyValues "GeneratorFileOrCmd.fileNames=particles.root;GeneratorTParticle.treeName=Events;GeneratorTParticle.branchName=Tracks"  ...

## Generating TParticle events from a child process

`GeneratorTParticle` is not limited to reading events from a file; it can also start a child EG to generate events. If you have an EG named `eg` that writes `TParticle` event records to a file, you can run a simulation using this external EG with the command

    o2-sim -g tgenerator --configKeyValues "GeneratorFileOrCmd.cmd=eg"

For further details, see also the script `child.sh`.

---

The maximum impact parameter (in Fermi-metres) sampled is controlled by the configuration key `GeneratorFileOrCmd.bMaxSwitch`. It defaults to `-b`. Therefore, when using the EG application, specifying the command line argument `-b 10` instructs the application to generate events with an impact parameter ranging from 0fm to 10fm.

---

The command line build process will now use the following format:

> _commandLine_ _nEventsSwitch_ _nEvents_ _seedSwitch_ _seed_
> _bMaxSwitch_ _bMax_ _outputSwitch_ _output_ _backgroundSwitch_

If any of the `Switch` parameters are left empty or set to `none`, the corresponding option will not be included in the command line. For instance, if _bMaxSwitch_ is left empty, the resulting command line will be:

> _commandLine_ _nEventsSwitch_ _nEvents_ _seedSwitch_ _seed_
> _outputSwitch_ _output_ _backgroundSwitch_


## TODO

### Header Information

The `GeneratorTParticle` class will accept a parameter named `headerName`, which specifies a branch that contains header information. Within this branch, the class will look for leaves (`TLeaf`) that correspond to standard header information keys (refer to `o2::dataformats::MCInfoKeys`). If any of these leaves are found, the corresponding keys will be set on the generated event header.

---

struct MySteer {
  TGenerator*   generator;
  TFile*        file;
  TTree*        tree;
  TClonesArray* particles;
  Int_t         flushEvery;
  MySteer(TGenerator* generator,
          const TString& output,
          Int_t flushEvery)
    : generator(generator),
      file(TFile::Open(output,"RECREATE")),
      tree("T","Particle tree"),
      particles(new TClonesArray("TParticle")),
      flushEvery(flushEvery)
  {
    tree->SetDirectory(file);
    tree->Branch("Particles",&particles);
  }
  ~MySteer() { close(); }
  void event() {
    particles->Clear();
    generator->GenerateEvent();
    generator->ImportParticles(particles);
    tree->Fill();
  }
  void sync() {
    tree->AutoSave("SaveSelf FlushBaskets Overwrite");
  }
  void run(Int_t nev) {
    for (Int_t iev = 0; iev < nev; iev++) {
      event();

}

---

- `GeneratorFileOrCmd.outputSwitch=switch` (default `>`), which is used to define the output file. If not specified, the default `>` indicates that the program outputs events exclusively to standard output.

- `GeneratorFileOrCmd.seedSwitch=switch` (default `-s`) to set the random number generator seed. This value is determined by the `o2-sim` option `--seed`.

- `GeneratorFileOrCmd.bMaxSwitch=switch` (default `-b`) to set the maximum impact parameter. The value for this is derived from the `o2-sim` option `--bMax`.

- `GeneratorFileOrCmd.nEventsSwitch=switch` (default `-n`) to define the number of events to generate. This value is controlled by the `o2-sim` options `--nEvents` or `-n`.

- `GeneratorFileOrCmd.backgroundSwitch=switch` (default `&`) to indicate how the program should run in the background. Generally, this should be `&`, but the program might also fork to the background on its own.

The command-line construction will now appear as:

---

- The EG program is required to write HepMC event structures to a designated file. The specified option for this action can be set using the configuration key `GeneratorFileOrCmd.outputSwitch`, which has a default value of `-o`.
- It is mandatory for the program to allow setting the number of events to generate via a command-line option. This is managed by the configuration key `GeneratorFileOrCmd.nEventsSwitch` with a default value of `-n`. Therefore, the EG application should recognize `-n 10` to indicate that 10 events should be generated.
- The EG application must include an option to set the random number generator seed through a command-line switch. This setting is controlled by the configuration key `GeneratorFileOrCmd.seedSwitch` with a default value of `-s`. Consequently, the EG application needs to accept `-s 123456` to specify that the random number seed should be set to 123456.
- The EG application should provide a command-line switch to define the maximum impact parameter (in Fermi-metres) that is sampled.

---

void process_events(Int_t nev) {
   for (Int_t event_index = 0; event_index < nev; event_index++) {
     generate_event();
     if (flushInterval > 0 && (event_index % flushInterval == 0) && event_index != 0)
       synchronize();
   }
}

void finalize() {
  if (!file) return;
  file->Write();
  file->Close();
  file = nullptr;
}

---

Here are guidelines for utilizing `GeneratorTParticle`, selected via the `-g tparticle` option, for `o2-sim`.

## Loading TParticle Files

`GeneratorTParticle` is capable of reading events from a ROOT file that contains a `TTree` with a branch holding a `TClonesArray` of `TParticle` objects. Such files can be generated by an independent event generator program (EG).

To initiate a simulation that reads from the file `particles.root`, execute:

    o2-sim -g tparticle --configKeyValues "GeneratorFileOrCmd.fileNames=particles.root"  ...

Refer to the script `read.sh` for additional information. Run

    ./read.sh --help

to view the available options. This script assumes an input file with a `TTree` that contains a single `TBranch` holding a `TClonesArray` of `TParticle` objects. An example file can be created using `myeg.sh`. Execute

    ./myeg.sh --help

to see the options available for this script.

### Configuration Settings

---

---

EXAMPLE COMMAND -o temporary-name &

3. then runs that command line

## Future Enhancements

The `GeneratorTParticle` (and sister generator `GeneratorHepMC`) can be configured using `--configKeyValues` settings:

- `GeneratorTParticle.treeName=name` defines the name of the `TTree` in the input files.

- `GeneratorTParticle.branchName=name` specifies the name of the `TBranch` within the `TTree` that contains the `TClonesArray` of `TParticle` objects.

- `GeneratorFileOrCmd.fileNames=list` lists the HepMC files to read as a comma-separated string.

- `GeneratorFileOrCmd.cmd=command line` allows execution of a command line as a background child process. If this is specified (not an empty string), `GeneratorFileOrCmd.fileNames` is disregarded.

- Several keys are used to specify command line option switches for the child program. If any of these keys are set to the empty string or the special value `none`, the corresponding switch and option value are not passed to the child program.