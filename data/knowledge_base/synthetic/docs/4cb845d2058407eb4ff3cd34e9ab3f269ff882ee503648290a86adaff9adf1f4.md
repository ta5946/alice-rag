## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/MC/README.md

**Start chunk id:** 4cb845d2058407eb4ff3cd34e9ab3f269ff882ee503648290a86adaff9adf1f4

## Content

5. Open the `o2dpg_qc_finalization_workflow.py` script and locate the `include_all_QC_finalization` function.

This ensures that the subsequent QC steps (Checks, Aggregators, uploading to QCDB) are executed after all TimeFrames have been processed.
Follow the example to add your own QC task. Use the same task name and configuration file as in the previous step.
```
def include_all_QC_finalization(ntimeframes, standalone):
  ...
  add_QC_finalization('vertexQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/vertexing-qc-direct-mc.json')

```

6. Remove the files created by the workflow from step 2 and rerun the `O2DPG_pp_minbias.sh` script.
Ensure that your QC task completes successfully.
To run only the necessary parts of the workflow for your QC task, use the `-tt <task_name>_finalize` flag with `o2_dpg_workflow_runner.py`.
Logs for the tasks are found in their respective working directories: tf<n> for TimeFrame processing and QC during finalization.

---

# O2DPG - Monte Carlo Simulation

Within this directory structure, the scripts and configurations for running Monte Carlo simulations of the ALICE experiment within the O2 project are located.

## Integrating a New QC Task into the Simulation Script

Below are the steps to incorporate a new QC Task into the main simulation, reconstruction, and QC workflow.

1. Build O2, QualityControl, O2Physics, and O2DPG with `o2` defaults:
```
aliBuild build O2 QualityControl O2Physics O2DPG --defaults o2 -j <jobs>
```

---

4. Within `o2dpg_sim_workflow.py`, locate the main loop iterating over simulated TimeFrames and the Quality Control (QC) section.

Add your QC following the example shown below, and refer to the explanation of specific lines for further details.
```
for tf in range(1, NTIMEFRAMES + 1):
  ...
  if includeFullQC or includeLocalQC:
    ...
    ### Primary vertex
    addQCPerTF(taskName='vertexQC',
               needs=[PVFINDERtask['name']], # specifies tasks that must run prior to this QC workflow, ensuring relevant results are available
               readerCommand='o2-primary-vertex-reader-workflow', # defines the command used to read input files, followed by the o2-qc workflow
               configFilePath='json://${O2DPG_ROOT}/MC/config/QC/json/vertexing-qc-direct-mc.json') # path to the QC configuration file
```
The code snippet above ensures that the QC task is executed for each simulated and reconstructed timeframe individually. The intermediate results are stored and combined into a single file within the `QC` directory.

---

2. (Optional) Verify the setup by loading the environment and executing the example script. This script runs a sequence of tasks, typically DPL workflows that are interdependent and store processing results in ROOT files. It simulates 3 TimeFrames, reconstructs them, and performs quality checks. The relevant files are generated in the current directory, and QC objects are uploaded to QCDB. 
```
alienv enter O2/latest O2Physics/latest QualityControl/latest O2DPG/latest
cd MC/run/examples
./O2DPG_pp_minbias.sh
```
If the script fails, contact the repository maintainers. Occasionally, an intermittent issue may arise, so it is advisable to rerun the script, which will resume from the most recent failed task.

---

3. Create a QC configuration file for your Task.
Ensure that you include the following default parameters in the Activity section:
```
     "Activity": {
       ...
       "provenance": "qc_mc",
       "passName": "passMC",
       "periodName": "SimChallenge"
     },
```
As future developments may require, these parameters will be overridden with production-specific values.
Given that processing time is not a critical factor, data sampling can be avoided in most cases, and direct data sources can be used (refer to the QC documentation).

Place the file in the MC/config/QC/json directory or ensure it is included in the QC package.

---

7. Request Catalin to include the QC results file in the list of merged files on Grid productions. The file name is identical to `taskName` but with a `.root` extension. If the `taskName` is updated, please inform Catalin as well.

## Incorporating QC Post-processing Tasks into the Simulation Script

A QC post-processing workflow can be run as the final stage of the QC process.
To implement this, please follow the instructions below.

1. Similar to the steps outlined in the previous section (1-3), ensure that the workflow can be executed without changes. Create a QC config file, and correctly fill in the `Activity` section. Be sure to configure the appropriate triggers in the post-processing task; for examples, see the [QC documentation](https://github.com/AliceO2Group/QualityControl/blob/master/doc/PostProcessing.md#more-examples). Typically, either `ForEachObject` or `ForEachLatest` triggers will be required.

2. Locate the `include_all_QC_finalization` function in `o2dpg_qc_finalization_workflow.py`.

---

2. In `o2dpg_qc_finalization_workflow.py`, locate the `include_all_QC_finalization` function.

Add your QC post-processing workflow using the `add_QC_postprocessing` function within this function. Refer to the in-code documentation for detailed explanation of the arguments and follow the existing examples. Ensure you correctly set the `needs` to execute the post-processing workflow only after the necessary QC objects are present in the QCDB.

3. Remove the files produced by the workflow from the previous steps and re-run the `O2DPG_pp_minbias.sh` script. Confirm that the QC post-processing workflow completes successfully. You can run specific parts of the workflow needed for your QC task by appending `-tt <task_name>_finalize` to `o2_dpg_workflow_runner.py`. Relevant logs can be found under the task names in the `QC` directory.