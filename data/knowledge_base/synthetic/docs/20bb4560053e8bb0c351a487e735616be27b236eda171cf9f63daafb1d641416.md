## Metadata

**Document link:** https://github.com/AliceO2Group/AliceO2/blob/dev/run/SimExamples/HepMC_EPOS4/README.md

**Start chunk id:** 20bb4560053e8bb0c351a487e735616be27b236eda171cf9f63daafb1d641416

## Content

## epos.sh

This script can be executed independently to produce an .hepmc file or output HepMC results to the console. However, it is essential to ensure that EPOS4 is loaded (via cvmfs through AliGenerators or O2sim) or installed. To direct the output to a file, the user can use:
```
./epos.sh -i test -s 234345 > test.hepmc
```
This command demonstrates all the script's functionalities, similar to those found in the generation steering scripts. Specifically, the `-i` parameter enables the provision of .optns parameters to EPOS4, while `-s` supplies the generator with a user-defined seed. The HepMC data will be saved in test.hepmc due to stdout redirection. This redirection works because epos.sh automatically sets the `-hepstd` flag, and the `set ihepmc 2` option in the option file must be activated for this to function correctly. Otherwise, either an hepmc file will be generated (if ihepmc is 1) or no data will be produced (if ihepmc is neither 1 nor 2).

---

The guide for using EPOS4 within the O2 framework is detailed in this brief manual. For a comprehensive explanation of the HepMC(3) data processing, refer to the HepMC_fifo directory within the MC examples. The scripts utilize the `cmd` parameter in `GeneratorHepMC` to initiate EPOS4 generation through the `epos.sh` script.

EPOS 4.0.0 relies on the older HepMC2 libraries, necessitating their specification in the generator's steering scripts. Omitting `HepMC.version=2` will render the scripts ineffective. Consequently, any alteration to the configurations without a thorough understanding may disrupt the balance. On the other hand, both EPOS 4.0.3 and EPOS4HQ use HepMC3, automatically updating the version when these generators are employed.

# Script Overview

---

It is crucial to recognize that using an empty/null seed in the generator can cause EPOS4 to crash, hence a safeguard was incorporated in our steering epos.sh script to generate a random number when 0 is specified.

## runo2sim.sh, rundpg.sh, and rundpl.sh

These three scripts share minor differences, particularly in their initial sections, and will be discussed together. They function after loading any O2sim version from and including the 20/09/2024, as several modifications were necessary to enable the simultaneous loading of both O2sim and EPOS4.

---

In this scenario, the options file is duplicated within each tf$n folder to ensure the epos script can operate with multiple timeframes. For o2sim and DPG scripts, a random seed is directly specified, whereas with DPL, this is impractical because the --seed option cannot influence GeneratorHepMC. Therefore, epos.sh is assigned a default seed of 0, which then produces a random number.

The scripts now diverge as follows:

- **runo2sim.sh** &rarr; initiates the o2-sim process
- **rundpg.sh** &rarr; first runs the o2dpg_sim_workflow.py to create the json configuration, then starts the workflow with o2_dpg_workflow_runner.py
- **rundpl.sh** &rarr; executes o2-sim-dpl-eventgen, feeding its output to o2-sim-mctracks-to-aod and subsequently to o2-analysis-mctracks-to-aod-simple-task

---

If no parameters are specified in the scripts, they will operate with default settings (energy and number of events defined in the example.optns file), but several flags can modify the generation parameters:
- **-m , --more** &rarr; supplies the simulation with detailed parameters via configuration key flags
- **-n , --nevents** &rarr; alters the event count in the .optns file or uses the count from the file if none is provided
- **-i , --input** &rarr; specifies the .optns filename for EPOS4 input, omitting the file extension
- **-j , --jobs** &rarr; determines the number of worker processes
- **-hq** &rarr; activates EPOS4HQ generation
- **-h , --help** &rarr; displays usage instructions
- **-e , --ecm** &rarr; sets the center-of-mass energy in the options file

In the `rundpg.sh` script, an extra flag is available
- **-t , --tf** &rarr; defines the number of timeframes to generate

---

At the end of the scripts, o2-sim, DPG workflow creator/runner, and DPL software are executed, allowing users to modify this section according to their needs. It's crucial not to remove the configuration keys `GeneratorFileOrCmd.cmd=$cmd -i $optns;GeneratorFileOrCmd.bMaxSwitch=none$HEPMC;`, and it's advisable to use the -m flag for additional configurations. EPOS4 does not support setting a maximum impact parameter, so it's preferable to keep the bMaxSwitch at none, whereas the other keys ensure the generator runs successfully with auto-generated FIFOs.

---

# Scripts Description

Four scripts are available for running the simulations:
- **epos.sh** &rarr; initiates the EPOS4 generation process
- **runo2sim.sh** &rarr; enables the creation of events using o2-sim
- **rundpg.sh** &rarr; initiates the DPG machinery for event generation
- **rundpl.sh** &rarr; starts event generation with DPL

An example.optns file is also provided to begin EPOS4, and additional options can be found in the generator example folder or on the website [epos4learn.web.cern.ch](https://epos4learn.docs.cern.ch/), which offers an extensive tutorial on the generator.