## Metadata

**Document link:** https://github.com/AliceO2Group/simulation/blob/main/docs/o2dpgworkflow/anchored.md

**Start chunk id:** 0d906d23b7a794ad6172a9479ed7b9f626291e03ae2977c1d77650ea22960c60

## Content

| `SEED` | no | `${ALIEN_PROC_ID:-1}` | Used to seed the simulation. |
| `SPLITID` | yes | | Select the split to simulate, which corresponds to a specific timestamp within a run. SPLITID ranges from 1 to PRODSPLIT. See [terminology](#run-an-anchored-simulation) above. |
| `PRODSPLIT` | yes | | Indicates the total number of MC jobs in this production, equally distributed throughout the run. See [terminology](#run-an-anchored-simulation) above. |
| `CYCLE` | no | 0 | Specify the cycle to be simulated. Defaults to 0. See [terminology](#run-an-anchored-simulation) above. |
| `NTIMEFRAMES` | yes | | Determines the number of timeframes to be simulated for this split. |
| `NSIGEVENTS` | no | 10000 | Sets the upper limit for the number of signal events to simulate per timeframe. The actual number of events is recalculated based on the interaction rate determined for this split. |

---

| `ALIEN_JDL_MC_ORBITS_PER_TF` | no | *empty* | Configure the timeframe length in orbits (or use the default from GRPECS). |
| `ALIEN_JDL_RUN_TIME_SPAN_FILE` | no | *empty* | Specify the file name with periods of bad/good data taking (same as in asynchronous reconstruction). |
| `ALIEN_JDL_INVERT_IRFRAME_SELECTION` | no | *empty* | When enabled, inverts the selection based on the ALIEN_JDL_RUN_TIME_SPAN_FILE. |
| `ALIEN_JDL_O2DPGWORKFLOWTARGET` | no | "aod" | Define the target task for the O2DPG MC workflow, up to which the workflow will be executed. Refer to workflow.json for available tasks. |
| `ALIEN_JDL_O2DPG_ASYNC_RECO_TAG` | no | *empty* | Identify the software package for running reconstruction steps and configuration setup (e.g., O2PDPSuite::async-async-20240229.pp.2b-slc9-alidist-O2PDPSuite-daily-20231208-0100-async1-1). |
| `ALIEN_JDL_CCDB_CONDITION_NOT_AFTER` | no | *empty* | Set the condition_not_after timestamp for CCDB queries (to ensure objects with a state before that timestamp are fetched). |

---

| Variable | Required | Default | Comments |
| -------- | -------- | ------- | -------- |
| `ALIEN_JDL_LPMANCHORPASSNAME` | yes | | Identifies the reconstruction pass/cycle for setting reconstruction parameters, e.g., apass4 |
| `ALIEN_JDL_MCANCHOR` | yes | | | 
| `ALIEN_JDL_LPMRUNNUMBER` | yes | | The ALICE run number that this MC job is associated with. |
| `ALIEN_JDL_LPMANCHORRUN` | yes | | | 
| `ALIEN_JDL_LPMPRODUCTIONTAG` | yes | | The name of this MC production on the ALICE Grid. |
| `ALIEN_JDL_LPMANCHORPRODUCTION` | yes | | | 
| `ALIEN_JDL_LPMANCHORYEAR` | yes | | The data taking year corresponding to this job. |
| `ALIEN_JDL_LPMPRODUCTIONTYPE` | yes | | Must be set to `MC`. Currently, it needs to be manually set, but it is planned to make it default to `MC` and no longer configurable. |
| `ALIEN_JDL_LPMINTERACTIONTYPE` | yes | | Specifies the interaction type, choose between `pp` or `PbPb`. |

---

ONE ANCHORED SIMULATION RUN CORRESPONDS TO A PARTICULAR `CYCLE` OF A `SPLITID` AND COMPRISSES A SPECIFIED NUMBER OF TIMEFRAMES AS SHOWN BY THE LARGE BLUE BOX IN THE LOWER RIGHT CORNER.
A COMPLETE `RUN` IS CONSIDERED FINISHED WHEN ALL `CYCLES` FOR EVERY `SPLITID` HAVE BEEN GENERATED.

THERE ARE TWO EXAMPLES OF ANCHORED SIMULATIONS:

* [PbPb](https://github.com/AliceO2Group/O2DPG/blob/master/MC/run/ANCHOR/tests/test_anchor_2023_apass2_PbPb.sh),
* [pp](https://github.com/AliceO2Group/O2DPG/blob/master/MC/run/ANCHOR/tests/test_anchor_2023_apass2_pp.sh).

ALTHOUGH NOT IMPLEMENTED IN THE SCRIPTS MENTIONED, THE ENVIRONMENT VARIABLE `ALIEN_JDL_ANCHOR_SIM_OPTIONS` CAN BE USED TO EXECUTE AN `EXTERNAL` GENERATOR CONFIGURED VIA AN `INI` FILE. THIS CAN BE ACCOMPLISHED BY ADDING THE FOLLOWING TO YOUR ENVIRONMENT:
```bash
export ALIEN_JDL_ANCHOR_SIM_OPTIONS="-gen external -ini <path/to/config.ini>"
```

## PRE- AND POST-PROCESSING STEPS, SPECIAL CONFIGURATIONS

---

| `ALIEN_JDL_LPMINTERACTIONTYPE` | yes | | The interaction type, select either `pp` or `PbPb`. |
| `ALIEN_JDL_CPULIMIT` | no | 8 | The CPU limit assumed by the workflow runner; the actual limit varies depending on the machine. |
| `ALIEN_JDL_SIMENGINE` | no | `TGeant4` | The simulation engine for particle transport. |
| `ALIEN_JDL_WORKFLOWDETECTORS` | no | `ITS,TPC,TOF,FV0,FT0,FDD,MID,MFT,MCH,TRD,EMC,PHS,CPV,HMP,CTP` | These can be a selection of detectors active during reconstruction. Detectors not used in reconstruction will be disregarded. |
| `ALIEN_JDL_ANCHOR_SIM_OPTIONS` | no | *empty* | Additional simulation options for custom user settings, often used to define the event generator or pass extra configurations. Refer to the [example](#run-pythia-with-a-different-collision-system) above for more details. |
| `ALIEN_JDL_ADDTIMESERIESINMC` | no | `1` | Enable TPC time series by setting this to `1`; set to `0` to disable. |

---

## The Background Process

The intricate process occurring behind the scenes is outlined in the following diagram.

![anchored run](../images/anchored_run.png)

## The 2-Software Tag Method for Anchored MC Productions

A **two-tag software methodology** is available for anchored Monte Carlo (MC) productions. This allows different tasks within an MC job to utilize distinct CVMFS software releases.

### Rationale

The main goal is to ensure that reconstruction algorithms run on **stable software releases** and configurations, which are also employed in data-reconstruction processes. Additionally, this method facilitates incorporating new developments in:

- Event generators  
- GEANT-based simulations  
- Anchoring logic  
- Workflow execution frameworks

This approach minimizes the necessity to integrate enhancements into older software releases.

---

### Implementing the 2-Tag Setup

In practice, all you need to do is:

-

---

# required ALIEN_JDL_* variables
export ALIEN_JDL_ANCHOR_SIM_OPTIONS="-gen pythia8 -confKey GeneratorPythia8.config=$(pwd)/pythia8.cfg"

# example values provided
export NTIMEFRAMES=2
export SPLITID=100
export PRODSPLIT=153
export CYCLE=0

# on the GRID, this variable is set; for our specific case, we can imitate any job ID
export ALIEN_PROC_ID=2963436952

# execute the central anchor steering script, which performs the following tasks:
# * calculates the timestamp
# * determines the interaction rate
# * retrieves and prepares configurations (identifying which detectors are included in the run)
# * executes the simulation and quality control
${O2DPG_ROOT}/MC/run/ANCHOR/anchorMC.sh
```

Further customization is possible, such as adjusting the center-of-mass energy in addition to the collision system.

## Environment Variables

The `anchorMC.sh` script relies on these environment variables. Make sure to export them, particularly if they are necessary.

```

---

## Pre- and Post-Processing Steps, Special Configurations

To incorporate any additional functionality through pre- or post-processing steps in the simulation, avoid directly modifying core O2DPG scripts or files. Instead, there are two designated areas to implement such changes. Notably, using custom O2DPG scripts for production requests and tests will prevent official productions from running successfully.

1. Execute the `anchorMC.sh` steering script within your own shell script. Before or after running `anchorMC.sh`, you can include additional pre- or post-processing steps.
    * For example, you may need to copy specific files to or from another location before or after the simulation.
1. Include specific arguments to be passed to the simulation workflow creation by setting the environment variable `ALIEN_JDL_ANCHOR_SIM_OPTIONS` (refer to the examples provided in the sections below).

---

## Run Pythia with a Different Collision System

To run Pythia8 with a different collision system than the one used during data collection, you can follow the outlined procedure.
First, supply your own `cfg` file for Pythia8. You can find examples at [this link](https://github.com/AliceO2Group/AliceO2/tree/dev/Generators/share/egconfig).
Next, configure it using
```bash
export ALIEN_JDL_ANCHOR_SIM_OPTIONS="-gen pythia8 -confKey GeneratorPythia8.config=<path/to/pythia_config.cfg>"
```

Alternatively, you can create such a configuration using the script `mkpy8cfg.py` from [here](https://github.com/AliceO2Group/O2DPG/blob/master/MC/config/common/pythia8/utils/mkpy8cfg.py). For example, you can generate your configuration and use it as follows:
```bash
${O2DPG_ROOT}/MC/config/common/pythia8/utils/mkpy8cfg.py --output pythia8.cfg --seed 5 --idA 2212 --idB 2212 --eCM 5020 --process jets
```

---

---

### Guide for the 2-Tag Configuration

You need to perform these steps:

**(a)** Select a current (verified) software release in the `Packages` field of your JDL:

- Fetches the latest **O2DPG logic**
- Utilizes the most recent **generator code**
- Incorporates updated **GEANT and digitization algorithms**

**(b)** Configure the environment variable `ALIEN_JDL_O2DPG_ASYNC_RECO_TAG` to specify the release used for **reconstruction**.

- Guarantees that reconstruction employs the right version for anchoring and configuration

---

### Example JDL Code

```jdl
Packages = {
  "VO_ALICE@O2PDPSuite::daily-20250408-0000-1"
};

JDLVariables = {
  ...
  O2DPG_ASYNC_RECO_TAG
  ...
};

O2DPG_ASYNC_RECO_TAG = "VO_ALICE@O2PDPSuite::async-async-v1-02-10-slc9-alidist-async-v1-02-01-1"
...
```

### Key Considerations

Although this method is effective and user-friendly, it has **potential drawbacks**.

---

---
sort: 1
title: Anchored MC
---

# Anchored MC

Please be aware that anchoring MCs is currently unsupported on Mac systems!

## Requirements

Ensure you install or load one of the following `alidist` packages:

- `O2sim`
- `O2PDPSuite`

These are meta-packages that include all necessary components.

The steering script for anchored simulations is named `anchoredMC.sh` and can be found at this link: [O2DPG/MC/run/ANCHOR/anchorMC.sh](https://github.com/AliceO2Group/O2DPG/blob/master/MC/run/ANCHOR/anchorMC.sh). This script acknowledges several environment variables, which are further detailed in the test scripts (refer to the links [below](#run-an-anchored-simulation)). A particularly useful and powerful variable is `ALIEN_JDL_ANCHOR_SIM_OPTIONS`, which allows you to add configurations to the simulation workflow (for a specific example, see [below](#run-pythia-with-a-different-collision-system)).

---

**NOTE** that the `anchorMC.sh` script should not be modified to incorporate new configurations or features. If you require something that isn't covered in this documentation, please reach out to the developers and provide your specific request.

## Execute an anchored simulation

In "anchored" Monte Carlo (MC) simulations, conditions are configured to mirror those during a real data-taking run, such as the LHC filling schedule, the active ALICE detectors, and the interaction rate. Anchored MC productions are essential for physics analyses to ensure realistic simulated datasets.

An anchored simulation is linked to a specific run, identified by a run number, which covers the period from the start-of-run (SOR) to the end-of-run (EOR). This is illustrated in the figure.
![anchored split cycle](../images/anchored_split_cycle.png)

---

While this method is robust and user-friendly, it does carry some **potential risks**:

* Incompatibilities between the two software versions (e.g., data formats, configuration options, etc.)
    
* Such incompatibilities should be **verified in pilot jobs** before scaling up to larger operations.
    

Any identified problems should be reported through the standard channels:

* [Mattermost simulation forums]
    
* [JIRA issues]