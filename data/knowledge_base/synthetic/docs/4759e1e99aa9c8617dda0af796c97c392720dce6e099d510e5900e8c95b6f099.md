## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/MC/bin/o2dpg_qc_finalization_workflow.py

**Start chunk id:** 4759e1e99aa9c8617dda0af796c97c392720dce6e099d510e5900e8c95b6f099

## Content

DOCUMENT:
    def QC_finalize_name(name):
  return name + "_finalize"

qcdir = "QC"
def include_all_QC_finalization(ntimeframes, standalone, run, productionTag, conditionDB, qcdbHost, beamType):

  stages = []

  ## Adds a 'remote-batch' component to standard QC workflows
  # taskName     - name of the QC workflow, it should match the main workflow's task name
  # qcConfigPath - path to the QC configuration file
  # needs        - a list of tasks that need to be completed first. By default, the function includes the 'local-batch' part of the QC workflow
  def add_QC_finalization(taskName, qcConfigPath, needs=None):
    if standalone == True:
      needs = []
    elif needs == None:
      needs = [taskName + '_local' + str(tf) for tf in range(1, ntimeframes + 1)]

    task = createTask(name=QC_finalize_name(taskName), needs=needs, cwd=qcdir, lab=["QC"], cpu=1, mem='2000')
    def remove_json_prefix(path):
           return re.sub(r'^json://', '', path)

---

## Introduces a postprocessing quality control workflow
  # taskName     - the name of the QC workflow
  # qcConfigPath - the path to the QC configuration file
  # needs        - a list of tasks that must be completed first; typically, these are finalization tasks for QC that generate necessary objects for the post-processing
  # runSpecific  - if set to true, a specific run number is included in the configuration, meaning the post-processing will handle objects from that particular run only
  # prodSpecific - if set to true, a specific production name is included in the configuration, meaning the post-processing will handle objects from that production only
  def add_QC_postprocessing(taskName, qcConfigPath, needs, runSpecific, prodSpecific):
    task = createTask(name=taskName, needs=needs, cwd=qcdir, lab=["QC"], cpu=1, mem='2000')
    overrideValues = '--override-values "'
    overrideValues += f'qc.config.Activity.number={run};' if runSpecific else 'qc.config.Activity.number=0;';

---

if O2_ROOT is None: 
    print('Error: O2 must be loaded')

if QUALITYCONTROL_ROOT is None:
    print('Error: QUALITYCONTROL_ROOT must be loaded')

if not isdir(qcdir):
    mkdir(qcdir)

workflow={}
workflow['stages'] = include_all_QC_finalization(ntimeframes=1, standalone=True, run=args.run, productionTag=args.productionTag, conditionDB=args.conditionDB, qcdbHost=args.qcdbHost, beamType=args.beamType)
  
dump_workflow(workflow["stages"], args.o)
  
return 0


if __name__ == '__main__':
  sys.exit(main())

---

configFilePathOnDisk = qcConfigPath.replace('json://', '')
# We verify if the configFilePath exists in the currently loaded software. If it doesn't, we exit gracefully.
task['cmd'] = ' if [ -f ' + configFilePathOnDisk + ' ]; then { '
task['cmd'] += f'o2-qc --config {qcConfigPath} --remote-batch {taskName}.root' + \
               f' --override-values "qc.config.database.host={qcdbHost};qc.config.Activity.number={run};qc.config.Activity.type=PHYSICS;qc.config.Activity.periodName={productionTag};qc.config.Activity.beamType={beamType};qc.config.conditionDB.url={conditionDB}"' + \
               ' ' + getDPL_global_options()
task['cmd'] += ' ;} else { echo "Task ' + taskName + ' not performed due to config file not found "; } fi'

stages.append(task)

---

add_QC_finalization('tpcStandardQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/tpc-qc-standard-direct.json')
add_QC_finalization('trdDigitsQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/trd-standalone-task.json')
add_QC_finalization('trdTrackingQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/trd-tracking-task.json')
add_QC_finalization('vertexQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/vertexing-qc-direct-mc.json')
add_QC_finalization('ITSTPCmatchQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/ITSTPCmatchedTracks_direct_MC.json')
add_QC_finalization('TOFMatchQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/tofMatchedTracks_ITSTPCTOF_TPCTOF_direct_MC.json')
add_QC_finalization('tofDigitsQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/tofdigits.json')
add_QC_finalization('TOFMatchWithTRDQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/tofMatchedTracks_AllTypes_direct_MC.json')
add_QC_finalization('ITSTrackSimTask', 'json://${O2DPG_ROOT}/MC/config/QC/json/its-mc-tracks-qc.json')

---

if the 'MCH' and 'MID' and 'MFT' components are active:
  add final QC configuration for 'MUONTracksMFTTaskQC' using 'json://${O2DPG_ROOT}/MC/config/QC/json/mftmchmid-tracks-task.json'
elif the 'MCH' and 'MFT' components are active:
  add final QC configuration for 'MCHMFTTaskQC' using 'json://${O2DPG_ROOT}/MC/config/QC/json/mftmch-tracks-task.json'
if 'FT0' and 'TRD' components are active:
  add final QC configuration for 'tofft0PIDQC' using 'json://${O2DPG_ROOT}/MC/config/QC/json/pidft0tof.json'
elif only 'FT0' is active:
  add final QC configuration for 'tofft0PIDQC' using 'json://${O2DPG_ROOT}/MC/config/QC/json/pidft0tofNoTRD.json'
elif only 'TRD' is active:
  add final QC configuration for 'tofPIDQC' using 'json://${O2DPG_ROOT}/MC/config/QC/json/pidtof.json'
otherwise:
  add final QC configuration for 'tofPIDQC' using 'json://${O2DPG_ROOT}/MC/config/QC/json/pidtofNoTRD.json'
add final QC configuration for 'RecPointsQC' using 'json://${O2DPG_ROOT}/MC/config/QC/json/ft0-reconstruction-config.json'

---

DOCUMENT:
    overrideValues += f'qc.config.Activity.type=PHYSICS;'
    overrideValues += f'qc.config.Activity.periodName={productionTag};' if prodSpecific else 'qc.config.Activity.periodName=;'
    overrideValues += f'qc.config.Activity.beamType={beamType};'
    overrideValues += f'qc.config.database.host={qcdbHost};qc.config.conditionDB.url={conditionDB}'
    task['cmd'] = f'o2-qc --config {qcConfigPath} ' + \
                  overrideValues + ' ' + getDPL_global_options()
    stages.append(task)

---

DOCUMENT:
    add_QC_finalization('ITSTracksClusters', 'json://${O2DPG_ROOT}/MC/config/QC/json/its-clusters-tracks-qc.json')
  if 'MID' is active:
     add_QC_finalization('MIDTaskQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/mid-task.json')
  if 'MCH' is active:
     add_QC_finalization('MCHDigitsTaskQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/mch-digits-task.json')
     add_QC_finalization('MCHErrorsTaskQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/mch-errors-task.json')
     add_QC_finalization('MCHRecoTaskQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/mch-reco-task.json')
     add_QC_finalization('MCHTracksTaskQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/mch-tracks-task.json')
  if 'MCH' is active and 'MID' is active:
     add_QC_finalization('MCHMIDTracksTaskQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/mchmid-tracks-task.json')
  if 'MCH' is active and 'MID' is active and 'MFT' is active:

---

parser.add_argument('--noIPC', help='disable shared memory in DPL')
parser.add_argument('-o', help='output workflow file', default='workflow.json')
parser.add_argument('-run', help="Run number for this MC", default=300000)
parser.add_argument('-productionTag', help="Production tag for this MC", default='unknown')
parser.add_argument('-conditionDB', help="CCDB url for QC workflows", default='http://alice-ccdb.cern.ch')
parser.add_argument('-qcdbHost', help="QCDB url for QC object uploading", default='http://ali-qcdbmc-gpn.cern.ch:8083')
parser.add_argument('-beamType', help="Collision system, e.g. PbPb, pp", default='')
args = parser.parse_args()
print(args)

# ensure that O2DPG and O2 are loaded
O2DPG_ROOT = environ.get('O2DPG_ROOT')
O2_ROOT = environ.get('O2_ROOT')
QUALITYCONTROL_ROOT = environ.get('QUALITYCONTROL_ROOT')

if O2DPG_ROOT is None: 
    print('Error: O2DPG must be loaded')

if O2_ROOT is None: 
    print('Error: O2 must be loaded')

---

add_QC_finalization('FV0DigitsQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/fv0-digits.json')
add_QC_finalization('FDDRecPointsQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/fdd-recpoints.json')
add_QC_finalization('CPVDigitsQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/cpv-digits-task.json')
add_QC_finalization('CPVClustersQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/cpv-clusters-task.json')
add_QC_finalization('PHSCellsClustersQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/phs-cells-clusters-task.json')

---

# The list of QC Post-processing workflows
  add_QC_postprocessing('tofTrendingHits', 'json://${O2DPG_ROOT}/MC/config/QC/json/tof-trending-hits.json', [QC_finalize_name('tofDigitsQC')], runSpecific=False, prodSpecific=True)

  return stages


def main() -> int:
  
  parser = argparse.ArgumentParser(description='Generate the ALICE QC finalization workflow')

---

#!/usr/bin/env python3

#
# A script for generating the finalization quality control workflow.
# When executed as the main program, it outputs the workflow to the specified file without setting task dependencies.
# Example usage:
#   ${O2DPG_ROOT}/MC/bin/o2dpg_qc_finalization_workflow.py -o qc_workflow.json 


# The script can also be utilized as an import.
# In this scenario, one can employ the include_all_QC_finalization function to integrate QC finalization within another workflow script.

import sys
import argparse
from os import environ, mkdir
from os.path import join, dirname, isdir
import re

sys.path.append(join(dirname(__file__), '.', 'o2dpg_workflow_utils'))

from o2dpg_workflow_utils import createTask, dump_workflow, isActive

def getDPL_global_options(bigshm=False, noIPC=None):
   common="-b --run --driver-client-backend ws:// "
   if noIPC != None:
      return common + " --no-IPC "
   if bigshm:
      return common + " --shm-segment-size ${SHMSIZE:-50000000000} "
   else:
      return common

---

## The list of remote-batch workflows (reading merged QC tasks results, applying Checks, and uploading them to QCDB)
  MFTDigitsQCneeds = []
  for flp in range(5):
    MFTDigitsQCneeds.extend(['mftDigitsQC'+str(flp)+'_local'+str(tf) for tf in range(1, ntimeframes + 1)])
  add_QC_finalization('mftDigitsQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/mft-digits-0.json', MFTDigitsQCneeds)
  add_QC_finalization('mftClustersQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/mft-clusters.json')
  add_QC_finalization('mftTracksQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/mft-tracks.json')
  add_QC_finalization('mftMCTracksQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/mft-tracks-mc.json')
  add_QC_finalization('emcRecoQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/emc-reco-tasks.json')
  add_QC_finalization('emcBCQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/emc-reco-tasks.json')
  #add_QC_finalization('tpcTrackingQC', 'json://${O2DPG_ROOT}/MC/config/QC/json/tpc-qc-tracking-direct.json')