## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/DATA/production/configurations/2021/ctf_recreation/ctf_recreation.sh

**Start chunk id:** 0421ddfd33b0ffc95b908365a9a2bc6a0e4f78155aa043eb54de498d7cd608ef

## Content

# we will overwrite these variables if they are found in the jdl
if [[ -n "$ALIEN_JDL_LPMRUNNUMBER" ]]; then
    export RUNNUMBER="$ALIEN_JDL_LPMRUNNUMBER"
fi
# for the year
if [[ -n "$ALIEN_JDL_LPMANCHORYEAR" ]]; then
    export YEAR="$ALIEN_JDL_LPMANCHORYEAR"
fi
# for the period
if [[ -n "$ALIEN_JDL_LPMPRODUCTIONTAG" ]]; then
    export PERIOD="$ALIEN_JDL_LPMPRODUCTIONTAG"
fi
# for the beam type
if [[ -n "$ALIEN_JDL_LPMINTERACTIONTYPE" ]]; then
    export BEAMTYPE="$ALIEN_JDL_LPMINTERACTIONTYPE"
fi
# for the pass
if [[ -n "$ALIEN_JDL_LPMPASSNAME" ]]; then
    export PASS="$ALIEN_JDL_LPMPASSNAME"
fi

---

DOCUMENT:
    export TFDELAY=0.1
if [[ $DETCONFIG == "centralBarrel" ]]; then
    export TFDELAY=10
fi

# display the workflow
IS_SIMULATED_DATA=0 WORKFLOWMODE=print SYNCMODE=1 NTIMEFRAMES=-1 SHMSIZE=16000000000 DDSHMSIZE=32000 TPC_CONVERT_LINKZS_TO_RAW=1 ./run-workflow-on-inputlist.sh TF list.list > workflowconfig.log
# execute the workflow
IS_SIMULATED_DATA=0 WORKFLOWMODE=run   SYNCMODE=1 NTIMEFRAMES=-1 SHMSIZE=16000000000 DDSHMSIZE=32000 TPC_CONVERT_LINKZS_TO_RAW=1 ./run-workflow-on-inputlist.sh TF list.list

---

DOCUMENT:
    export WORKFLOW_PARAMETERS=CTF
if [[ -f "setenv_extra_ctf_recreation_$DETCONFIG.sh" ]]; then
    source setenv_extra_ctf_recreation_$DETCONFIG.sh 
else
    echo "************************************************************************************"
    echo "No specific ad-hoc setenv_extra_ctf_recreation_$DETCONFIG settings for current asynchronous processing; utilizing the default one from O2DPG"
    echo "************************************************************************************"
    if [[ -f $O2DPG_ROOT/DATA/production/configurations/$YEAR/ctf_recreation/setenv_extra_ctf_recreation_$DETCONFIG.sh ]]; then
	ln -s $O2DPG_ROOT/DATA/production/configurations/$YEAR/ctf_recreation/setenv_extra_ctf_recreation_$DETCONFIG.sh
	source setenv_extra_ctf_recreation_$DETCONFIG.sh
    else
	echo "*********************************************************************************************************"
	echo "No setenv_extra_ctf_recreation_$DETCONFIG for $ALIEN_JDL_LPMANCHORYEAR in O2DPG"

---

# Configuration settings to be applied
# If the "-dc" or "--detector-config" option is provided, this takes precedence over all other methods;
# If "$DETCONFIG" is explicitly set, it has the second-highest priority;
# The final option is to derive it from the JDL.
if [[ -z "$DETCONFIG" ]]; then
    if [[ -z "$ALIEN_JDL_DETCONFIG" ]]; then
	echo "no detector configuration set, exiting"
	exit 4
    else
	DETCONFIG="$ALIEN_JDL_DETCONFIG"
    fi
fi

if [[ -z $RUNNUMBER ]] || [[ -z $YEAR ]] || [[ -z $PERIOD ]] || [[ -z $DETCONFIG ]] || [[ -z $BEAMTYPE ]] || [[ -z $PASS ]]; then
    echo "verify the required environment variables: RUNNUMBER (--> $RUNNUMBER), YEAR (--> $YEAR), PERIOD (--> $PERIOD), DETCONFIG (--> $DETCONFIG), BEAMTYPE (--> $BEAMTYPE), PASS (--> $PASS)"
    exit 3
fi

echo "processing run $RUNNUMBER, from year $YEAR and period $PERIOD with beamtype $BEAMTYPE, pass $PASS. The detector configuration will be $DETCONFIG"

---

if [[ -f run-workflow-on-inputlist.sh ]]; then
    echo "Use run-workflow-on-inputlist.sh macro provided as input"
else
    echo "Use run-workflow-on-inputlist.sh macro from O2"
    cp $O2_ROOT/prodtests/full-system-test/run-workflow-on-inputlist.sh .
fi

if [[ -z $DPL_WORKFLOW_FROM_OUTSIDE ]]; then
    echo "Use dpl-workflow.sh from O2"
    cp $O2_ROOT/prodtests/full-system-test/dpl-workflow.sh .
else
    echo "Use dpl-workflow.sh passed as input"
    cp $DPL_WORKFLOW_FROM_OUTSIDE .
fi

ln -sf $O2DPG_ROOT/DATA/common/setenv.sh
ln -sf $O2DPG_ROOT/DATA/common/getCommonArgs.sh

export TFDELAY=0.1
if [[ $DETCONFIG == "centralBarrel" ]]; then
    export TFDELAY=10
fi

---

DOCUMENT:
    echo "No setenv_extra_ctf_recreation_$DETCONFIG defined for $ALIEN_JDL_LPMANCHORYEAR in O2DPG"
    echo "                The processing cannot proceed"
    echo "*********************************************************************************************************"
    exit 5
    fi
fi

---

###if [[ $MODE == "remote" ]]; then 
# common archive
if [[ ! -f commonInput.tgz ]]; then
	echo "commonInput.tgz not found, exiting"
	exit 2
fi
# run specific archive
if [[ $DETCONFIG == "muon" ]] || [[ $DETCONFIG == "centralBarrel" ]]; then
	if [[ ! -f runInput_$RUNNUMBER.tgz ]]; then
	    echo "runInput_$RUNNUMBER.tgz not found, exiting"
	    exit 2
	else
	    tar -xzvf runInput_$RUNNUMBER.tgz
	fi
fi
tar -xzvf commonInput.tgz

###fi

echo "Displaying current directory contents"
ls -altr

---

#!/bin/bash

# Script to initiate async processing
#
# If running locally, you must export variables like:
#
# export ALIEN_JDL_LPMRUNNUMBER=505673
# export ALIEN_JDL_LPMINTERACTIONTYPE=pp
# export ALIEN_JDL_LPMPRODUCTIONTAG=OCT
# export ALIEN_JDL_LPMPASSNAME=apass3
# export ALIEN_JDL_LPMANCHORYEAR=2021
# export ALIEN_JDL_DETCONFIG=centralBarrel [muon, cpv, emcal, phos]


if [[ "${1##*.}" == "root" ]]; then
    #echo ${1##*.}
    #echo "alien://${1}" > list.list
    #export MODE="remote"
    echo "${1}" > list.list
    export MODE="LOCAL"
    shift
elif [[ "${1##*.}" == "xml" ]]; then
    sed -rn 's/.*turl="([^"]*)".*/\1/p' $1 > list.list
    export MODE="remote"
    shift
fi

POSITIONAL=()
while [[ $# -gt 0 ]]; do
  key="$1"
  case $key in
    -dc|--detector-config)  
      export DETCONFIG="$2"
      shift
      shift
      ;;
    -b|--beam-type)
      export BEAMTYPE="$2"
      shift
      shift
      ;;
    *)
    POSITIONAL+=("$1")
    shift
    ;;
  esac
done