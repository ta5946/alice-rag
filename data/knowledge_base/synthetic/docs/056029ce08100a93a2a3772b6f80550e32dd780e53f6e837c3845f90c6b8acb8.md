## Metadata

**Document link:** https://github.com/ta5946/alice-rag/blob/master/data/knowledge_base/ALICE-simulation-tutorial.pptx-1.pdf

**Start chunk id:** 056029ce08100a93a2a3772b6f80550e32dd780e53f6e837c3845f90c6b8acb8

## Content

${O2DPG_ROOT}/MC/run/ANCHOR/anchorMC.sh

test_anchor_2023_apass2_pp.sh 

so

${O2DPG_ROOT}/GRID/utils/grid_submit.sh --script 
test_anchor_2023_apass2_pp.sh --jobname test --outputspec 
"*.log@disk=1","*.root@disk=2" --packagespec 
"VO_ALICE@O2sim::v20241014-1" --wait --fetch-output

‚òùImportant to know:
‚óè All existing MC productions are listed in MonALISA under Production Info ‚Üí MC production cycles

(running, completed, software updates, etc.)

‚óè Steps to request Anchored MC production to O2DPG:

1. Run a test on the GRID using your settings
2. Include an estimate of running time, expected storage, and the number of events
3. Submit a link to the GRID folder containing your test and results configuration/JDL

Check 
backup

35
Further topics:

‚Ä¢ Additional advanced topics will be covered

‚Ä¢ ‚Ä¶ extending beyond the current set of slides ‚Ä¶

‚Ä¢ Contact us for more details!

‚Ä¢ Help us enhance the documentation, which is still in its early stages!

‚Ä¶ and much more

---

Marco Giacalone
Sandro Wenzel

15.10.2024

Running Run3 Simulations

ALICE Analysis Tutorial
Outline

‚Ä¢ Overview of the ALICE Run3 simulation environment

‚Ä¢ o2-sim and event simulation 

‚Ä¢ Simulation configuration options and capabilities

‚Ä¢ The O2DPG workflow ‚Üí the new standard for working 

2
Outline

‚Ä¢ Overview of the ALICE Run3 simulation environment

‚Ä¢ o2-sim and event simulation 

‚Ä¢ Simulation configuration options and capabilities

‚Ä¢ The O2DPG workflow ‚Üí the new standard for working 

!

Opening Remark

An introductory overview for practical Monte Carlo generation.
Further details available in other PWG tutorials or documentation.

3
Contacts

‚Ä¢ Ways to contact the simulation development team

‚Ä¢ Simulation e-group (for meeting announcements) + WP12 meetings

‚Ä¢ Collaborative Mattermost channels (preferable over private email): O2-simulation + O2DPG

‚Ä¢ JIRA tickets for feature requests/bug reports  (components simulation or O2DPG)

‚Ä¢ Information sources for simulation details

---

‚Ä¢ Formation of hits (energy deposits) as an initial step in detector simulation following particle traversal

10
o2-sim: ALICE Run3 simulation tool

‚Ä¢ New feature in Run3: scalable multi-core simulation with sub-event parallelism

‚Üíenables efficient processing of large server resources to swiftly deliver results for significant events

‚Ä¢ Note: o2-sim processes events independently ‚Äì no time frame consideration (introduced during digitization)

‚Ä¢ o2-sim generates 3 internal log files ‚Üí detailed documentation of each process and debugging information

o2sim_serverlog

o2sim_workerlog0

o2sim_mergerlog

11
Examples of o2-sim usage

‚Ä¢ Examples of using o2-sim

o2-sim -n 10 -g pythia8pp

o2-sim -n 10 -g pythia8pp -j 8 \ 
--skipModules ZDC --field 2 -e TGeant3

 o2-sim -n 10 -g pythia8pp --noGeant

‚ÄúCreate 10 standard Pythia8 pp events and simulate their passage through the entire ALICE detector‚Äù

‚ÄúProduce 10 standard Pythia8 pp events and simulate their transport with 8 Geant3 workers, excluding ZDC, and apply a L3 field of 2 kGauss‚Äù

11

---

‚Ä¢ Default paths: ${WORKDIR}/ccdb/<path>/<in>/<ccdb>/snapshot.root

Moreover‚Ä¶

‚Ä¢

The path can be manually specified using:

export ALICEO2_CCDB_LOCALCACHE=/<your>/<path>

ALICEO2_CCDB_LOCALCACHE=/<your>/<path>

or by executing:

ALICEO2_CCDB_LOCALCACHE=${YOURPATH} o2_dpg_workÔ¨Çow_runner.py ‚Ä¶

enabling the use of an existing cache

‚Ä¢

A script in O2 for downloading CCDB Ô¨Åles is available:

${O2_ROOT}/bin/o2-ccdb-downloadccdbÔ¨Åle --host http://alice-ccdb.cern.ch -p 
TPC/Calib/CorrectionMapRef --timestamp <timestamp> --created-not-after 3385078236000 
-d ${YOURPATH}

28
üëâ Examples here; üëâ Documentation here

O2DPG-MC step 1: workflow creation

‚Ä¢ MC workflow for ALICE Run3 is created using the script:

O2DPG/MC/bin/o2dpg_sim_workflow.py

‚Ä¢ Configures the MC workflow based on key parameters such as collision system, generators, interaction rate, number of timeframes, transport engine, etc.
‚Ä¢ `o2dpg_sim_workflow.py --help` ‚Üí documentation with all available options

---

üëâ Embedding example in O2DPG: 
PWGHF embedding

38
Estimate resources

‚Ä¢ Grid logs will indicate the total runtime of your processes when running on the GRID. 
**** Pipeline completed successfully (global runtime: 533.892s) *****
example script for anchored pp production

‚Ä¢ The expected runtime in seconds can be determined by:

‚Ä¢ Storage resources are computed by summing the sizes of all stored files, which can be obtained from MonALISA.

---

‚Ä¢ configure the generator at runtime in C++

‚Ä¢ this process turns into a configuration challenge

‚Ä¢ this approach is employed for PWG-specific generation within the O2DPG production framework

‚Ä¢ for instance, the PWGDQ cocktail generator

"invoke o2-sim with the -g external flag and specify the external file and function name"

o2-sim -n 10 -g external --configKeyValues 
'GeneratorExternal.fileName=myGen.C;GeneratorExternal.funcName="gen(5020)"'

"snippet of the ROOT macro file myGen.C"

// my fully custom generator
class MyGen : public o2::generator::GeneratorTGenerator {
  void Init() override;
  bool generateEvent() override;
};

FairGenerator* gen(double energy) {
  return new MyGen(energy);
}

üëâ Additional details in the documentation

17
üëâ Example: run/SimExamples/HepMC

üëâ Example: 
run/SimExamples/HepMC_STARlight

HepMC generation

‚Ä¢ numerous generators can produce HepMC formatted data by default ‚Üí a universal and convenient method for storing information from MC event generators

---

‚Ä¢ Can be skipped for a standalone o2-sim operation

20
Integrated workÔ¨Çows: O2DPG MC

‚Ä¢ To generate simulated AODs, we must extend beyond o2-sim and event generation, running the full algorithmic pipeline, which includes digitization and reconstruction steps.

‚Ä¢ This is a intricate system comprising numerous executables or tasks, necessitating consistent application and transmission of settings/configuration for effective operation.

‚Ä¢ For instance, the full-system-test for data acquisition.

‚Ä¢ It is challenging to configure correctly on your own; utilize a maintained setup!

‚Ä¢ For ALICE Run3, the official production system for GRID operations is the O2DPG repository (MC section).

‚Ä¢ O2DPG also includes scripts and setup for data acquisition (DATA section).

‚ÄúAlgorithm interactions form a complex system (DPL topology)‚Äù

21
O2DPG ‚Ä¶

‚Ä¢ offers a reliable setup for official MC productions for ALICE-Run3 and a runtime for executing MC jobs on GRID.

‚Ä¢ incorporates all pertinent processing tasks into a single framework.

---

${O2DPG_ROOT}/MC/bin/o2dpg_sim_workflow.py -eCM 14000 -col pp

                                       -gen pythia8 -proc cdiff           

                          -tf 5 ‚Äîns 2000                                                                                 

"Create an ALICE Run3 Monte Carlo workflow for a 5 timeframe simulation, generating 2000 events per timeframe at an interaction rate of 500kHz for 14TeV pp collisions using Pythia8 with the cdiff process enabled..."

                                         -interactionRate 500000
                      -run 302000

‚òù Important options:

-gen, -tf, -n, -eCM, -interactionRate, -run, -col
 Optionally: -field, -seed, -proc

29
WorkÔ¨Çow creation: Run numbers

‚Ä¢ A run number is essential as it is required to fetch conditions from CCDB.

‚Ä¢ Therefore, run numbers should be used even for non-data-taking simulations.

‚Ä¢ A list of predefined run numbers is available for MC simulations.

---

‚Ä¢ Geometry file
‚Ä¢ Kinematics file
‚Ä¢ Detector response files (hits)

Digitization

Reconstruction

Physics Analysis

‚Ä¢ Digits represent detector sub-timeframes
‚Ä¢ Comparable or similar to raw detector output

‚Ä¢ Global reconstructed tracks
‚Ä¢ Primary and secondary vertices

‚Ä¢ etc.
‚Ä¢ AOD (analysis object data)

9
o2-sim: ALICE Run3 simulation tool

‚Ä¢ o2-sim is the particle-detector simulator for ALICE Run3

It implements ALICE detectors on top of widely used particle-transport 
engines that incorporate actual physics models and particle transport

‚Ä¢ Supports Geant4, Geant3, and FLUKA via the Virtual Monte Carlo API

‚Ä¢ o2-sim primary tasks:

‚Ä¢ ALICE geometry creation

‚Ä¢ Event generation (primary particle production)

‚Ä¢ Simulation of particle interactions with detector material (secondary particle creation, etc.) and particle transport until they exit the detector or stop

‚Ä¢ Creation of hits (energy deposits) as a precursor to detector response after particle passage

---

CYCLE J - 1

where

J =    Total N TFs

N*PRODSPLIT

‚ÜêN is set via the running script (next slide)

34
How to initiate anchored MC productions?

Documentation

‚Ä¢ The grid_submit.sh script can be utilized to initiate anchored MC productions ‚Üí an associated production script must be supplied  
example script for anchored pp production

export ALIEN_JDL_LPMANCHORPASSNAME=apass2
export ALIEN_JDL_MCANCHOR=apass2
export ALIEN_JDL_CPULIMIT=8
export ALIEN_JDL_LPMRUNNUMBER=535069
export ALIEN_JDL_LPMPRODUCTIONTYPE=MC
export ALIEN_JDL_LPMINTERACTIONTYPE=pp
export ALIEN_JDL_LPMPRODUCTIONTAG=LHC24a2
export ALIEN_JDL_LPMANCHORRUN=535069
export ALIEN_JDL_LPMANCHORPRODUCTION=LHC23f
export ALIEN_JDL_LPMANCHORYEAR=2023

export NTIMEFRAMES=1
export NSIGEVENTS=50
export SPLITID=100
export PRODSPLIT=153
export CYCLE=0

export SEED=5
export NWORKERS=2

${O2DPG_ROOT}/MC/run/ANCHOR/anchorMC.sh

test_anchor_2023_apass2_pp.sh 

so

---

‚Ä¢ Event filtering or triggering can also be flexibly managed at the generator level.

‚Ä¢ For instance, only events with specific properties are generated and simulated.

‚Ä¢ Users can set up a customizable "external" trigger through the "external" generator approach.

‚Ä¢ A user-defined trigger function can be implemented in a separate ROOT macro and passed to o2-sim using the `-t external` option.

‚Ä¢ This trigger function evaluates the full list of generated particles.

‚Ä¢ For advanced triggering, DeepTriggers can be used to trigger based on the primary particle collection and additional internal generator data.

‚ÄúRun o2-sim with the pythia8pp generator and forward only events that meet the trigger condition defined in the file Trigger.C‚Äù

o2-sim -n 10 -g pythia8pp -t external --configKeyValues 
‚ÄòTriggerExternal.fileName=myTrigger.C;TriggerExternal.funcName=‚Äútrigger‚Äù'

‚ÄúSample content of the ROOT macro file myTrigger.C‚Äù

---

Workflow Creator

Workflow Executor

Output (AOD)

Generates a cohesive, integrated Monte Carlo (MC) workflow in the form of a directed-acyclic-graph (DAG), represented as JSON, which models the interdependencies of tasks.

Configures the MC workflow based on significant user parameters:
- collision system
- generators
- interaction rate
- number of timeframes

Handles the execution of the DAG workflow on multi-core systems, akin to a dynamic ‚Äúbuild‚Äù tool.

Initiates tasks as soon as they are ready:
- Aims for high parallelism and CPU utilization
- Adheres to resource constraints (avoids overloading the system)

workflow.json

In essence, a versatile tool not limited to MC

25
Principles of O2DPG-MC

‚Ä¢ Executing an MC job involves two stages: separating configuration logic from execution logic

‚Ä¢ Stage One: Develop a valid and configured description of the MC job, or "workflow"

‚Ä¢ Stage Two: Execute the MC job using a dynamic graph scheduler

---

### processes 

### heavy-ion settings (valid for Pb-Pb 5520 only) 
HeavyIon:SigFitNGen = 0 
HeavyIon:SigFitDefPar = 13.88,1.84,0.22,0.0,0.0,0.0,0.0,0.0 
HeavyIon:bWidth = 14.48 

### decays 
ParticleDecays:limitTau0 = on 
ParticleDecays:tau0Max = 10. 

### phase space cuts 
PhaseSpace:pTHatMin = 0.000000 
PhaseSpace:pTHatMax = -1.000000 

run with this configuration

o2-sim -n 10 -g pythia8 --configKeyValues 
‚ÄúGeneratorPythia8.config=pythia8.cfg‚Äù

16
üëâ Example: 
Run/SimExamples/AliRoot_AMPT

üëâ Example: 
Run/SimExamples/AliRoot_Hijing

External Generators

‚Ä¢ Apart from Pythia, specific generators are integrated directly (compiled) in O2 to keep PWG generator code and configurations separate from data-taking processes.

‚Ä¢ This avoids the need for recompilation.

‚Ä¢ Instead, ‚Äúexternal‚Äù generators can be interfaced in o2-sim using just-in-time ROOT macros that implement, for example, a GeneratorTGenerator class.

‚Ä¢ The setup for the generator is done at ‚Äúuse-time‚Äù in C++.

‚Ä¢ This makes the generator setup a configuration issue.

---

‚Äústub content of ROOT macro Ô¨Åle myTrigger.C‚Äù

// provides a fully customized event trigger function
o2::eventgen::Trigger trigger()
{
  return [ ](const std::vector<TParticle>& particles) -> bool {
    return true; // event is triggered
  }
}

19
ADVANCED

üëâ Example: 
Run/SimExamples/MCTrackToDPL

o2-sim as an on-the-fly generator for analysis

‚Ä¢ o2-sim can function as a generator service to inject events directly into an analysis topology (DPL) 

without the need for intermediate storage

‚Ä¢ beneficial for rapid-simulation studies within the analysis framework or for primary-only analysis

tasks

@D. Chinellato 

‚Ä¢ This approach is currently utilized by various PWGs, such as for cocktail simulation in PWG-EM

Very basic example

‚Ä¢# Launch the simulation
o2-sim -j 1 -g pythia8pp -n 10 --noDiscOutput --forwardKine --noGeant &> sim.log &
# Start a DPL process
o2-sim-mctracks-proxy -b --nevents 10 --o2sim-pid ${SIMPROC} --aggregate-timeframe 1 &

‚Ä¢ Essential for on-the-fly analysis

‚Ä¢ Can be skipped for a single o2-sim process

20
Integrated workflows: O2DPG MC

---

Both O2DPG-MC stages will be executed via a script, example.sh.

```bash
#!/usr/bin/env bash
# Workflow setup: step 1
${O2DPG_ROOT}/MC/bin/o2dpg_sim_workflow.py -eCM 13600 -col pp -gen pythia8 -proc cdiff -tf 1 -ns 200 -e TGeant4 -interactionRate 500000
# Workflow run: step 2
${O2DPG_ROOT}/MC/bin/o2dpg_workflow_runner.py -f workflow.json -tt aod
```

Several example 
scripts are included <Here>.

‚Ä¢ Jobs can be dispatched to the GRID using a script included in the O2DPG package.

```bash
${O2DPG_ROOT}/GRID/utils/grid_submit.sh --script my_script.sh --jobname test --outputspec "/*.log@disk=1", "/*.root@disk=2" --packagespec "VO_ALICE@O2sim::v20241014-1" --wait --fetch-output
```

Options defined:
--jobname: sets the task name visible on MonALISA
--outputspec: determines which files are saved post-execution;

          @disk=2 indicates that two copies of the file will be saved for redundancy.

---

WORKFLOW CREATOR

WORKFLOW EXECUTOR

OUTPUT (AOD)

Designs a coherent and integrated Monte Carlo (MC) workÔ¨Çow in the form of a directed acyclic graph (DAG), described as a JSON file, which models the dependencies among tasks.

Configures the MC workÔ¨Çow based on key user parameters:
- Collision system
- Generators
- Interaction rate
- Number of timeframes

Handles the execution of the DAG workÔ¨Çow on multi-core machines, akin to a dynamic "build" tool.

Initiates tasks as they become ready:
- Aiming for high parallelism and CPU utilization
- Ensuring adherence to resource constraints (avoids system overload)

workÔ¨Çow.json

In essence, a versatile tool not limited to MC applications

üí° Did you know?

A DAG workÔ¨Çow is comparable to a DPL topology

A DPL topology cannot fit into GRID memory

A DAG workÔ¨Çow runs in stages with intermediate files stored on disc

26
O2DPG-MC workÔ¨Çows: Requirements

‚Ä¢ Requires valid AliEn tokens to run (for accessing CCDB objects)

‚Ä¢ Experts can bypass this by using CCDB snapshots

---

The ALICE Run3 Simulation Ecosystem

The simulation ecosystem is made up of several components.

Key parts of the core simulation include:

- Event generation
- Transport simulation
- Digitization

Furthermore, MC workflows can encompass:

- Reconstruction
- Quality Control (QC)
- Analysis, and more

These individual components are managed within the O2 and O2Physics repositories.

Event Generators
Transport/Detector Simulation
Detector Digitization
Detector and Global Reconstruction Code
AOD Creation
QC
Analysis

...

PWG Configurations

Integration and configuration of all components into coherent workflows is performed using:

- O2DPG repository (primarily for physics studies on the GRID)
- full-system-test (mainly for data-taking oriented simulations)

8
Data products in the simulation pipeline

Event-Generation / Transport Simulation

- Geometry file
- Kinematics file
- Detector response files (hits)

Digitization
Reconstruction

---

‚Ä¢ Where to find information about simulation

‚Ä¢ New documentation project: https://aliceo2group.github.io/simulation/

‚Ä¢ Previous documentation in AliceO2: DetectorSimulation.md

‚Ä¢ Some info in O2DPG: WorkÔ¨ÇowRunner.md

‚Ä¢ Various examples at O2/SimExamples or nightly-tests

üëà still early stage:

‚óè
‚óè
‚óè

provide feedback 
raise questions 
participate

4
Software environment reminder

simplest local build (basic generators such as Pythia8) 

aliBuild build O2 O2DPG --defaults o2

alienv enter O2/latest,O2DPG/latest

full local build (all generators, QC and O2Physics included)

aliBuild build O2sim --defaults o2

alienv enter O2sim/latest

nightly precompiled builds (with CVMFS)

/cvmfs/alice.cern.ch/bin/alienv enter O2sim::v20241014-1

5
~TB/s

PetaBytes

Real particle collisions

Reconstruction

sensor data

Takes sensor data and 
reconstructs the state of 
particles immediately after 
collisions

AOD data
(Structured) 
high-level 
physics data for 
querying and analysis 

Physics 
Analysis

---

‚Ä¢ consolidates all necessary processing steps into a 
harmonious and unified framework to ensure a 
functional pipeline from event generation through AOD and further stages

‚Ä¢ preserves PWG generator configurations as 
version-controlled code

‚Ä¢ conducts testing and CI processes for PWG generator configurations

https://github.com/AliceO2Group/O2DPG

Key directories:

‚Ä¢ MC/bin      (workflow creation/execution)
‚Ä¢ MC/run      (PWG-specific run scripts)
‚Ä¢ MC/config   (PWG-specific generator configurations)

22
Basics of O2DPG-MC

‚Ä¢ Executing a MC job involves two steps to separate configuration logic from execution logic

1. Formulate a valid and configured description of a MC job == ‚Äúworkflow‚Äù

Workflow creator

Generates a cohesive, integrated MC 
workflow in a directed-acyclic-graph 
(DAG) format, articulated as JSON, 
reflecting the task dependencies

Configures the MC workflow based on key user 
parameters:
‚Ä¢ collision system
‚Ä¢ generators
‚Ä¢ interaction rate
‚Ä¢ number of timeframes

workflow.json

Simple example‚Ä¶

---

AOD Data
(Structured)
high-level 
physics data be 
queried/analysed 

Physics 
Analysis

Data analysis aimed at 
discovering physics 
results and 
publishing papers

6

C
l
a
s
s
i
c
a
l
 
p
i
p
e
l
i
n
e
 
i
n
 
a
 
H
E
P
 
e
x
p
e
r
i
m
e
n
t
:
E
x
p
e
r
i
m
e
n
t
a
l
 
D
a
t
a
Virtual collisions of particles
+ (detector) simulation based on physics models

sensor data

Reconstruction

Uses sensor data to 
reconstruct the state of 
particles immediately after 
collisions

PetaBytes

AOD Data
(Structured)
high-level 
physics data be 
queried/analysed 

Physics 
Analysis

Data analysis aimed at 
discovering physics 
results and 
publishing papers

But why‚Ä¶

‚Ä¢ Detector and systems design
‚Ä¢ Reconstruction algorithm calibration
‚Ä¢ Efficiency studies of reconstruction algorithms
‚Ä¢ Data-taking stress tests with synthetic data
‚Ä¢ Background effects estimation
‚Ä¢ Radiation studies
‚Ä¢

etc

7

---

@disk=2 indicates that 2 copies of the file will be saved for security purposes.

--wait: your system will pause until all GRID jobs are completed.
--fetch-output: automatically transfers files to your local disk.

--help: to display all available options.

!
‚òù Important:
The output will be stored in a separate folder from your current working directory; please verify the stdout!

33
Anchored MC Productions

Documentation

‚Ä¢ Simulations that are configured to mimic real data-taking conditions

‚Üí LHC fill schedule, included ALICE detectors, dead channels, alignment, interaction rate, etc.

‚Ä¢ These simulations are essential for generating realistic samples for physics analyses.

‚Ä¢ Each anchored MC run corresponds to a specific CYCLE and SPLITID, encompassing N timeframes across the entire RUN, with all CYCLES and SPLITIDs processed.

CYCLE J - 1

where

J =    Total N TFs

N*PRODSPLIT

‚ÜêN is determined by the running script (next slide)

---

‚Ä¢ Experts can bypass certain restrictions by using CCDB snapshots.

‚Ä¢ The O2DPG MC workÔ¨Çows are designed to run optimally on a system with 8 CPU cores and 16GB of RAM, mirroring the standard resources available on the GRID.

‚Ä¢ When running these workÔ¨Çows locally on your laptop, you should adhere to these resource requirements.

‚Ä¢ These defaults are incorporated into the setup and execution of the workÔ¨Çows.

‚Ä¢ Transport simulation will utilize 8 worker threads.

‚Ä¢ TPC and TRD digitisation will employ 8 threads.

‚Ä¢ The workÔ¨Çow runner assumes it has access to 8 cores.

‚Ä¢ Consequently, running O2DPG MC workÔ¨Çows on hardware with fewer resources can result in issues.

‚Ä¢ However, with some adjustments and tuning, it might still be feasible to run these workÔ¨Çows on less powerful hardware.

‚Ä¢ Valid AliEn-tokens are necessary to run the workÔ¨Çows (for accessing CCDB objects).

‚Ä¢ Experts can bypass this by using CCDB snapshots.

‚Ä¢ O2DPG MC workÔ¨Çows automatically fetch each object once and store them as snapshots for future use.

‚Ä¢ The default storage path for these snapshots is ${WORKDIR}/ccdb/<path>/<in>/<ccdb>/snapshot.root.

---

üëâ Example: run/SimExamples/JustPrimaryKinematics

‚Ä¢ hepmc              (use events from a HepMC file)

üëâ Example: run/SimExamples/HepMC_STARlight

o2-sim -g [ pythia8pp | pythia8hi | boxgen | extkinO2 | hepmc ] ‚Ä¶

15
Generators: Pythia8

‚Ä¢ Pythia8 is more deeply integrated into O2 

(compared to other generators) and is recommended 

for use whenever possible

‚Ä¢ If Pythia8 is utilized, it can be fully customized 

via a specialized text file and the GeneratorPythia8 parameter

‚Ä¢ Valid configuration settings are detailed in the Pythia8 reference 

manual

‚Ä¢ We also offer a tool, mkpy8cfg.py, to assist 

in creating the configuration file

üëâ Example: 
Run/SimExamples/Jet_Embedding_Pythia8

pythia8.cfg

### random 
Random:setSeed = on 
Random:seed = 130145275 

### beams 
Beams:idA = 1000822080 
Beams:idB = 1000822080 
Beams:eCM = 5020.000000 

### processes

---

‚Ä¢ o2-sim is capable of handling HepMC files right out of the box; however, data can also be read from FIFOs.

‚Ä¢ HepMC3 is the standard, but HepMC2.06 data is compatible for both local file generation and FIFO data.

Using the command: o2-sim -n 10 -g hepmc --configKeyValues "HepMC.fileName=/path_to/file.hepmc"

or for version 2: --configKeyValues 'HepMC.fileName=/path_to/file.hepmc;HepMC.version=2'

Another feature is the ability to launch event generators via the cmd parameter of GeneratorHepMC; this allows generators to print data directly to stdout, eliminating the need for large local .hepmc files.

For automatic FIFO generation, use the run/SimExamples/HepMC_EPOS4 script.

Command: o2-sim -n 100 -g hepmc --seed 12345 --configKeyValues "GeneratorFileOrCmd.cmd=epos.sh;GeneratorFileOrCmd.bMaxSwitch=none;HepMC.version=2"

For more details, see <HERE>.

18
ADVANCED

Generators: Triggering

üëâ Example: 
Run/SimExamples/Selective_Transport_pi0

‚Ä¢ Event filtering or triggering is also flexible.

---

‚Ä¢ Transform the Directed Acyclic Graph (DAG) into a basic shell script that can be executed independently.

o2dpg_workflow_runner.py -f workflow.json -tt digi
o2dpg_workflow_runner.py -f workflow.json -tt aod

"First run the workflow until digitization, then proceed to AOD stage, without repeating completed tasks!
o2dpg_workflow_runner.py -f workflow.json -tt aod
--produce-script my_script.sh
"Generate a simple shell script to execute the entire process sequentially up to the AOD stage."

‚Ä¢ Additional useful features are available

‚Ä¢ As usual, use o2dpg_workflow_runner.py --help to view the available options.

32
Execute MC jobs on the GRID

‚Ä¢ The MC workflow can be run on the GRID up to the AOD generation stage.

‚Üí Both O2DPG-MC steps will be executed from a script, example.sh O2DPG-MC script.

---

DOCUMENT:
    workÔ¨Çow.json

A basic example‚Ä¶

23
Fundamentals of O2DPG-MC

A comprehensive real-life example with just 
2 timeframes is significantly larger‚Ä¶
‚Ä¢ Running a Monte Carlo (MC) job involves separating configuration logic from execution logic

1. Formulate a valid and configured description of an MC job, termed as a ‚ÄúworkÔ¨Çow‚Äù

WorkÔ¨Çow creator

Constructs a coherent, integrated MC 
workÔ¨Çow in a directed-acyclic-graph (DAG) format, described as a JSON, 
reflecting the dependencies between tasks

Customizes the MC workÔ¨Çow based on 
key user parameters
‚Ä¢ Collision system, generators, interaction rate, number of 
timeframes

workÔ¨Çow.json

24
Fundamentals of O2DPG-MC

‚Ä¢ Running an MC job involves separating configuration logic from execution logic

‚Ä¢ Step One: Formulate a valid and configured description of an MC job, termed as a ‚ÄúworkÔ¨Çow‚Äù

‚Ä¢ Step Two: Execute the MC job using a dynamic graph scheduler

WorkÔ¨Çow creator

WorkÔ¨Çow executor

Output (AOD)

---

"Generate 10 default Pythia8 pp events and perform no further actions (pure generator output).

`o2-sim --help` provides details on the main options and shows the default generation parameters.

o2-sim: Kinematics Output

The kinematics output (default file o2sim_Kine.root) from the transport simulation is likely the most useful for physics analysis.

It includes creation vertices, momenta, and other details of primary (generator) and secondary (transport) particles created during the simulation.

The output also contains information about the physics creation process, such as the provenance (mother-daughter relationships), etc.

Based on the o2::MCTrack class, which is essentially a lightweight version of TParticle.

For each event, there is one entry of vector<MCTracks> in a TTree.

By default, the kinematics are pruned, keeping only relevant particles.

Additionally, there is a separate file (o2sim_MCHeader.root) containing event-level metadata for each generated event, for example, the impact parameter of a PbPb collision."

---

‚Ä¢ Assist us in enhancing the documentation, which is currently in its initial phase!

‚Ä¶ and much more

36
Backup
Digitization, embedding (signal mixing)

‚Ä¢ Digitization might be less crucial for physics analysis ‚Ä¶ yet it‚Äôs essential to be aware of it

‚Ä¢ The core function of digitization is to

‚Ä¢ transform straightforward energy deposits into detector signals (digits), ultimately mirroring the raw detector output

‚Ä¢ place individual generated events into a timeframe collection

‚Ä¢ consider pileup effects and triggering

‚Ä¢ Digitization as a signal embedding / mixing system

‚Ä¢ Digitization can serve as an event-mixing / event-embedding system

‚Ä¢ signal-background embedding permits the inclusion of signal events within a repeated background event collection (saves transport simulation time)

‚Ä¢ Can create sequences of event types within a timeframe (a signal event following every n-th min-bias event)

üëâ Embedding example in O2DPG: 
PWGHF embedding

38
Estimate resources

---

‚Ä¢ For example, impact parameter in PbPb collisions

‚Äúhistogram of production vertex-y for all 
MCtracks (both primary and secondary)‚Äù

13
Helper classes to access MC kinematics

üëâ Example: 
Run/SimExamples/Jet_Embedding_Pythia8

‚Ä¢ Interactively accessing and navigating MC kinematics 
can be tedious (similar to ‚ÄúROOT-IO boilerplate‚Äù)

using o2::steer;
using o2;

// use simulation prefix o2sim to access kinematics file
MCKinematicsReader reader("o2sim", MCKinematicsReader::Mode::kMCKine);

‚Ä¢ Provide 2 key utility classes simplifying this process

// retrieve all Monte Carlo tracks for the current event
std::vector<MCTrack> const& tracks = reader.getTracks(event);

for users

‚Ä¢ MCKinematicsReader - Class for simple reading and 
retrieval of tracks for a specific event or Monte Carlo 
label

‚Ä¢ MCTrackNavigator - Class for traversing the mother-daughter 
tree structure of MC tracks and querying physics properties

---

‚Ä¢ Predefined run numbers for Monte Carlo simulations are documented here: 
https://twiki.cern.ch/twiki/bin/view/ALICE/O2D
PGMCSamplingSchema

‚Ä¢ For example, a run number of 310000 can be used for a PbPb simulation with a field of -0.5T, which should fetch appropriate CCDB objects.

‚Ä¢ The recommended approach involves:

‚Ä¢ Documentation
‚Ä¢ Official configuration folder
Workflows creation: Generator configuration
‚Ä¢ Custom configurations can be specified to the generation workflow through .ini files

o2dpg_sim_workflow.py -gen pythia8 -ini <path/to/config.ini>

‚Ä¢ These files include sections for generator settings and can also include additional triggers for the generated particles

‚Ä¢ Official configurations are typically found in O2DPG/MC/config/<PWG>/ini/<config>.ini and are validated by a CI system when modifications are proposed via PR or when new configurations are added

Snippet from PWGDQ configuration

‚Ä¢ The configurations folder is linked to the O2DPG_MC_CONFIG_ROOT environment variable

---

DOCUMENT:
    for (auto& t : tracks) {
   // process tracks; find the mother track of each track (within the pool of all tracks)
   auto mother = o2::mcutil::MCTrackNavigator::getMother(t, tracks);
   if (mother) {
      std::cout << "This track has a mother\n";
   }
   // identify the (backward first) primary particle from which this track descends
   auto primary = o2::mcutil::MCTrackNavigator::getFirstPrimary(t, tracks);
}

‚ÄúRetrieve all Monte Carlo tracks from the stored kinematics file for event ID 1. Loop through all tracks to determine both the immediate mother particle and the primary ancestor in each case.‚Äù

14
Generators: Basic

‚Ä¢ o2-sim includes several predefined generators (select using the -g option)

‚Ä¢ pythia8pp         (configured Pythia8 for pp interactions)

‚Ä¢ pythia8hi          (configured Pythia8 for PbPb collisions)

‚Ä¢ boxgen             (a straightforward mono-PDG generator)

‚Ä¢ extkinO2           (use external kinematics file, e.g., generated in a preceding step)

üëâ Example: run/SimExamples/JustPrimaryKinematics

---

‚Ä¢ The configurations folder is associated with the 

O2DPG_MC_CONFIG_ROOT environment variable.

Local configurations can be utilized, while also allowing the testing of newer configurations with older O2DPG builds and vice versa.

[GeneratorPythia8]
config = 
${O2DPG_MC_CONFIG_ROOT}/MC/config/common/pythia8/generato
r/pythia8_hf.cfg
hooksFileName = 
${O2DPG_MC_CONFIG_ROOT}/MC/config/PWGHF/pythia8/hooks/pyt
hia8_userhooks_qqbar.C
hooksFuncName = pythia8_userhooks_ccbar(-4.3,-2.3)

31
O2DPG-MC Step 2: Workflow Execution

‚Ä¢ The workflow runner/executor constructs and executes a 

DAG workflow on a compute node.

‚Ä¢ At minimum, it requires a workflow file and a target

${O2DPG_ROOT}/MC/bin/o2dpg_workflow_runner.py -f workflow.json -tt aod

"Execute workflow up to 
aod task (assuming 8-core 
CPU configuration)"

‚Ä¢ Features include checkpointing and incremental build

w
o
n
k
o
t
d
o
o
G

‚Ä¢ The DAG can be transformed into a standalone simple shell script.