## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/DATA/production/common/setVarsFromALIEN_PROC_ID.sh

**Start chunk id:** 1ec64ef65e176b14c6056d5f8d01087bd6e238514249a39452f3e646160ab1d3

## Content

#!/bin/bash

# Script to define a few variables based on ALIEN_PROC_ID.
# As multiple scripts may require these definitions, they are stored in a separate script.

# Let's extract the last 9 digits (for int) and 8 digits (for int16) of ALIEN_PROC_ID to define NUMAID and shm-segment-id via O2JOBID, which are int and int16 types respectively. We will convert these values to int or int16.
ALIEN_PROC_ID_MAX_NDIGITS_INT32=9
ALIEN_PROC_ID_MAX_NDIGITS_INT16=8
if [[ -n $ALIEN_PROC_ID ]]; then
  echo "ALIEN_PROC_ID for the current job is ${ALIEN_PROC_ID}"
else
  ALIEN_PROC_ID=123456789
  echo "ALIEN_PROC_ID was not set for the current job, setting it to ${ALIEN_PROC_ID}"
fi

if [[ -n ${ALIEN_JDL_PACKAGES} ]] && [[ ${#ALIEN_PROC_ID} -lt ${ALIEN_PROC_ID_MAX_NDIGITS_INT32} ]]; then # we are on the grid and we expect to have the PROC_ID
  echo "Cannot determine O2JOBID, the job ID is too short (${ALIEN_PROC_ID}), we need at least ${ALIEN_PROC_ID_MAX_NDIGITS_INT32} digits, exiting with error"
  exit 2
fi

---

DOCUMENT:
    ALIEN_PROC_ID_OFFSET_INT32=$((10#${ALIEN_PROC_ID: -${ALIEN_PROC_ID_MAX_NDIGITS_INT32}}))
echo "ALIEN_PROC_ID_OFFSET_INT32 = $ALIEN_PROC_ID_OFFSET_INT32"

ALIEN_PROC_ID_OFFSET_INT16=$((10#${ALIEN_PROC_ID: -${ALIEN_PROC_ID_MAX_NDIGITS_INT16}}))
echo "ALIEN_PROC_ID_OFFSET_INT16 = $ALIEN_PROC_ID_OFFSET_INT16"

# we'll convert them to int32 or int16, but not to their maximum values (0x7fffffff for int32 and 0x7fff for int16)
# instead, we'll use a smaller value to leave room for adding [0, 15] if needed (like the NUMAID), see https://github.com/AliceO2Group/O2DPG/pull/993#pullrequestreview-1393401475
export O2JOBID=$(((ALIEN_PROC_ID_OFFSET_INT32 & 0x7ffffff) * 16))
export O2JOBSHMID=$(((ALIEN_PROC_ID_OFFSET_INT16 & 0x7ff) * 16))
echo "ALIEN_PROC_ID = $ALIEN_PROC_ID, we will set O2JOBID = $O2JOBID, SHMEMID = $O2JOBSHMID"