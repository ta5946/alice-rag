## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/MC/bin/o2dpg_determine_eventstat.py

**Start chunk id:** 172b10d92b4d1932f32219bfa2519d9fcf240b6e7439aaad14dfdc1cd4b31eb8

## Content

DOCUMENT:
    return matching_files

def read_GEANT_eventcount(file):
    # Open the ROOT file
    eventcount = 0
    tfile = ROOT.TFile.Open(file)
    if tfile:
      simtree = tfile.Get("o2sim")
      if simtree and isinstance(simtree, ROOT.TTree):
        eventcount = simtree.GetEntries()

      tfile.Close()
    return eventcount

def read_accumulated_GEANT_eventcount(directory = "."):
    """
    Calculates the MC eventcount from GEANT kinematics files located
    in directory/tfX/ subdirectories.
    """
    pattern_to_match = r'sgn.*_Kine.root'
    kine_files = find_files_matching_pattern(directory, pattern_to_match)
    eventcount = 0
    for f in kine_files:
      eventcount = eventcount + read_GEANT_eventcount(f)
    return eventcount

def read_AO2D_eventcount(file):
    """
    Determines the MC eventcount from the final AO2D file.
    """
    eventcount = 0

    # Open the ROOT file
    tfile = ROOT.TFile.Open(file)

---

DOCUMENT:
    def create_stat_file(eventcount):
    """
    generates a file following the MonaLisa standard
    """
    
    file_name = '0_0_0_' + str(eventcount) + '.stat'
    # create or open a new file
    with open(file_name, 'w') as f:
      print ("#This file is automatically generated", file=f)
      print ("#It informs MonaLisa about the number of created MC events", file=f)
      print ("#Number of MC collisions in AOD : " + str(eventcount), file=f)

def determine_eventcount_from_collision_context_file(file):
    """
    extracts MC eventcount from collision context files
    """
    pass

def locate_files_matching_pattern(directory='.', pattern='.*'):
    matching_files = []

    # Traverse the directory and its subdirectories
    for root, dirs, files in os.walk(directory):
      for file_name in files:
        # Check if the filename matches the regular expression pattern
        if re.match(pattern, file_name):
          matching_files.append(os.path.join(root, file_name))

    return matching_files

---

if colfound == 0:
  print ("ERROR: MC collision table not found")

    # Close the files
    tfile.Close()
    return eventcount

AO2D_eventcount = read_AO2D_eventcount(args.aod_file)
GEANT_eventcount = read_accumulated_GEANT_eventcount()
if AO2D_eventcount != GEANT_eventcount:
    print ("WARN: Divergence detected between AO2D MC event count and GEANT event count")

print ("Detected " + str(AO2D_eventcount) + " events in AO2D file")
write_stat_file(AO2D_eventcount)

---

#!/usr/bin/env python3

#
# Script that calculates final accounting figures / event counts
# for submission to MonaLisa.
#  
# This script processes the AO2D / kinematics output from an O2DPG simulation run 
# and generates a file named in the format 
#
# inputN_passedN_errorsN_outputN.stat 
# 
# which is then utilized by the MonaLisa system.
#
# Refer to the discussion at https://alice.its.cern.ch/jira/browse/O2-4553;
# In this context, outputN refers to the number of events/collisions generated by this job.

import ROOT
import argparse
import os
import re

parser = argparse.ArgumentParser(description='',
                                 formatter_class=argparse.ArgumentDefaultsHelpFormatter)

parser.add_argument('-f','--aod-file', default="AO2D.root", help='AO2D file to check')
args = parser.parse_args()

---

# Open the ROOT file
tfile = ROOT.TFile.Open(file)

# Retrieve the list of keys (TKeys) in the ROOT file
keys = tfile.GetListOfKeys()

# Loop through the keys that start with "DF_" and gather the MC collisions
colfound = 0

for key in keys:
  key_name = key.GetName()
  if key_name.startswith("DF_"):
    obj = key.ReadObj()

    # Obtain the list of keys for the available tables
    tablelist = obj.GetListOfKeys()
    for tab in tablelist:
      # The O2mccollision_ tree holds the simulated collisions, but since the version number may vary, it's better to iterate over the keys and match them
      tabname = tab.GetName()
      if re.match("^O2mccollision(_[0-9]*)?$", tabname):
        coltreekey = obj.GetKey(tabname)
        coltree = coltreekey.ReadObj()
        if coltree and isinstance(coltree, ROOT.TTree):
          eventcount += coltree.GetEntries()
          colfound += 1