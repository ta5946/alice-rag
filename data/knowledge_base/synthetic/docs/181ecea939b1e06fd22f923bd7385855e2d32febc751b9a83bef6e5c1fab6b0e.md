## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/GRID/utils/fetch_output_onfailure.sh

**Start chunk id:** 181ecea939b1e06fd22f923bd7385855e2d32febc751b9a83bef6e5c1fab6b0e

## Content

DOCUMENT:
    CurrDir=${PWD}
OutputDir=/tmp/AlienLogs_${MY_JOBID}

job_number=${#FAILEDSUBJOBIDS[@]}
echo "Found ${job_number} failed job ids"
echo "Registering output for retrieval"
RecycleBase=""
# Initial loop to register output
for ((i = 0; i < job_number; i++)); do
  jobid=${FAILEDSUBJOBIDS[i]}
  if [ ! "${RecycleBase}" ]; then
    RecycleOutputDir=$(alien.py ps --trace ${jobid} | awk '/Going to uploadOutputFiles/' | sed 's/.*outputDir=//' | sed 's/)//')
    RecycleBase=${RecycleOutputDir%-${jobid}} # Removes the ${jobid} and yields the recycle base path
  fi
  $(alien.py registerOutput ${jobid}) 2> /dev/null
done

# Brief pause to ensure "registerOutput" updates propagate
sleep 1

---

#!/bin/bash

# A script for retrieving error files from each failing subjob of an AliEn GRID masterjob.
MY_JOBID=$1

if [ -z "${MY_JOBID}" ]; then
  echo "Please supply a master job id as the first argument."
  exit 1
fi

# Collecting all subjob ids
SUBJOBIDS=($(alien.py ps --trace ${MY_JOBID} | awk '/Subjob submitted/' | sed 's/.*submitted: //' | tr '\n' ' '))

# Identifying the failed subjob ids
FAILEDSUBJOBIDS=($(alien.py ps -a -m ${MY_JOBID} -f ERROR_ALL | awk '/EE/{print $2}' | tr '\n' ' '))

CurrDir=${PWD}
OutputDir=/tmp/AlienLogs_${MY_JOBID}

---

# pause for a moment to ensure "registerOutput" is propagated
sleep 1

echo "Retrieving outputs"
# second iteration to transfer files
for ((i = 0; i < job_number; i++)); do
  jobid=${FAILEDSUBJOBIDS[i]}
  RecycleOutputDir="${RecycleBase}-${jobid}"
  alien.py cp ${RecycleOutputDir}/'*archive*' file:${OutputDir}/${jobid}
  [ -f ${OutputDir}/${jobid}/log_archive.zip ] && unzip -q -o ${OutputDir}/${jobid}/log_archive.zip -d ${OutputDir}/${jobid}
done

echo " ... Initiating automatic log file extraction ... "

# We identify the O2DPG task that failed (as mentioned in stdout) and proceed to automatically extract the pertinent logs
# Note that errors might arise outside of O2DPG tasks or in preprocessing stages and may not be evident in the logs
cd ${OutputDir}
# execute the extraction script
${O2DPG_ROOT}/GRID/utils/extractErroredLogFiles.sh
echo "Logs have been extracted to ${OutputDir}"
cd ${CurrDir}