## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/test/README.md

**Start chunk id:** 0995e3f3eddf60bfec18ac391f59e268164bb49e69ecf1e46419bf5317e3361d

## Content

### Implementing Tests

When an `ini` file is identified for testing, a corresponding test macro must be included to validate the simulation kinematics. This macro should reside in a `tests/` directory adjacent to the `ini` file. The macro must be named as follows:
```bash
<name-of-ini-file>.C
```
It's important to note that `run_tests.sh` automatically recognizes all generators specified in the `ini` file. At least one test must be provided for each generator listed in the `ini`. Each test is encapsulated within a function in the `<name-of-ini-file>.C` macro. For instance, if you are testing `External` and `Pythia8`, the macro should include:
```cpp
int Pythia8()
{
    // perform your test
    return ret;
}

int External()
{
    // perform your test
    return ret;
}
```
The function should return an integer, `0` for success, and a non-zero value for failure.

---

## Important notes and instructions

### Local Test Execution

To run tests when an `O2DPG` environment is active and the development source directory differs from `O2DPG_ROOT`, execute
```bash
O2DPG_TEST_REPO_DIR=</path/to/source/O2DPG> ${O2DPG_ROOT}/test/run_tests.sh [--fail-immediately]
```
If you are within the source directory, you can simply run
```bash
${O2DPG_ROOT}/test/run_tests.sh [--fail-immediately]
```

### Preservation of Test Artifacts

By default, only logs are retained after each test, freeing up disk space. To keep all artifacts, use
```bash
${O2DPG_ROOT}/test/run_tests.sh --keep-artifacts
```

### Additional Assistance

For further guidance, run
```bash
${O2DPG_ROOT}/test/run_tests.sh -h
```
which provides the usage details.

---

# Tests related to O2DPG


## Generator-related tests

Currently, these tests concentrate on generator configurations and custom generators as specified in the corresponding `ini` files.

Tests are executed using
```bash
${O2DPG_ROOT}/test/run_tests.sh [--fail-immediately]
```

They cover changes in:
1. generator `ini` files,
1. test macros associated with specific generator `ini` files,
1. macros referenced in generator `ini` files,
1. macros included in macros referenced in generator `ini` files.

Using the `--fail-immediately` flag will stop the process as soon a test fails. Otherwise, all tests will be attempted.

---

FLAGS:

  --fail-immediately : terminate immediately upon the first test failure
  --keep-artifacts : retain simulation and test artifacts; by default, only logs are preserved after each test

ENVIRONMENT VARIABLES:

  O2DPG_TEST_REPO_DIR : specify the source repository to be tested.
  O2DPG_TEST_HASH_BASE : the base hash for comparison (optional)
  O2DPG_TEST_HASH_HEAD : the head hash for comparison (optional)

If O2DPG_TEST_HASH_BASE is not defined, it defaults to ALIBUILD_BASE_HASH.
If ALIBUILD_BASE_HASH is also undefined, it defaults to HEAD~1, but if there are uncommitted changes, it defaults to HEAD.

If O2DPG_TEST_HASH_HEAD is not defined, it defaults to ALIBUILD_HEAD_HASH.
If ALIBUILD_HEAD_HASH is also undefined, it defaults to HEAD, but if there are uncommitted changes, it remains blank.