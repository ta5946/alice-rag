## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/DATA/production/calib/hmp-pedestals-processing.sh

**Start chunk id:** 20d21639e797b61642e4779478388b1705f259b748301a361c9406738c6f85c5

## Content

# Here we build the workflow
# Begin with an empty workflow
WORKFLOW=
add_W o2-dpl-raw-proxy "--dataspec \"$PROXY_INSPEC\" --inject-missing-data --channel-config \"name=readout-proxy,type=pull,method=connect,address=ipc://@$INRAWCHANNAME,rateLogging=1,transport=shmem\"" "" 0
add_W o2-hmpid-raw-to-pedestals-workflow "--fast-decode $SPEC_PARAM"

# Add the o2-dpl-run workflow manually, either execute it or print the workflow (default)
WORKFLOW+="o2-dpl-run ${ARGS_ALL} ${GLOBALDPLOPT}"

[[ $WORKFLOWMODE != "print" ]] && WORKFLOW+=" --${WORKFLOWMODE} ${WORKFLOWMODE_FILE:-}"
[[ $WORKFLOWMODE == "print" || "${PRINT_WORKFLOW:-}" == "1" ]] && echo "#HMPID Pedestals Calculation (v.3) workflow command:\n\n${WORKFLOW}\n" | sed -e "s/\\\\n/\n/g" -e"s/| */| \\\\\n/g" | eval cat $( [[ $WORKFLOWMODE == "dds" ]] && echo '1>&2')
if [[ $WORKFLOWMODE != "print" ]]; then eval $WORKFLOW; else true; fi

# -------  EOF --------

---

#!/bin/bash

# ------------------------------------------------------------------------
#         ALICE HMPID detector
# Workflow to calculate pedestals   v.3.0  = 24/08/2023
#
#  Additional Environment Variables:
#     HMP_SIGMACUT : The value of sigma for the threshold cut (default=4)
#     HMP_CCDB_REC : Whether to record into ALICE CCDB (default=False)
#     HMP_PED_TAG :  A string to tag the pedestals (default=Latest)
#     HMP_NODCSCCDB_REC : Whether to disable DCS CCDB recording (default=False)
#     HMP_FILES_REC : Whether to store on files (for debug purposes only, default=False)
#
#   14/09/2023 - rebased
#
#   Auth. A.Franco  - INFN  Sez.BARI - ITALY
# ------------------------------------------------------------------------

# Set general arguments
source common/setenv.sh
source common/gen_topo_helper_functions.sh
source common/getCommonArgs.sh

# Define the Input/Output streams
PROXY_INSPEC="A:HMP/RAWDATA;dd:FLP/DISTSUBTIMEFRAME/0"
PROXY_OUTSPEC="A:HMP/RAWDATA;dd:FLP/DISTSUBTIMEFRAME/0"

---

# Set the HMP additional environment variables.
if [ -z ${HMP_SIGMACUT+x} ];
then
    HMP_SIGMACUT="4"
fi
if [ -z ${HMP_NODCSCCDB_REC+x} ];
then
    HMP_NODCSCCDB_REC="false"
else
    HMP_NODCSCCDB_REC="true"
fi
if [ -z ${HMP_CCDB_REC+x} ];
then
    HMP_CCDB_REC="false"
else
    HMP_CCDB_REC="true"
fi
if [ -z ${HMP_FILES_REC+x} ];
then
    HMP_FILES_REC="false"
else
    HMP_FILES_REC="true"
fi
if [ -z ${HMP_PED_TAG+x} ];
then
    HMP_PED_TAG="Latest"
fi

# Define specific parameters
SPEC_PARAM=""
if [ $HMP_NODCSCCDB_REC == 'false' ];
then
  SPEC_PARAM+="--use-dcsccdb --dcsccdb-uri $DCSCCDBSERVER_PERS --dcsccdb-alivehours 3 "
fi
if [ $HMP_CCDB_REC == 'true' ];
then
  SPEC_PARAM+="--use-ccdb --ccdb-uri 'http://o2-ccdb.internal' "
fi
if [ $HMP_FILES_REC == 'true' ];
then
  SPEC_PARAM+="--use-files "
fi

SPEC_PARAM+="--files-basepath 'HMP' "
SPEC_PARAM+="--pedestals-tag ${HMP_PED_TAG} --sigmacut ${HMP_SIGMACUT}"