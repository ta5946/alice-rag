## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/test/run_relval_tests.sh

**Start chunk id:** 1b03d51b5b0df8fbda66e326bebfa05ce19563750a7caacefd3758f219640bee

## Content

while [ "$1" != "" ]; do
    case $1 in
        --help|-h )          print_usage
                             exit 1
                             ;;
        * )                  echo "Unknown argument ${1}"
                             exit 1
                             ;;
    esac
done

echo
echo "############################"
echo "# Run O2DPG RelVal testing #"
echo "############################"
echo

REPO_DIR=${O2DPG_TEST_REPO_DIR:-$(get_git_repo_directory)}
if [[ ! -d ${REPO_DIR}/.git ]]; then
    echo_red "Directory \"${REPO_DIR}\" is not a git repository."
    exit 1
fi

if [[ -z ${O2DPG_ROOT+x} ]]; then
    echo_red "O2DPG is not loaded, suggesting that other necessary packages might be missing in this environment."
    exit 1
fi

# source the utilities
source ${REPO_DIR}/test/common/utils/utils.sh

# perform initial steps in the source directory where the complete git repository resides
pushd ${REPO_DIR} > /dev/null

---

# Return to the previous directory
popd > /dev/null

# If a central test fails, the exit code will not be 0
if [[ "${ret_global}" != "0" ]] ; then
    echo
    echo "####################"
    echo "# ERROR for RelVal #"
    echo "####################"
    echo
    print_error_logs ${TEST_PARENT_DIR}
    exit ${ret_global}
fi

echo
echo_green "RelVal tests completed successfully"
echo

exit 0

---

# influx
${O2DPG_ROOT}/RelVal/o2dpg_release_validation.py influx --path rel_val_${filename1}_${filename2}_dir >> ${LOG_FILE} 2>&1
ret=$?
[[ ${ret} != 0 ]] && { echo "[FATAL]: O2DPG_TEST failed" >> ${LOG_FILE} ; return ${ret} ; }
# view
${O2DPG_ROOT}/RelVal/o2dpg_release_validation.py print --object-names --interpretations GOOD --path rel_val_${filename1}_${filename2}_dir >> ${LOG_FILE} 2>&1
ret=$?
[[ ${ret} != 0 ]] && { echo "[FATAL]: O2DPG_TEST failed" >> ${LOG_FILE} ; return ${ret} ; }
return ${ret}
}

---

print_usage()
{
    echo
    echo "usage: run_workflow_tests.sh"
    echo
    echo "  ENVIRONMENT VARIABLES:"
    echo
    echo "  O2DPG_TEST_REPO_DIR : Specify the source repository to test."
    echo "  O2DPG_TEST_HASH_BASE : The base hash for comparison (optional)"
    echo "  O2DPG_TEST_HASH_HEAD : The head hash for comparison (optional)"
    echo
    echo "  If O2DPG_TEST_HASH_BASE is not defined, it will default to ALIBUILD_BASE_HASH."
    echo "  If ALIBUILD_BASE_HASH is also not set, it will default to HEAD~1, but if there are uncommitted changes, it will default to HEAD."
    echo
    echo "  If O2DPG_TEST_HASH_HEAD is not defined, it will default to ALIBUILD_HEAD_HASH."
    echo "  If ALIBUILD_HEAD_HASH is also not set, it will default to HEAD, or remain empty if there are uncommitted changes."
    echo
}

---

test_relval()
{
    # create 3 files for processing
    local filename1="file1.root"
    local filename2="file2.root"
    local filename3="file3.root"
    root -l -b -q ${O2DPG_ROOT}/test/RelVal/createTestFile.C\(\"${filename1}\"\) >> ${LOG_FILE} 2>&1
    root -l -b -q ${O2DPG_ROOT}/test/RelVal/createTestFile.C\(\"${filename2}\"\) >> ${LOG_FILE} 2>&1
    root -l -b -q ${O2DPG_ROOT}/test/RelVal/createTestFile.C\(\"${filename3}\"\) >> ${LOG_FILE} 2>&1
    echo "### Testing RelVal ###" > ${LOG_FILE}
    # perform validation
    ${O2DPG_ROOT}/RelVal/o2dpg_release_validation.py rel-val -i ${filename1} -j ${filename2} -o rel_val_${filename1}_${filename2}_dir >> ${LOG_FILE} 2>&1
    local ret=$?
    [[ ${ret} != "0" ]] && { echo "[FATAL]: O2DPG_TEST failed" >> ${LOG_FILE} ; return ${ret} ; }
    ${O2DPG_ROOT}/RelVal/o2dpg_release_validation.py rel-val -i ${filename1} -j ${filename3} -o rel_val_${filename1}_${filename3}_dir >> ${LOG_FILE} 2>&1
    ret=$?
}

---

#!/bin/bash

# The test parent directory to be created in the current directory
TEST_PARENT_DIR="o2dpg_tests/relval"

# unified names for log files
LOG_FILE="o2dpg-test-relval.log"

# Prepare some colored output
SRED="\033[0;31m"
SGREEN="\033[0;32m"
SEND="\033[0m"


echo_green()
{
    echo -e "${SGREEN}${*}${SEND}"
}


echo_red()
{
    echo -e "${SRED}${*}${SEND}"
}


get_git_repo_path()
{
    local repo=
    if [[ -d .git ]] ; then
        pwd
    else
        repo=$(git rev-parse --git-dir 2> /dev/null)
    fi
    [[ "${repo}" != "" ]] && repo=${repo%%/.git}
    echo ${repo}
}

---

DOCUMENT:
    ret=$?
    [[ ${ret} -ne 0 ]] && { echo "[FATAL]: O2DPG_TEST failed" >> ${LOG_FILE} ; return ${ret} ; }
    # inspect
    ${O2DPG_ROOT}/RelVal/o2dpg_release_validation.py inspect --path rel_val_${filename1}_${filename2}_dir >> ${LOG_FILE} 2>&1
    ret=$?
    [[ ${ret} -ne 0 ]] && { echo "[FATAL]: O2DPG_TEST failed" >> ${LOG_FILE} ; return ${ret} ; }
    ${O2DPG_ROOT}/RelVal/o2dpg_release_validation.py inspect --path rel_val_${filename1}_${filename3}_dir >> ${LOG_FILE} 2>&1
    ret=$?
    [[ ${ret} -ne 0 ]] && { echo "[FATAL]: O2DPG_TEST failed" >> ${LOG_FILE} ; return ${ret} ; }
    # compare
    ${O2DPG_ROOT}/RelVal/o2dpg_release_validation.py compare -i rel_val_${filename1}_${filename2}_dir -j rel_val_${filename1}_${filename3}_dir -o compare >> ${LOG_FILE} 2>&1
    ret=$?
    [[ ${ret} -ne 0 ]] && { echo "[FATAL]: O2DPG_TEST failed" >> ${LOG_FILE} ; return ${ret} ; }
    # influx

---

# flag if any RelVal files changed
need_testing=$(git_get_changed_files | grep "RelVal/")

# return to the previous directory
popd > /dev/null
REPO_DIR=$(realpath ${REPO_DIR})

# Now, let's do the following:
# We utilize the source directory since O2DPG's installation is essentially a copy of the entire repository.
# This is particularly useful for local testing but also works similarly in the CI environment. We could have done
#         [[ -z {ALIBUILD_HEAD_HASH+x} ]] && export O2DPG_ROOT=${REPO_DIR}
# but let's maintain consistency for both local and CI.
export O2DPG_ROOT=${REPO_DIR}


###############
# Let's proceed #
###############
ret_global=0
# prepare a local test directory for PWG tests
rm -rf ${TEST_PARENT_DIR} 2>/dev/null
mkdir -p ${TEST_PARENT_DIR} 2>/dev/null
pushd ${TEST_PARENT_DIR} > /dev/null

# Test the changed files
if [[ "${need_testing}" != "" ]] ; then
    test_relval
    ret_global=${?}
else
    echo "No files to test"
    exit 0
fi

# return to the original directory
popd > /dev/null