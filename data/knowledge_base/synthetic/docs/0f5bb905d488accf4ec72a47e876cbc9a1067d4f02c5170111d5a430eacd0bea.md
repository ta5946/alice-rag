## Metadata

**Document link:** https://github.com/AliceO2Group/AliceO2/blob/dev/run/SimExamples/SimAsService_biasing1/run.sh

**Start chunk id:** 0f5bb905d488accf4ec72a47e876cbc9a1067d4f02c5170111d5a430eacd0bea

## Content

MODULES="PIPE ITS TPC TOF"
NWORKERS=8
NTRIALEVENTS=20 # number of trial events per batch
NTRIGGEREDEVENTS=20  # number of targeted triggered events

# helper to generate a random file name
# TODO: use FIFO or ramfiles instead of actual files on the disc
rname1=$(hexdump -n 16 -v -e '/1 "%02X"' -e '/16 "\n"' /dev/urandom | head -c 6)

set -x
### step 1: Initialize the first service with a partial detector configuration

( o2-sim-client.py --startup "-j ${NWORKERS} -n 0 -m ${MODULES} -o simservice --configFile sim_step1.ini" \
                   --block ) | tee /tmp/${rname1}  # <--- continue until everything is fully initialized
SERVICE1_PID=$(grep "detached as pid" /tmp/${rname1} | awk '//{print $4}')

---

DOCUMENT:
    rm /tmp/${rname1}*

# SIMULATE REMAINING PRIMARIES FOR GOOD TRIGGERED EVENTS
o2-sim-client.py --pid ${SERVICE2_PID} --command "-g extkinO2 --extKinFile filtered_Kine.root -n ${NTRIGGEREDEVENTS} -o filtered_part2 \
                                                  --configKeyValues GeneratorFromO2Kine.continueMode=true" --block

# STOP THE SERVICES
o2-sim-client.py --pid ${SERVICE1_PID} --command "--stop 1"
o2-sim-client.py --pid ${SERVICE2_PID} --command "--stop 1"

sleep 1

# ADDITIONAL SAFETY MEASURES TO ENSURE ALL PROCESSES ARE STOPPED
. ${O2_ROOT}/share/scripts/jobutils.sh
for p in $(childprocs ${SERVICE1_PID}); do
  kill -9 ${p}
done
. ${O2_ROOT}/share/scripts/jobutils.sh
for p in $(childprocs ${SERVICE2_PID}); do
  kill -9 ${p}
done

---

#!/usr/bin/env bash
#
# This document illustrates how to run simulations as a service and interact with them using a client control script. Specifically, it demonstrates using the service to implement event biasing through a feedback control loop, where an external "broker" triggers on simulated events and initiates additional simulations until a target is met.
#
# The steps covered include:
# a) starting several simulations in service mode
# b) requesting a batch of events from the crude service until a specified number of triggered events is accumulated
# c) continuing the simulation of successful events for the remaining primary events
#
# NOTE:
# - This example primarily aims to showcase the sim-service in a complex scenario
# - While event biasing can be achieved this way, alternative methods (such as directly within o2-sim) might be more efficient (this example serves as a basic approach for comparison).

---

### filter out good events
ln -nsf simservice_grp.root batch${batch}_grp.root
command="broker.macro('-g extkinO2 --extKinFile batch'${batch}'_Kine.root --trigger external --configFile sim_step2.ini', 'batch'${batch}', 'filtered')"
(root -b -l -q "${command}") &> /tmp/${rname1}_${batch}

triggercount=$(grep "TRIGGER-COUNT" /tmp/${rname1}_${batch} | awk '{print $2}')

biasedcount=$((biasedcount + triggercount))
batch=$((batch + 1))
trialevents=$((trialevents + NTRIALEVENTS))
done
echo "========================================"
echo "Transported ${trialevents} trial events."
echo "Triggered on ${biasedcount} events.     "
echo "****************************************"

rm /tmp/${rname1}*

---

#   it should eventually become more efficient (the current example can be regarded as an initial baseline)
# - This script combines executables and ROOT macros, but a future approach could involve using PyROOT, which would allow for easier access to results and better reuse of compiled macros.

---

# A secondary service is utilized for continuation functions (at present, engine/stack reconfiguration is constrained, hence the primary service might also suffice).
(o2-sim-client.py --startup "-j ${NWORKERS} -n 0 -m ${MODULES} -o simservice2 --configKeyValues GeneratorFromO2Kine.continueMode=true;align-geom.mDetectors=none" \
                   --block ) | tee /tmp/${rname1}  # <--- proceed once full initialization is complete
SERVICE2_PID=$(grep "detached as pid" /tmp/${rname1} | awk '//{print $4}')

# sleep 20

# LOOP FOR BIASING
biasedcount=0
batch=0
trialevents=0
while (( biasedcount < ${NTRIGGEREDEVENTS} )); do
  ### simulate a few events using service 1
  o2-sim-client.py --pid ${SERVICE1_PID} --command "-g pythia8pp -n ${NTRIALEVENTS} --configFile sim_step1.ini -o batch${batch}" --block