## Metadata

**Document link:** https://github.com/AliceO2Group/simulation/blob/main/docs/generators/generatorconfig.md

**Start chunk id:** 1fe87141a85704e72f2e74cffe12b7f4fda8ac540af1bae2f8d4351776359325

## Content

In addition, the `o2sim_Kine.root` file undergoes automatic testing by several generic tests. For example, it confirms that there are particles designated for transport. If such particles are missing, the test will fail. Furthermore, it ensures that the particles' status codes are accurately set (for detailed information on status codes, refer to [this section](#generator-status-codes-flagging-particles-to-be-trackedtransported)).

For a practical example of a test, see [this test](https://github.com/AliceO2Group/O2DPG/blob/546ec5d03a57d189b4ea3c92c5a8e1d7af812d41/MC/config/PWGDQ/ini/tests/GeneratorHF_JPsiToMuons_fwdy.C).

**Note** that the tests are run whenever macros in a configuration file are modified or when the tests themselves are updated.

### Execute the test locally

---

If O2DPG_TEST_HASH_HEAD is not defined, the system will check for ALIBUILD_HEAD_HASH. If that is also not defined, it will default to HEAD. However, if there are any unstaged changes, it will remain blank.

---

In the O2 framework, `TParticle` objects are utilized to represent particles on the internal stack. These objects contain only one integer member to hold a potential status code. To accommodate two status codes simultaneously, they are **encoded into a single integer**. Furthermore, a `TParticle` object can be marked for transport. Here is an example code snippet:
```cpp
TParticle p(pdg, statusCode, parent1, parent2, child1, child2, px, py, pz, e, vx, vy, vz, t);
// Encode HepMC and native codes, and set the tracking flag
o2::mcutils::MCGenHelper::encodeParticleStatusAndTracking(p, hepMCCode, nativeCode, hepMCCode == 1);
```
It is important to note that calling `p.GetStatusCode()` will now return a seemingly unusual integer. This is due to the two status codes being combined into a single number.

---

## Generator Tests

At least one generator configured by an `ini` file should have a corresponding test in O2DPG. This test should be placed in `O2DPG/MC/config/<PWG>/ini/tests/<config>.C`, matching the name of the configuration file one directory above. The test aims to verify the integrity of the `o2sim_Kine.root` file, which is generated during a simulation run.
You can assume the file is in the current directory when performing the test. For more details on MC kinematic files, refer to [MC Kinematic Files](../transport/mckine.md).

A test macro typically follows this structure:
```cpp
int Pythia8()
{
    // potential preparation steps

    // example of opening the kinematics file and reading MC tracks
    std::string path{"o2sim_Kine.root"};
    TFile file(path.c_str(), "READ");

    o2::steer::MCKinematicsReader reader("o2sim", o2::steer::MCKinematicsReader::Mode::kMCKine);
    auto nEvents = reader.getNEvents(0); // retrieve events from source 0, the sole source for this example
```

---

---

sort: 4
title: Generator configuration

---

# Generator configuration

Multiple methods exist to provide specific generator configurations for the simulation run. For example:
```bash
o2-sim --configFile <path/to/config.ini>
```

Likewise, this can be done for the [`o2dpg_sim_workflow.py`](../o2dpgworkflow/README.md/#workflow-creation) using:
```bash
o2dpg_sim_workflow.py -gen pythia8 -ini <path/to/config.ini>
```

This method is recommended and we are currently in a transition period, after which it will be the sole accepted method for generator configuration in official GRID productions. Furthermore, configuration files must now be located in the [O2DPG Git repository](https://github.com/AliceO2Group/O2DPG). As a result, a new CI process has been implemented to test all these files (hereafter simply referred to as `ini` files).

---

### Ongoing Work

* Establish a consistent framework for global generator IDs [O2-3963](https://alice.its.cern.ch/jira/browse/O2-3963). The goal is to have clear and standardized IDs for all event generators in our system.
* As mentioned, a sub-generator ID and a brief description are included. This is mirrored in the global generator setup (`o2-sim --configKeyValues "PrimaryGenerator.description=a short description"`). We intend to integrate these annotations into the AOD metadata so that a lookup from generator and sub-generator IDs to their descriptions becomes feasible.

---

## Indicators for particle tracking in the O2 simulation

Particles generated typically carry a status code. In O2, two status codes are utilized: the **HepMC** code (refer to [this](https://arxiv.org/pdf/1912.08005.pdf) for details) and the **native** code specific to the generator. For example, Pythia8 employs numerous distinct [status codes](https://pythia.org/latest-manual/ParticleProperties.html).

---

In the provided example, `Pythia8` and `External` are specified in the file, indicating that these configurations will be utilized based on the `-g <generator>` argument in `o2-sim`. It's important to note that multiple configurations can be active simultaneously. For example, if your `external` generator inherits from `GeneratorPythia8`, both the `External` and `Pythia8` sections of your configuration will be applied. The `ini` files utilize the `O2DPG_MC_CONFIG_ROOT` environment variable, which defaults to the `O2DPG_ROOT` directory of the currently loaded build. However, this variable can be modified with `export O2DPG_MC_CONFIG_ROOT=<new/path/here>` after setting up the environment, allowing users to run older committed configurations with a newer O2DPG version and vice versa.

---

The test aims to validate code modifications and assess their effects. To identify the modified files, the script uses `git diff` between specified pairs of commits.
* When there are uncommitted changes, the test compares them relative to `HEAD`.
* If there are no uncommitted changes in `${O2DPG_SOURCE}`, the test will, by default, compare `HEAD` (assuming this reflects the changes you made) with `HEAD~1`.
* To test the changes between two specific commits, you must set `O2DPG_TEST_HASH_BASE=<base-commit>` and `O2DPG_TEST_HASH_HEAD=<later-commit>` (refer to the example below).

The full command is
```bash
O2DPT_TEST_REPO_DIR=${O2DPG_SOURCE} O2DPG_TEST_HASH_BASE=<base-commit> O2DPG_TEST_HASH_HEAD=<later-commit> ${O2DPG_ROOT}/test/run_generator_tests.sh
```

The results will be recorded in `o2dpg_tests`.

---

```
bool importImpl(int sampledSubGenID) {
    // carry out the actual import based on the sampled ID
}

bool importParticles()
{
    // e.g., sample a condition and then derive the ID to be set from that condition
    int sampledSubGenID = sampleSubGenID();
    notifySubGenerator(sampledSubGenID);
    return importImpl(sampledSubGenID);
}

```

To retrieve this ID for analysis, the `mcCollisions` table offers the getter `getSubGeneratorID()`.

### Origin ID

The origin ID pertains to the source in [embedding simulations](../o2dpgworkflow/README.md#embedding). For example, if a particular signal is embedded within background, the origin ID of the signal collision would be `0`, while the background collision would have the value `1`.

**Note** that users do not have the capability to modify these values directly.

To retrieve that ID during analysis, the `mcCollisions` table provides the getter `mcCollision::getSourceId()`.

### In Development

```

---

The results will be stored in `o2dpg_tests`.

To see the available additional environment variables and options, run
```bash
${O2DPG_ROOT}/test/run_generator_tests.sh -h

usage: run_tests.sh [--fail-immediately] [--keep-artifacts]

  FLAGS:

  --fail-immediately : stop immediately if a test fails
  --keep-artifacts : retain simulation and test artifacts; otherwise, only logs are kept after each test

  ENVIRONMENT VARIABLES:

  O2DPG_TEST_REPO_DIR : Specify the source repository to test. (required if the current or parent directory is not the git repository being tested)
  O2DPG_TEST_HASH_BASE : The base hash for comparison (optional)
  O2DPG_TEST_HASH_HEAD : The head hash for comparison (optional)

  If O2DPG_TEST_HASH_BASE is not set, it will check for ALIBUILD_BASE_HASH.
  If that is also not set, it will default to HEAD~1. However, if there are uncommitted changes, it will use HEAD instead.

---

WHEN YOU CREATE A PARTICLE IN A C++ CONTAINER LIKE `std::vector` IN PLACE, ENSURE YOU SET THE APPROPRIATE PROPERTIES FOR THE OBJECT IN THAT CONTAINER. FOR EXAMPLE:

```cpp
aVector.push_back(TParticle(pdg, statusCode, parent1, parent2, child1, child2, px, py, pz, e, vx, vy, vz, t));
o2::mcutils::MCGenHelper::encodeParticleStatusAndTracking(aVector.back(), hepMCCode, nativeCode, hepMCCode == 1);
```

THE [O2 ANALYSIS DATA MODEL](https://aliceo2group.github.io/analysis-framework/docs/datamodel/ao2dTables.html) OFFERS FEATURES TO RETRIEVE THE STATUS CODES IN A DISTINCT WAY IN ANALYSIS CODE. FOR AN `o2::aod::mcparticle`, USE THE GETTERS `getHepMCStatusCode()` AND `getGenStatusCode()`.

## Generator Identifiers

GENERATOR IDENTIFIERS CAN BE ASSIGNED TO GENERATORS. THESE IDENTIFIERS ARE SET PER EVENT TO SHOW WHICH GENERATOR WAS RESPONSIBLE FOR THAT EVENT.

TWO TYPES OF GENERATOR IDENTIFIERS EXIST: A GLOBAL ID AND A "SUB-GENERATOR" ID.

---

The configuration files are typically stored in `O2DPG/MC/config/<PWG>/ini/<config>.ini`. They can include various sections for configuring generators, and they also allow for the addition of extra triggers on the generated particles (refer to [this](https://github.com/AliceO2Group/O2DPG/blob/master/MC/config/PWGDQ/ini/GeneratorHF_ccbarToMuonsSemileptonic_fwdy.ini) example for more details).

---

```cpp
// example of iterating through events and tracks
for (int i = 0; i < nEvents; i++) {
    const std::vector<o2::MCTrack>& tracks = reader.getTracks(i); // this is a shortcut, implicitly using source 0
    for (auto& track : tracks) {
        // perform the checks
        // assume something fails
        if (!trackNotPassed) {
            return 1;
        }
    }
    // optionally test the MCHeader
    const o2::dataformats::MCEventHeader& header = reader.getMCEventHeader(0, i); // the first parameter is the source, and we have only one source
    // ...
}

return 0;
}

int External()
{
    // similar logic as above
}
```

**The CI test will fail if no generators are tested.** The return value must be an integer, with `0` indicating success and any other value indicating failure.
```

---

### Global ID

A unique global ID is assigned to a single generator. This ID can be specified through a configuration key-value pair, as in the following example:
```bash
o2-sim <your-args> --configKeyValues "PrimaryGenerator.id=42"
```

To retrieve this ID during the analysis, the `mcCollisions` table provides the method `getGeneratorID()`.

### Sub-generator IDs

In this context, consider a scenario involving multiple generators, such as a cocktail generator. For instance, here is a simplified implementation of the `o2::eventgen::Generator` class:

```c++
class MyGenerator : public o2::eventgen::Generator
{
    MyGenerator() : o2::eventgen::Generator("myName", "myName")
    {
        // Additional setup if needed
        // ...
        // Define sub-generators
        addSubGenerator(0, "specificSubGen0");
        addSubGenerator(1, "specificSubGen1");
        addSubGenerator(2, "specificSubGen2");
        // Continue defining sub-generators
        addSubGenerator(N, "specificSubGenN");
        // Additional construction steps
    }
}
```

---

### Execute the test locally

You don't need to wait for the CI; instead, you can verify that everything is functioning correctly on your development machine if possible. This requires having the appropriate software environment set up; ideally, this is `O2sim`, but `O2` alongside `O2DPG` will work as well (unless you need additional packages, such as [AEGIS](https://github.com/AliceO2Group/AEGIS)).

Let's clarify some terms for clarity:
* `${O2DPG_SOURCE}` refers to the directory where you are developing,
* `HEAD` in `git` terminology refers to a specific state in your `git` history, typically the latest commit,
* "unstaged changes" in `git` are modifications that haven't been added to the next commit (whenever you are developing but haven't yet run `git add`).