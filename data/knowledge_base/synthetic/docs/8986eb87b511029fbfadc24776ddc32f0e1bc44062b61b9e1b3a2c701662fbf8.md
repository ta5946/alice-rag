## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/GRID/utils/runGRIDContainerized.sh

**Start chunk id:** 8986eb87b511029fbfadc24776ddc32f0e1bc44062b61b9e1b3a2c701662fbf8

## Content

if [ ! -d "${WORK_DIR}" ]; then
    echo "The working directory ${WORK_DIR} does not exist; please create it before running"
    exit 1
fi

# copy the script to the WORK_DIR
cp ${SCRIPT} ${WORK_DIR}/job.sh

# export certificates belonging to the current user (these should be created beforehand)
ALIEN_CERTFILE=$(find /tmp -type f -name 'tokencert*pem' -user `whoami` 2> /dev/null)
ALIEN_KEYFILE=$(find /tmp -type f -name 'tokenkey*pem' -user `whoami` 2> /dev/null)

[ "${ALIEN_CERTFILE}" == "" ] && echo "No certificate file found; initialize a token with alien-init-token or similar" && exit 1
[ "${ALIEN_KEYFILE}" == "" ] && echo "No key file found; initialize a token with alien-init-token or similar" && exit 1

cp ${ALIEN_CERTFILE} ${WORK_DIR}/usercert.pem
cp ${ALIEN_KEYFILE} ${WORK_DIR}/userkey.pem

echo "JALIEN_TOKEN_CERT=/workdir/usercert.pem" > ${WORK_DIR}/envfile
echo "JALIEN_TOKEN_KEY=/workdir/userkey.pem" >> ${WORK_DIR}/envfile

---

# launch job = script within the container in the workdir
/cvmfs/alice.cern.ch/containers/bin/apptainer/current${ISAARCH64+"-aarch64"}/bin/apptainer exec -C -B /cvmfs:/cvmfs,${WORK_DIR}:/workdir  \
                                                                    --pwd /workdir --env-file ${WORK_DIR}/envfile ${APPTAINER_CONTAINER} /workdir/job.sh

---

#!/usr/bin/env bash

# Executes a job within a container, similar to how it would run on the GRID.
# Imitates the actions of the AliEn job handler.

SCRIPT=$1
[ $SCRIPT == "" ] && echo "Please provide a script to run" && exit 1
echo "Attempting to run script ${SCRIPT} in a containerized environment"

# Determine the hardware architecture (ARM or X86)
ARCH=$(uname -i)
if [ "$ARCH" == "aarch64" ] || [ "$ARCH" == "x86_64" ]; then
    echo "Detected hardware architecture : $ARCH"
else
    echo "Invalid architecture ${ARCH} detected. Exiting"
    exit 1
fi
if [ "$ARCH" == "aarch64" ]; then
  ISAARCH64="1"
fi
# Use the default singularity container (unless overridden)
APPTAINER_CONTAINER=${APPTAINER_CONTAINER:-/cvmfs/alice.cern.ch/containers/fs/singularity/default${ISAARCH64+"-aarch64"}}

# Create a working directory if not already specified
if [ ! "${WORK_DIR}" ]; then
  WORK_DIR=$(mktemp -d /tmp/alien-job-XXXXXX)
fi
echo "This job will be executed in $WORK_DIR"