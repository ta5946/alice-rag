## Metadata

**Document link:** https://github.com/AliceO2Group/simulation/blob/main/additional_resources/talks/O2_AnalysisTutorial_Nov2024/MCTutorial4Giacalone.pdf

**Start chunk id:** 00f0c7937ee34aac723745d3dbbeba6ddd326daab34000ca087c325f03659447

## Content

‚Ä¢ Initialize the generator during use in C++

‚Ä¢ This transforms the generator setup into a "configuration challenge"

‚Ä¢ This approach is utilized for PWG-specific generation in the O2DPG production system

‚Ä¢ For instance, using the PWGDQ cocktail generator

‚Äúexecute o2-sim with the -g external parameter and point it to the external file and function name‚Äù

o2-sim -n 10 -g external --configKeyValues 
'GeneratorExternal.fileName=myGen.C;GeneratorExternal.funcName="gen(5020)"'

‚Äúsnippet of the ROOT macro file myGen.C‚Äù

// My fully custom generator
class MyGen : public o2::generator::GeneratorTGenerator {
  void Init() override;
  bool generateEvent() override;
};

FairGenerator* gen(double energy) {
  return new MyGen(energy);
}

üëâ Additional details in the documentation

17
üëâ Example: run/SimExamples/HepMC

üëâ Example: 
run/SimExamples/HepMC_STARlight

HepMC generation

‚Ä¢ Multiple generators offer the default option to output HepMC-formatted data ‚Üí a universal and convenient method for storing MC event generator information

---

### processes 

### heavy-ion settings (valid for Pb-Pb 5520 only) 
HeavyIon:SigFitNGen = 0 
HeavyIon:SigFitDefPar = 13.88,1.84,0.22,0.0,0.0,0.0,0.0,0.0 
HeavyIon:bWidth = 14.48 

### decays 
ParticleDecays:limitTau0 = on 
ParticleDecays:tau0Max = 10. 

### phase space cuts 
PhaseSpace:pTHatMin = 0.000000 
PhaseSpace:pTHatMax = -1.000000 

run with this configuration

o2-sim -n 10 -g pythia8 --configKeyValues 
‚ÄúGeneratorPythia8.config=pythia8.cfg‚Äù

16
üëâ Example: 
Run/SimExamples/AliRoot_AMPT

üëâ Example: 
Run/SimExamples/AliRoot_Hijing

External Generators

‚Ä¢ In addition to Pythia, O2 supports direct integration of specific generators via just-in-time ROOT macros, 
which is done to decouple PWG generator code and configurations from the data-taking process.

‚Ä¢ This approach helps in avoiding recompilation.

‚Ä¢ Instead, generators can be set up at runtime in C++, through a class like GeneratorTGenerator.

‚Ä¢ The generator setup is now treated as a configuration issue.

---

‚Ä¢ Experts can bypass certain restrictions by using CCDB snapshots.

‚Ä¢ O2DPG MC workflows are designed to operate optimally in an environment with 8 CPU cores and 16GB of RAM, mirroring the standard resources on the GRID.

‚Ä¢ This same resource requirement must be met when running these workflows locally on a laptop.

‚Ä¢ These defaults are incorporated into the workflow creation and execution processes.

‚Ä¢ Transport simulation will utilize 8 worker threads.

‚Ä¢ TPC and TRD digitisation will use 8 threads.

‚Ä¢ The workflow runner assumes the availability of 8 cores.

‚Ä¢ As a result, O2DPG MC workflows may encounter issues on hardware with fewer resources.

‚Ä¢ However, with some tuning and adjustments, it might still be possible to run them successfully.

---

"stub content of ROOT macro file myTrigger.C"

// returns a fully custom event trigger function
o2::eventgen::Trigger trigger()
{
  return [ ](const std::vector<TParticle>& particles) -> bool {
    return true; // triggered
  }
}

19
ADVANCED

üëâ Example: 
Run/SimExamples/MCTrackToDPL

o2-sim as an on-the-fly generator for analysis

‚Ä¢ o2-sim can function as a generator service to inject events directly into an analysis topology (DPL)

without the need for intermediate storage

‚Ä¢ It is beneficial for rapid-simulation studies within the analysis framework or for primary-only analysis tasks

@D. Chinellato 

‚Ä¢ This technique is already employed by various PWGs, such as for cocktail simulation in PWG-EM

Very basic example

‚Ä¢# Launch the simulation
o2-sim -j 1 -g pythia8pp -n 10 --noDiscOutput --forwardKine --noGeant &> sim.log &
# Launch the DPL process
o2-sim-mctracks-proxy -b --nevents 10 --o2sim-pid ${SIMPROC} --aggregate-timeframe 1 &

‚Ä¢ Crucial for on-the-fly analysis

‚Ä¢ Can be skipped in a single o2-sim process

20
Integrated workflows: O2DPG MC

---

‚Üí Both O2DPG-MC steps will be executed through a script.
example.sh O2DPG-MC script

#!/usr/bin/env bash
# Workflow creation: step 1
${O2DPG_ROOT}/MC/bin/o2dpg_sim_workflow.py -eCM 13600 -col pp -gen pythia8 -proc cdiff -tf 1 
-ns 200 -e TGeant4 -interactionRate 500000
# Workflow execution: step 2
${O2DPG_ROOT}/MC/bin/o2dpg_workflow_runner.py -f workflow.json -tt aod

Several example 
scripts are included <Here>

‚Ä¢ Jobs are submitted to the GRID using a script included in the O2DPG package.

${O2DPG_ROOT}/GRID/utils/grid_submit.sh --script my_script.sh --jobname test --outputspec 
"*.log@disk=1","*.root@disk=2" --packagespec "VO_ALICE@O2sim::v20241014-1" --wait 
--fetch-output

Options used:
--jobname: assigns a name to the job as it appears on MonALISA
--outputspec: specifies which files will be saved after the 
execution;

          @disk=2 indicates that 2 replicas of the files will be saved for security reasons

---

üëâ Embedding example in O2DPG: 
PWGHF embedding

38
Evaluate runtime

‚Ä¢ During GRID execution, log files will indicate the total runtime of 

your processes. 
**** Pipeline completed successfully (global runtime : 533.892s) *****
script for anchored pp production

‚Ä¢ The anticipated runtime in seconds can be calculated as:

‚Ä¢ Storage resources are determined by summing the sizes of all stored 

files, which can be found in MonALISA.

39

---

AOD data
(Structured) 
high-level 
physics data can 
be queried/analysed 

Physics 
Analysis

Data analysis aimed 
at discovering physics 
results and 
publishing papers

6

Classical 
pipeline in 
high-energy 
physics experiments:
Experimental 
data
Virtual particle collisions
+ detector simulation 
based on physics models

sensor data

Reconstruction

Transforms sensor data into 
the reconstructed state of 
particles immediately post-collision

PetaBytes

AOD data
(Structured) 
high-level 
physics data can 
be queried/analysed 

Physics 
Analysis

Data analysis aimed 
at discovering physics 
results and 
publishing papers

Why...

‚Ä¢ Design and optimization of detectors and systems
‚Ä¢ Calibration of reconstruction algorithms
‚Ä¢ Efficiency studies of reconstruction algorithms
‚Ä¢ Stress tests of data-taking with simulated data
‚Ä¢ Estimation of background effects
‚Ä¢ Radiation studies
‚Ä¢

etc

7

---

Workflow creator

Workflow executor

Output (AOD)

Generates a cohesive, integrated Monte Carlo (MC) workflow in the form of a directed-acyclic-graph (DAG), described in JSON format, which models the task dependencies.

Configures the MC workflow based on key user parameters:
- collision system
- generators
- interaction rate
- number of timeframes

Handles the execution of the DAG workflow on multi-core machines akin to a dynamic "build" tool.

Initiates tasks as they become eligible for execution:
- Aimed at achieving high parallelism and CPU utilization
- Ensures adherence to resource constraints (avoids system overload)

workflow.json

Primarily a versatile tool, not limited to MC

25
Basics of O2DPG-MC

‚Ä¢ Executing a MC job involves separating configuration logic from execution logic into two distinct steps

‚Ä¢ Step One: Formulate a valid/configured description of the MC job == "workflow"

‚Ä¢ Step Two: Execute the MC job with a dynamic graph scheduler

Workflow creator

Workflow executor

Output (AOD)

---

üëâ Example: run/SimExamples/JustPrimaryKinematics

‚Ä¢ hepmc              (use events from HepMC file)

üëâ Example: run/SimExamples/HepMC_STARlight

o2-sim -g [ pythia8pp | pythia8hi | boxgen | extkinO2 | hepmc ] ‚Ä¶

15
Generators: Pythia8

‚Ä¢ Pythia8 is more deeply integrated into O2 

(compared to others) and it is advised to use it whenever possible

‚Ä¢ If Pythia8 is utilized, it can be fully 

configured via a specialized text file and the 
GeneratorPythia8 parameter

‚Ä¢ Valid settings can be found in the Pythia8 reference 

manual

‚Ä¢ We also offer a tool mkpy8cfg.py to assist 

with creating the configuration file

üëâ Example: 
Run/SimExamples/Jet_Embedding_Pythia8

pythia8.cfg

### random 
Random:setSeed = on 
Random:seed = 130145275 

### beams 
Beams:idA = 1000822080 
Beams:idB = 1000822080 
Beams:eCM = 5020.000000 

### processes

---

Marco Giacalone
Sandro Wenzel

15.10.2024

Executing Run3 Simulations

ALICE Analysis Guide
Outline

‚Ä¢ Overview of ALICE Run3 simulation framework

‚Ä¢ o2-sim and event simulation details  

‚Ä¢ Range of simulation configurations and options

‚Ä¢ O2DPG workflow ‚Üí the current standard 

2
Outline

‚Ä¢ Overview of ALICE Run3 simulation framework

‚Ä¢ o2-sim and event simulation details  

‚Ä¢ Range of simulation configurations and options

‚Ä¢ O2DPG workflow ‚Üí the current standard 

!

Opening Remark

Brief introduction to practical Monte Carlo generation. 
Additional details available in other PWG tutorials or documentation

3
Contacts

‚Ä¢ How to reach the simulation developers

‚Ä¢ Simulation e-group (for meeting updates) + WP12 meetings

‚Ä¢ Collaborative Mattermost channels (preferred over private email): O2-simulation + O2DPG

‚Ä¢ JIRA tickets for feature requests/bug reports  (components related to simulation or O2DPG)

‚Ä¢ Where to find simulation information

---

‚Ä¢ Can be skipped for a single o2-sim process

20
Integrated workÔ¨Çows: O2DPG MC

‚Ä¢ To generate simulated AODs, we must extend beyond 

o2-sim and event generation, running the full 

algorithmic pipeline, which includes digitization and reconstruction

‚Ä¢ This is a intricate system, comprising numerous executables or 

tasks, necessitating consistent settings/conÔ¨Åguration application and propagation

‚Ä¢ For instance, a full-system-test for data taking

‚Ä¢ Difficult to manage alone ‚Üí utilize a maintained setup!

‚Ä¢ For ALICE Run3, the oÔ¨Écial production system for GRID 

productions is the O2DPG repository (MC part)

‚Ä¢ O2DPG also encompasses scripts and setup for data taking (DATA part)

‚ÄúAlgorithms interact in a complex system (DPL topology)‚Äù

21
O2DPG ‚Ä¶

‚Ä¢ offers a reliable setup for oÔ¨Écial MC 

productions for ALICE-Run3 and a runtime to execute 

MC jobs on GRID

‚Ä¢ consolidates all pertinent processing tasks into a

---

WORKFLOW.JSON

Example illustration‚Ä¶

23
O2DPG-MC Basics

A practical example workÔ¨Çow with only 
2 timeframes is substantially more extensive‚Ä¶
‚Ä¢ Executing a MC job involves separating configuration logic from execution logic into two steps

1. Develop a properly configured description of the MC job = ‚ÄúworkÔ¨Çow‚Äù

WorkÔ¨Çow creator

Constructs a coherent, integrated MC 
workÔ¨Çow in a directed-acyclic-graph (DAG) format, represented as JSON, which models task dependencies

Configures the MC workÔ¨Çow based on critical user parameters
‚Ä¢ Collision type, generators, interaction frequency, timeframes count

WORKFLOW.JSON

24
O2DPG-MC Basics

‚Ä¢ Executing a MC job involves separating configuration logic from execution logic into two steps

‚Ä¢ Step One: Develop a properly configured description of the MC job = ‚ÄúworkÔ¨Çow‚Äù

‚Ä¢ Step Two: Run the MC job using a dynamic graph scheduler

WorkÔ¨Çow creator

WorkÔ¨Çow executor

Output (AOD)

---

The ALICE Run3 simulation framework:

- Is made up of multiple components
- Includes key simulation elements such as:
- Event creation
- Propagation through the system
- Signal conversion to digital format

Additionally, these workflows can also perform:
- Reconstruction
- Quality control
- Data analysis and more

Each segment is hosted in O2 and O2Physics repositories.

For event generation and detector simulation:
- Geometry file
- Kinematics data
- Response profiles (hits)

During digitization and reconstruction:
- Creation of Analyzed Object Data (AOD)
- Quality assurance checks
- Various analyses

Workflow integration is managed with:

- O2DPG (primarily for physics analysis on GRID)
- full-system-test (focused on simulation for data taking)

8

---

DOCUMENT:
    for (auto& t : tracks) {
   // analyze tracks; find the mother track of each track (in the pool of all tracks)
   auto mother = o2::mcutil::MCTrackNavigator::getMother(t, tracks);
   if (mother) {
      std::cout << "This track has a mother\n";
   }
   // identify the (backward first) primary particle from which this track descends
   auto primary = o2::mcutil::MCTrackNavigator::getFirstPrimary(t, tracks);
}

‚ÄúLoad Monte Carlo tracks from a stored kinematics file for event id 1. Loop through all tracks to identify their direct mother particle and the primary ancestor.‚Äù

14
Generators: Basic

‚Ä¢ o2-sim includes several pre-defined generators (choose with -g option)

‚Ä¢ pythia8pp         (pre-configured Pythia8 for pp)

‚Ä¢ pythia8hi          (pre-configured Pythia8 for PbPb)

‚Ä¢ boxgen             (a simple mono-PDG generator)

‚Ä¢ extkinO2           (use an external kinematics file, e.g., generated in a pre-step)

üëâ Example: run/SimExamples/JustPrimaryKinematics

---

‚Ä¢ Event filtering or triggering can also be flexibly managed at the generator level

‚Ä¢ For instance, events with specific properties can be selectively generated and simulated

‚Ä¢ A customizable "external" trigger can be implemented using the "external" generator method

‚Ä¢ Users can write a trigger function in a separate ROOT macro and invoke it with the `-t external` option in o2-sim

‚Ä¢ The trigger function then evaluates the entire vector of generated particles

‚Ä¢ For advanced usage, DeepTriggers enable triggering based on the collection of primary particles and additional internal generator details

‚Äúexecute o2-sim with pythia8pp generator and pass only events that meet the trigger condition specified in the file Trigger.C‚Äù

o2-sim -n 10 -g pythia8pp -t external --configKeyValues 
‚ÄòTriggerExternal.fileName=myTrigger.C;TriggerExternal.funcName=trigger‚Äô

‚Äúexample content of the ROOT macro file myTrigger.C‚Äù

---

‚Ä¢ For example, impact parameter in PbPb collisions

‚Äúhistogram showing the production vertex-y position for all 
MCtracks (including primary and secondary tracks)‚Äù

13
Helper classes for accessing MC kinematics

üëâ Example: 
Run/SimExamples/Jet_Embedding_Pythia8

‚Ä¢ Manually navigating and reading MC kinematics 
can be tedious (ROOT-IO boilerplate)

using o2::steer;
using o2;

// use the o2sim prefix to access the kinematics file
MCKinematicsReader reader("o2sim",MCKinematicsReader::Mode::kMCKine);

‚Ä¢ Provides two main utility classes to simplify this process

// retrieve all Monte Carlo tracks for the current event
std::vector<MCTrack> const& tracks = reader.getTracks(event);

making it easier for users

‚Ä¢ MCKinematicsReader - A class for easily reading and 
retrieving tracks for a specific event or Monte Carlo label

‚Ä¢ MCTrackNavigator - A class for traversing the mother-daughter 
tree of MC tracks and querying physics properties

---

‚Ä¢ A list of predefined run numbers for MC simulations is documented at: 
https://twiki.cern.ch/twiki/bin/view/ALICE/O2D
PGMCSamplingSchema

‚Ä¢ For instance, a run number 310000 can be utilized in a PbPb simulation with a -0.5T magnetic field

‚Ä¢ It should ideally retrieve CCDB objects suitable for PbPb simulations

30
Recommended Approach

‚Ä¢ Documentation
‚Ä¢ Official configuration directory
WorkÊµÅÁ®ãÂàõÂª∫ÔºöÁîüÊàêÂô®ÈÖçÁΩÆ
‚Ä¢ ÂèØÈÄöËøá.iniÊñá‰ª∂ÊåáÂÆöËá™ÂÆö‰πâÈÖçÁΩÆÂà∞ÁîüÊàêÂ∑•‰ΩúÊµÅÁ®ã‰∏≠

o2dpg_sim_workflow.py -gen pythia8 -ini <Ë∑ØÂæÑ/Ëá≥/config.ini>

‚Ä¢ ÂÆÉ‰ª¨ÂåÖÂê´‰∏çÂêåÁöÑÁîüÊàêÂô®ÈÖçÁΩÆÈÉ®ÂàÜÔºå‰ΩÜËøòÂèØ‰ª•Ê∑ªÂä†ÁîüÊàêÁ≤íÂ≠êÁöÑÈ¢ùÂ§ñËß¶ÂèëÂô®

‚Ä¢ ÈªòËÆ§ÂÆòÊñπÈÖçÁΩÆÂèØ‰ª•Âú® O2DPG/MC/config/<PWG>/ini/<ÈÖçÁΩÆ>.ini ÊâæÂà∞Ôºå‰∏îÂΩìÈÄöËøáPR‰øÆÊîπËØ∑Ê±ÇÊàñÊñ∞Â¢ûÈÖçÁΩÆÊó∂Ôºå‰ºöÈÄöËøáCIËøõË°åÊµãËØï

Êù•Ëá™PWGDQÈÖçÁΩÆÁâáÊÆµ

‚Ä¢ ÈÖçÁΩÆÊñá‰ª∂Â§πÈìæÊé•Âà∞ O2DPG_MC_CONFIG_ROOT ÁéØÂ¢ÉÂèòÈáè

---

‚Ä¢ Transform the Directed Acyclic Graph (DAG) into a basic shell script that can operate independently.

o2dpg_workflow_runner.py -f workflow.json -tt digi
o2dpg_workflow_runner.py -f workflow.json -tt aod

‚ÄúFirst, run up to digitization, and then proceed to AOD without redoing completed tasks!
o2dpg_workflow_runner.py -f workflow.json -tt aod
--produce-script my_script.sh
‚ÄúGenerate a straightforward shell script to sequentially execute processes up to the AOD stage.‚Äù

‚Ä¢ Additional useful functionalities are also available.

‚Ä¢ Refer to o2dpg_workflow_runner.py --help for a comprehensive list of options.

32
Submit MC jobs to the GRID

‚Ä¢ MC workflows can be executed on the GRID, extending up to AOD generation.

‚Üí Both O2DPG-MC steps will be run via a script, example.sh O2DPG-MC script.

---

"Simply create 10 default Pythia8 pp events with no further actions (pure generator output).

Consult `o2-sim --help` for primary options and default generation parameters.

o2-sim: Kinematics Output

By default, kinematic data (output file: o2sim_Kine.root) from the transport simulation is often the most useful for physics analysis.

It includes details such as creation vertices, momenta, and other attributes of both primary (generated) and secondary (transported) particles.

This data provides information on the physics creation process, including particle lineage (mother-daughter relationships).

Based on the o2::MCTrack class, which is essentially a lighter version of TParticle.

Each event corresponds to one entry in a vector<MCTracks> within a TTree.

Kinematics data is typically pruned to include only relevant particles by default.

Moreover, each generated event includes event-level metadata in a separate file (o2sim_MCHeader.root), such as the impact parameter in PbPb collisions."

---

‚Ä¢ o2-sim supports reading HepMC files by default, but it can also handle data from FIFOs.

‚Ä¢ HepMC3 is the standard, but HepMC2.06 data are also compatible for both local file and FIFO input.

‚Ä¢ To generate events with o2-sim, use the command:
```
o2-sim -n 10 -g hepmc --configKeyValues "HepMC.fileName=/path_to/file.hepmc"
```
or for HepMC2.06:
```
o2-sim -n 10 -g hepmc --configKeyValues "HepMC.fileName=/path_to/file.hepmc;HepMC.version=2"
```

‚Ä¢ A further capability of the tool is to initiate event generators via the cmd parameter of GeneratorHepMC. This allows generators to print data to stdout, enabling automatic feeding into o2-sim without the need for large local .hepmc files.

‚Ä¢ Event generation with automatic FIFOs can be performed using the script at run/SimExamples/HepMC_EPOS4.

‚Ä¢ To generate 100 events with a seed of 12345 and use epos.sh as the generator command:
```
o2-sim -n 100 -g hepmc --seed 12345 --configKeyValues "GeneratorFileOrCmd.cmd=epos.sh;GeneratorFileOrCmd.bMaxSwitch=none;HepMC.version=2"
```

More information can be found <HERE>.

18
ADVANCED

Event Filtering or Triggering:

üëâ Example: 
run/SimExamples/Selective_Transport_pi0

‚Ä¢ Event filtering or triggering can also be flexibly configured.

---

CYCLE J - 1

where

J =    Total number of TFs

N*PRODSPLIT

‚ÜêN is defined within the running script (next slide)

34
Anchored MC productions: how to?

Documentation

‚Ä¢ The grid_submit.sh script can initiate anchored MC productions ‚Üí a production script is required  
example script for anchored pp production

export ALIEN_JDL_LPMANCHORPASSNAME=apass2
export ALIEN_JDL_MCANCHOR=apass2
export ALIEN_JDL_CPULIMIT=8
export ALIEN_JDL_LPMRUNNUMBER=535069
export ALIEN_JDL_LPMPRODUCTIONTYPE=MC
export ALIEN_JDL_LPMINTERACTIONTYPE=pp
export ALIEN_JDL_LPMPRODUCTIONTAG=LHC24a2
export ALIEN_JDL_LPMANCHORRUN=535069
export ALIEN_JDL_LPMANCHORPRODUCTION=LHC23f
export ALIEN_JDL_LPMANCHORYEAR=2023

export NTIMEFRAMES=1
export NSIGEVENTS=50
export SPLITID=100
export PRODSPLIT=153
export CYCLE=0

export SEED=5
export NWORKERS=2

${O2DPG_ROOT}/MC/run/ANCHOR/anchorMC.sh

test_anchor_2023_apass2_pp.sh 

so

---

WORKFLOW CREATOR

WORKFLOW EXECUTOR

OUTPUT (AOD)

Generates a consistent, integrated Monte Carlo (MC) workÔ¨Çow in a directed-acyclic-graph (DAG) format, represented as JSON, which models task dependencies.

Configures the MC workÔ¨Çow based on critical user parameters:
- collision system
- generators
- interaction rate
- number of timeframes

Manages running the DAG workÔ¨Çow on multi-core systems akin to a dynamic ‚Äúbuild‚Äù utility.

Initiates tasks when they are ready to be executed:
- Optimizing for high parallelism and CPU utilization
- Adhering to resource constraints (avoids system overload)

workÔ¨Çow.json

Essentially a versatile tool, not limited to MC applications.

üí° Did you know:

A DAG workÔ¨Çow is analogous to a DPL topology.

A DPL topology cannot fit into GRID memory.

A DAG workÔ¨Çow executes in stages, with intermediate files stored on disc.

26
O2DPG-MC workÔ¨Çows: Requirements

‚Ä¢ Valid AliEn tokens are necessary for execution (for accessing CCDB objects)

‚Ä¢ Experts can bypass this by using CCDB snapshots

---

‚Ä¢ Default storage locations are set to ${WORKDIR}/ccdb/<path>/<in>/<ccdb>/snapshot.root

Moreover‚Ä¶

‚Ä¢

The path can be customized manually as follows:

export ALICEO2_CCDB_LOCALCACHE=/<your>/<path>

ALICEO2_CCDB_LOCALCACHE=/<your>/<path>

or by executing:

ALICEO2_CCDB_LOCALCACHE=${YOURPATH} o2_dpg_workÔ¨Çow_runner.py ‚Ä¶

enabling the use of an existing cache

‚Ä¢

There is an O2 script for downloading CCDB files:

${O2_ROOT}/bin/o2-ccdb-downloadccdbÔ¨Åle --host http://alice-ccdb.cern.ch -p 
TPC/Calib/CorrectionMapRef --timestamp <timestamp> --created-not-after 3385078236000 
-d ${YOURPATH}

28
üëâ Examples and documentation available here;  üëâ Details here

O2DPG-MC step 1: workflow creation

‚Ä¢ An O2 script for creating Run3 MC workflows is:

O2DPG/MC/bin/o2dpg_sim_workflow.py

‚Ä¢ Configures the MC workflow based on key (user) parameters such as collision system, 
generators, interaction rate, number of timeframes, transport engine, etc.
‚Ä¢ `o2dpg_sim_workflow.py --help` ‚Üí provides documentation with all available options

---

‚Ä¢ Formation of hits (energy deposits) as a preliminary step in the detector

response following particle traversal

10
o2-sim: ALICE Run3 simulation tool

‚Ä¢ New in Run3: enhanced multi-core simulation with sub-event parallelism

‚Üíenables the use of powerful servers to rapidly produce results for substantial events

‚Ä¢ Note: o2-sim handles events in full isolation‚Äîno timeframe consideration (introduced during digitization)

‚Ä¢ o2-sim generates 3 internal log files ‚Üí detailed documentation of each process and debugging

o2sim_serverlog

o2sim_workerlog0

o2sim_mergerlog

11
Examples of o2-sim usage

‚Ä¢ Examples illustrating o2-sim operations

o2-sim -n 10 -g pythia8pp

o2-sim -n 10 -g pythia8pp -j 8 \
--skipModules ZDC --field 2 -e TGeant3

 o2-sim -n 10 -g pythia8pp --noGeant

‚ÄúGenerate 10 standard Pythia8 pp events and simulate their passage through the entire ALICE detector‚Äù

‚ÄúGenerate 10 standard Pythia8 pp events and simulate their passage using 8 Geant3 workers through all components except ZDC, with a 2kGauss L3 field‚Äù

---

‚Ä¢ Assist us in enhancing the 

documentation, which is currently in its initial phase!

‚Ä¶ and much more

36
Backup
Digitization, embedding (signal mixing)

‚Ä¢ While digitization may not be crucial for physics analysis, it's essential to be aware of it

‚Ä¢ The primary goal of digitization is to

‚Ä¢ transform basic energy deposits into detector signals (digits) that ultimately 

mirror the raw output from the detector

‚Ä¢ place individual generated events into a timeframe collection

‚Ä¢ manage pileup effects and triggering

‚Ä¢ Digitization as a signal embedding / mixing framework

‚Ä¢ Digitization can serve as a platform for event-mixing / event-embedding

‚Ä¢ signal-background embedding enables the injection of signal events into a 

repeated collection of background events (saves time on transport simulation)

‚Ä¢ Can create sequences of event types within a timeframe (a signal event 

immediately following every n-th min-bias event)

üëâ Embedding example in O2DPG: 
PWGHF embedding

38
Estimate resources

---

‚Ä¢ integrates all pertinent processing tasks into a 

coherent and uniform environment to ensure a functional pipeline from event generation through to AOD and further stages

‚Ä¢ preserves PWG generator configurations as 

version-controlled code

‚Ä¢ conducts testing / CI on PWG generator configurations

https://github.com/AliceO2Group/O2DPG

Key directories:

‚Ä¢ MC/bin       (workflow creation/execution)
‚Ä¢ MC/run       (PWG-specific run scripts)
‚Ä¢ MC/config    (PWG-specific generator configurations)

22
Fundamentals of O2DPG-MC

‚Ä¢ Executing a MC job involves a two-step process to separate configuration logic from execution logic

1. Formulate a valid and configured description of a MC job == ‚ÄúworkÔ¨Çow‚Äù

WorkÔ¨Çow creator

Generates a cohesive, integrated MC 
workÔ¨Çow in directed-acyclic-graph 
(DAG) format, described as a JSON, 
representing the task dependencies

Configures the MC workÔ¨Çow based on crucial user 
parameters:
‚Ä¢ collision system
‚Ä¢ generators
‚Ä¢ interaction rate
‚Ä¢ number of timeframes

workÔ¨Çow.json

Simple example‚Ä¶

---

‚Ä¢ The configurations folder is connected to the O2DPG_MC_CONFIG_ROOT environment variable.

Local configurations can be utilized, and similarly, newer configurations can be tested with older O2DPG builds and vice versa.

[GeneratorPythia8]
config = 
${O2DPG_MC_CONFIG_ROOT}/MC/config/common/pythia8/generato
r/pythia8_hf.cfg
hooksFileName = 
${O2DPG_MC_CONFIG_ROOT}/MC/config/PWGHF/pythia8/hooks/pyt
hia8_userhooks_qqbar.C
hooksFuncName = pythia8_userhooks_ccbar(-4.3,-2.3)

31
O2DPG-MC step 2: workflow execution

‚Ä¢ The workflow runner/executor creates and executes a Directed Acyclic Graph (DAG) workflow on a compute node.

‚Ä¢ It requires minimally a workflow file and a target as input.

${O2DPG_ROOT}/MC/bin/o2dpg_workflow_runner.py -f workflow.json -tt aod

"Execute the workflow up to the aod task (assuming an 8-core CPU configuration)"

‚Ä¢ Includes checkpointing and incremental build capabilities.

‚Ä¢ Converts the DAG into a standalone simple shell script.

---

‚Ä¢ Where to find information about the simulation

‚Ä¢ New documentation project: https://aliceo2group.github.io/simulation/

‚Ä¢ Previous documentation in AliceO2: DetectorSimulation.md

‚Ä¢ Some information in O2DPG: WorkÔ¨ÇowRunner.md

‚Ä¢ Various examples at O2/SimExamples or nightly-tests

üëà still early stage:

‚óè
‚óè
‚óè

provide feedback 
ask questions
contribute

4
Software environment reminder

simplest local build (basic generators such as Pythia8)

aliBuild build O2 O2DPG --defaults o2

alienv enter O2/latest,O2DPG/latest

full local build (all generators, QC, and O2Physics included)

aliBuild build O2sim --defaults o2

alienv enter O2sim/latest

nightly precompiled builds (with CVMFS)

/cvmfs/alice.cern.ch/bin/alienv enter O2sim::v20241014-1

5
~TB/s

PetaBytes

Real particle collisions

Reconstruction

transforms sensor data into
the state of particles immediately after
collisions

AOD data
high-level structured
physics data for 
querying and analysis

Physics 
Analysis

---

@disk=2 indicates that 2 copies of the file will be stored for safety reasons.

--wait: your system will pause until all GRID tasks complete.
--fetch-output: automatically retrieves files onto your local storage.

--help to display all available options.

!
‚òù Important:
The output will be placed in a different directory from your current one: review the stdout!

33
Anchored MC Production Documentation

Simulations tailored to mimic real data-taking conditions:

- LHC operation, integrated ALICE detectors, dead channels, alignment, interaction rates, etc.
- Vital for realistic simulation samples in physics analyses.

Each anchored MC run represents one specific CYCLE of one SPLITID, encompassing N timeframes across the entire run. 

CYCLE J - 1

where

J = Total N TFs

N*PRODSPLIT

N is defined by the running script (next slide)

---

${O2DPG_ROOT}/MC/run/ANCHOR/anchorMC.sh

test_anchor_2023_apass2_pp.sh 

so

${O2DPG_ROOT}/GRID/utils/grid_submit.sh --script 
test_anchor_2023_apass2_pp.sh --jobname test --outputspec 
"*.log@disk=1","*.root@disk=2" --packagespec 
"VO_ALICE@O2sim::v20241014-1" --wait --fetch-output

‚òùImportant to know:
‚óè All existing MC production is listed in MonALISA under Production Info ‚Üí MC production cycles (running, completed, software update, etc.)

‚óè Procedure to request Anchored MC production from O2DPG:

1. Run a test on the GRID using your settings
2. Provide an estimate for running time, expected storage, and number of events
3. Provide a link to the GRID folder containing test and results configuration/JDL

Check 
backup

35
Further details:

‚Ä¢ Many other advanced topics will be covered

‚Ä¢ ‚Ä¶ expanding beyond the basic content presented here

‚Ä¢ Contact us for more information!

‚Ä¢ Help us improve the documentation, which is still in an early stage!

‚Ä¶ and many more

---

DOCUMENT:
    ${O2DPG_ROOT}/MC/bin/o2dpg_sim_workflow.py -eCM 14000 -col pp

                                       -gen pythia8 -proc cdiff           

                          -tf 5 ‚Äîns 2000                                                                                 

‚ÄúCreate an ALICE Run3 Monte Carlo workflow for a 5 timeframe simulation, with 
2000 events per timeframe, at an interaction rate of 500kHz, for 14TeV pp collisions using 
Pythia8 with the special process cdiff enabled‚Ä¶‚Äù

                                         -interactionRate 500000
                      -run 302000

‚òù Important options:

-gen, -tf, -n, -eCM, -interactionRate, -run, -col
 Optionally: -field, -seed, -proc

29
Workflow creation: Run numbers

‚Ä¢ A run number must be specified as it is essential for fetching conditions from CCDB

‚Ä¢ Therefore, run numbers should be used even for simulations not involving data-taking

‚Ä¢ A list of predefined run numbers is available for Monte Carlo simulations

---

‚Ä¢ Geometry file
‚Ä¢ Kinematics file
‚Ä¢ Detector

response files 
(hits)

Digitization

Reconstruction

Physics 
Analysis

‚Ä¢ Digits represent detector 
sub-timeframes
‚Ä¢ Similar to or closely mimic raw 
detector output

‚Ä¢ Global reconstructed tracks
‚Ä¢ Primary and secondary 

Vertices

‚Ä¢ etc.
‚Ä¢ AOD (analysis object data)

9
o2-sim: ALICE Run3 simulation tool

‚Ä¢ o2-sim is the particle-detector simulator for ALICE Run3

Implements ALICE detectors using well-known particle-transport 
engines that include actual physics models and particle transport

‚Ä¢ Supports Geant4, Geant3, and FLUKA through the Virtual 

Monte Carlo API

‚Ä¢ Primary tasks of o2-sim:

‚Ä¢ ALICE geometry creation

‚Ä¢ Event generation (primary particle creation)

‚Ä¢ Simulation of particle interactions with detector material 
(secondary creation, etc.) and their transport until they exit 
or stop within the detector

‚Ä¢ Creation of hits (energy deposits) as a precursor to detector 

response following particle passage