## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/GRID/utils/extractErroredLogFiles.sh

**Start chunk id:** 0942f60820445781b08be1ad3005a2295aa0f579dd2a5b8217b45d94e6e3f637

## Content

#!/usr/bin/env bash

# We identify the O2DPG tasks that encountered errors (listed in stdout) and automatically retrieve the corresponding logs.
# Be cautious as errors might not be confined to O2DPG tasks and could occur during preprocessing or be unrecorded in logs.

mytar () {
  tar "$@"
}
if [[ $(uname) == "Darwin" ]]; then
    echo "Executing on macOS. This requires gnu-tar"
    $(which gtar)
    mytar () {
      gtar "$@"
    }
fi

errored_tasks=""
find ./ -name "stdout*" -exec grep -H "failed.*retry" {} ';' | sed 's/ failed.*//' | tr ":" " " | while IFS= read -r line; do
  stdoutpath=$(echo "$line" | awk '{print $1}')  # Extracting the first column
  logfile=$(echo "$line" | awk '{print $2}')  # Extracting the second column

---

DOCUMENT:
  dir=$(dirname ${stdoutpath})
  cd ${dir}
  # determine a timeframe number (if applicable)
  # Extracting the timeframe 'tf'
  tf=${logfile#*_} # Removes everything before the first underscore
  tf=${tf%.log} # Removes the ".log" extension
  echo "Extracted timeframe ${tf}"
  
  # extract the general log archive
  unzip -n log_archive.zip
  # extract specific task log from debug archive
  mytar -xvzf debug_log_archive.tgz --wildcards "*${logfile}.log"
  if [[ ${logfile} == *"qedsim"* || ${logfile} == *"sgnsim"* || ${logfile} == *"bkgsim"* ]]; then
    # the simulation also requires additional files to be inspected
    mytar -xvzf debug_log_archive.tgz --wildcards "*${tf}*serverlog*"
    mytar -xvzf debug_log_archive.tgz --wildcards "*${tf}*workerlog*"
    mytar -xvzf debug_log_archive.tgz --wildcards "*${tf}*mergerlog*"
  fi
  cd $OLDPWD
done