## Metadata

**Document link:** https://github.com/AliceO2Group/AliceO2/blob/dev/run/SimExamples/HepMC/README.md

**Start chunk id:** 15d8e4d7f87b2dffd00d967841c5b31889f54c66764550df53a57ffcbab0f89a

## Content

If any `Switch` key is left blank, the corresponding option is not included in the command line. For instance, if _bMaxSwitch_ is blank, the build command line will be

> _commandLine_ _nEventsSwitch_ _nEvents_ _seedSwitch_ _seed_
> _outputSwitch_ _output_ _backgroundSwitch_

---

- The EG program is required to write HepMC event structures to a designated file. The output file is determined by the `GeneratorFileOrCmd.outputSwitch` configuration key, with a default value of `>`, indicating that the program will output HepMC event structures to standard output without printing any additional text.

- The program must also allow setting the number of events to be generated through a command-line option, controlled by the `GeneratorFileOrCmd.nEventsSwitch` key and with a default value of `-n`. Therefore, using `-n 10` instructs the program to generate 10 events.

- Additionally, the EG application should include a command-line option to set the seed for the random number generator, managed by the `GeneratorFileOrCmd.seedSwitch` key and having a default value of `-s`. For instance, `-s 123456` sets the random number seed to 123456.

---

Here are guidelines on how to use the `GeneratorHepMC` selected with the `-g hepmc` option for `o2-sim`.

HepMC event structures can be imported from any format supported by HepMC itself (refer to
[these](http://hepmc.web.cern.ch/hepmc/group__IO.html) and
[these](http://hepmc.web.cern.ch/hepmc/group__factory.html) resources).

## Importing HepMC Files

The `GeneratorHepMC` generator can import events from a
[HepMC(3)](http://hepmc.web.cern.ch/hepmc/) formatted file. Such files can be generated by standalone event generator software (EG). Examples of such software include:

- [Pythia8](https://pythia.org)
- The [CRMC](https://gitlab.iap.kit.edu/AirShowerPhysics/crmc) suite
- [Herwig](https://herwig.hepforge.org/)
- [SMASH](https://smash-transport.github.io/)
- And many more...

For more details on creating event files in the HepMC format, please consult the documentation of these software tools.

---

If a program fails to meet these requirements, it is usually straightforward to create a small wrapper script to enforce them. For instance, `crmc` generates a significant amount of output to standard output. We can use a shell script ([`crmc.sh`](crmc.sh)) to filter this output as follows:

    #!/bin/sh
    crmc $@ -o hepmc3 -f /dev/stdout | sed -n 's/^\(HepMC::\|[EAUWVP] \)/\1/p'

The `sed` command filters lines that start with `HepMC::`, or with the single characters `E` (event), `A` (attribute), `U` (units), `W` (weight), `V` (vertex), or `P` (particle) followed by a space. This should typically be sufficient to eliminate unnecessary information from the standard output.

Moreover, the script forwards any additional command line arguments to `crmc` through `$@`. This can be applied to `o2-sim` to configure options for the CRMC suite. For example, to simulate p-Pb collisions using DpmJET, we can run:

    o2-sim -g hepmc --configKeyValues "GeneratorFileOrCmd.cmd=crmc.sh -m 12 -i2212 -I 1002080820"

---

To perform a simulation by reading from the file `events.hepmc`, execute:

    o2-sim -g hepmc --configKeyValues "GeneratorFileOrCmd.fileNames=events.hepmc" ...

Refer to [`read.sh`](read.sh) for more details.

## Reading HepMC events from a child process

The `GeneratorHepMC` module is capable not only of reading HepMC events from a file, but also of spawning a child EG to generate events. If you have an EG named `eg` that writes HepMC event records to the standard output, you can run a simulation using this external EG with:

    o2-sim -g hepmc --configKeyValues "GeneratorFileOrCmd.cmd=eg"

Further information can be found in the script [`child.sh`](child.sh).

The program `eg` must meet certain requirements.

---

This can decrease the event size, and the extent of reduction varies based on the event generator. Use this option with caution, as it might disrupt the event structure, although steps are taken to minimize such risks.

In the future, we might need finer control over which particles to retain. For instance, we could define keys like:

- `HepMC.keepStatus=list-of-status-codes`
- `HepMC.keepPDGs=list-of-pdg-numbers`

- `HepMC.version` - when reading events from files, this setting is no longer necessary; the code automatically identifies the format version. If executing a child process via `GeneratorFileOrCmd.cmd` and the EG outputs HepMC2 format, this must be set to `2`; otherwise, HepMC3 is assumed.

- `GeneratorFileOrCmd.fileNames=list` - a comma-separated list of HepMC files to be read.

---

- `GeneratorFileOrCmd.bMaxSwitch=switch` (default `-b`) to set
  the maximum value for the impact parameters sampled. The value
  provided is chosen by the `o2-sim` option `--bMax`

- `GeneratorFileOrCmd.nEventsSwitch=switch` (default `-n`) to
  define the number of events to be generated. The specified value
  is selected by the `o2-sim` option `--nEvents` or (`-n`)

- `GeneratorFileOrCmd.backgroundSwitch=switch` (default `&`) to
  indicate how the program runs in the background. Usually, this
  should be `&`, but a program might fork to the background on its own.

- Some options are no longer recommended

  - `HepMC.fileName` - use `GeneratorFileOrCmd.fileNames`

The command line configuration is now

> _commandLine_ _nEventsSwitch_ _nEvents_ _seedSwitch_ _seed_
> _bMaxSwitch_ _bMax_ _outputSwitch_ _output_ _backgroundSwitch_

---

Set the random number seed to `123456` as an example.
- The EG application should accept a command line option to specify the
  maximum impact parameter (in Fermi-metres) sampled. This value is configured
  through the key `GeneratorFileOrCmd.bMaxSwitch` and defaults to `-b`. Therefore,
  the EG application should interpret the command line argument `-b 10` to mean
  that it should only produce events with an impact parameter ranging from 0fm to 10fm.

---

- `GeneratorFileOrCmd.fileNames=list` a comma-separated list of HepMC files to read.

- `GeneratorFileOrCmd.cmd=command line` a command line to run as a background child process. When set (not empty), `GeneratorFileOrCmd.fileNames` is disregarded.

- Several keys to define the command line option switch that the child program uses for specific purposes. If any of these are left as an empty string, the corresponding switch and option value are not transmitted to the child program.

  - `GeneratorFileOrCmd.outputSwitch=switch` (default `>`) to define the output file. The default `>` implies that the program outputs HepMC events exclusively to standard output.

  - `GeneratorFileOrCmd.seedSwitch=switch` (default `-s`) to set the random number generator seed. The value provided is chosen based on the `o2-sim` option `--seed`.

---

### Implementation Details

`GeneratorHepMC` internally:

1. generates a unique temporary file name in the working directory,
2. establishes a FIFO (or named pipe, see [Wikipedia](https://en.wikipedia.org/wiki/Named_pipe)),
3. constructs a command line, e.g.,

        eg options > fifo-name &

4. and runs that command line

## Configuration Keys

`GeneratorHepMC` (and its sister generator, `GeneratorTParticle`) permits customization through configuration keys specified via `--configKeyValues`.

- `HepMC.eventsToSkip=number` specifies the number of events to skip at the start of each file read.

- `HepMC.prune=boolean` if set to true, it filters out events involving particles that are not:
  - beam particles (status = 4),
  - decayed particles (status = 2), or
  - final state particles (status = 1)