## Metadata

**Document link:** https://github.com/AliceO2Group/AliceO2/blob/dev/Detectors/TPC/calibration/doc/CalibdEdx.md

**Start chunk id:** 06fab02200b9a0d22e5d13047f837fc3a862547cf8339625b680a3691612440d

## Content

<!-- doxy
\page refTPCcalibrationCalibdEdx Residual dEdx Calibration
/doxy -->

# Residual dEdx Calibration

The process `o2-tpc-miptrack-filter` will execute on EPNs, filtering tracks within specified cuts and outputting them as `TPC/MIPS/0`. The cut parameters can be adjusted using the following command-line options:

```
--min-momentum (= 0.3)
--max-momentum (= 0.7)
--min-dedx (= 20)           Minimum dEdx threshold
--max-dedx (= 200)          Maximum dEdx threshold
--min-clusters (= 60)       Minimum cluster count per track
```

The process `o2-tpc-calibratordedx` should run on an aggregation node. It uses data from the `o2-tpc-miptrack-filter` to populate dEdx histograms and calculates corrections for the dE/dx values for each time slot.

```
--tf-per-slot           TFs per calibration time slot
--max-delay             Past slots to consider
--min-entries           Minimum entries per GEM stack for fitting
```

---

The workflow `o2-tpc-calibdedx` mirrors `o2-tpc-calibratordedx`, yet it focuses on computing a single correction factor using all accessible time frames.

## Running the Workflow

To execute the complete dE/dx calibration workflow, use the following command:

```
o2-tpc-track-reader --disable-mc | o2-tpc-miptrack-filter | o2-tpc-calibrator-dedx --file-dump --min-entries 100 --tf-per-slot 10
```

Here, we activate the feature to save the calibration corrections to a file, set the minimum number of entries per time slot to 100, and define that each time slot should contain 10 time frames.

## Simulating the EPN Workflow

For simulating the EPN/Agregation node topology, run the `o2-tpc-miptrack-filter` workflow, which will begin listening to `TPC/MIPS/0`, awaiting tracks data for processing.

```
o2-dpl-raw-proxy --dataspec A:TPC/MIPS/0 --channel-config "name=readout-proxy,type=pull,method=bind,address=tcp://localhost:30453,rateLogging=1,transport=zeromq" | o2-tpc-calib-dedx
```

In a separate terminal, initiate `o2-tpc-miptrack-filter`.

---

--min-entries-sector    The minimum number of entries required per GEM stack for sector-by-sector correction; if below this threshold, we only perform a single fit per ROC type (IROC, OROC1, etc.) without considering side or sector information.
--min-entries-1d        The minimum number of entries per stack for a 1D fit; below this, we only compute the mean of each GEM stack.
--min-entries-2d        The minimum number of entries per stack to conduct a 2D fit.
--fit-passes            The number of fit iterations performed.
--fit-threshold         The width of the dEdx cut around the MIP peak used in the fit.

--dedxbins              The number of dE/dx bins.
--angularbins           The number of angular bins for quantities like Tgl and Snp.
--min-dedx              The minimum dE/dx value.
--max-dedx              The maximum dE/dx value.
--fit-snp               Enable the Snp correction.

--file-dump             Save the calibration correction to a file.
--field                 The magnetic field in kG, necessary for track propagations; this value will be overridden if a grp file is present.
```

---

In a fresh shell, initiate `o2-tpc-miptrack-filter`.

```
o2-tpc-track-reader --disable-mc | o2-tpc-miptrack-filter | o2-dpl-output-proxy --channel-config "name=downstream,method=connect,address=tcp://localhost:30453,type=push,transport=zeromq" --dataspec downstream:TPC/MIPS -b
```