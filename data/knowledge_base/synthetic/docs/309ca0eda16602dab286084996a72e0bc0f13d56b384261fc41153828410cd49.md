## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/DATA/tools/epn/gen_topo.sh

**Start chunk id:** 309ca0eda16602dab286084996a72e0bc0f13d56b384261fc41153828410cd49

## Content

DOCUMENT:
    fi
else
  [[ -z "$GEN_TOPO_WORKDIR" ]] && export GEN_TOPO_WORKDIR=$HOME/gen_topo # A directory for the O2DPG repository checkout and XML cache storage. If this directory is cleared, gen_topo will regenerate necessary content the next time it runs. This folder should remain persistent to maintain workflow caches.
  mkdir -p $HOME/gen_topo
fi
[[ -z "$GEN_TOPO_EPN_CCDB_SERVER" ]] && export GEN_TOPO_EPN_CCDB_SERVER="http://127.0.0.1:8084" # The CCDB server to utilize
if [[ "0$GEN_TOPO_ONTHEFLY" == "01" ]]; then export SHM_MANAGER_SHMID=1 ;fi

---

# GEN_TOPO_RUN_HOME is a debugging setting utilized in certain tests; it is not required for online operations.
if [[ "0$GEN_TOPO_RUN_HOME" == "01" ]]; then
  if [[ "0$GEN_TOPO_RUN_HOME_TEST" != "01" && $WORKFLOWMODE != "print" ]]; then
    echo "ERROR: GEN_TOPO_RUN_HOME is only supported with WORKFLOWMODE=print!" 1>&2
    exit 1
  fi
else
  if [ "0$GEN_TOPO_ONTHEFLY" == "01" ]; then
    # Clear the modules to ensure the topology generation uses the correct O2 version, including ODC, from the RPM path.
    module purge &> /dev/null
  fi
fi
# Execute the second stage of GenTopo, handling PDP, from the hardcoded updatable RPM path.
/opt/alisw/el9/GenTopo/bin/gen_topo_o2dpg.sh
if [ $? != 0 ]; then
  exit 1
fi

---

# Additional arguments for topology merger
if [[ -z "$GEN_TOPO_ODC_EPN_TOPO_POST_CACHING_ARGS" ]]; then
  if [[ "${GEN_TOPO_DEPLOYMENT_TYPE:-}" == "ALICE_STAGING" ]]; then
    export GEN_TOPO_ODC_EPN_TOPO_POST_CACHING_ARGS="--recozone staging-mi50 --reco100zone staging-mi100 --calibzone calib"
  else
    export GEN_TOPO_ODC_EPN_TOPO_POST_CACHING_ARGS="--recozone online-mi50 --reco100zone online-mi100 --calibzone calib"
  fi
fi
if [[ -z "$GEN_TOPO_MI100_NODES" ]]; then export GEN_TOPO_MI100_NODES=-1; fi

---

# Command for merging topologies
if [[ -z "$GEN_TOPO_ODC_EPN_TOPO_CMD" ]]; then
  export GEN_TOPO_ODC_EPN_TOPO_CMD='env - PYTHONPATH+=/usr/local/lib/python3.9/site-packages:/usr/local/lib64/python3.9/site-packages /usr/local/bin/epn-topo-merger'
fi

# Command for postprocessing topology generation following topology caching
if [[ -z "$GEN_TOPO_ODC_EPN_TOPO_POST_CACHING_CMD" ]]; then
  export GEN_TOPO_ODC_EPN_TOPO_POST_CACHING_CMD='env - PYTHONPATH+=/usr/local/lib/python3.9/site-packages:/usr/local/lib64/python3.9/site-packages /usr/local/bin/epn-topo-alloc'
fi

---

#!/bin/bash

# This script acts as a wrapper to configure EPN-specific environment variables necessary for the PDP DPL Topology generation.
# Author: David Rohr

# It originates from O2DPG: https://github.com/AliceO2Group/O2DPG/blob/master/DATA/tools/epn/gen_topo.sh
# This script is installed at /opt/alisw/el9/GenTopo/bin/ as part of the GenTopo package on EPNs.

# The main goal of this script is to decouple the topology generation process (handled within O2DPG) from the EPN-specific configurations.
# It exclusively contains the EPN-specific settings.

---

# Configuration for EPN-related paths, names, and directories
[[ -z "$FILEWORKDIR" ]] && export FILEWORKDIR=/home/epn/odc/files # Location for common group and geometry files
[[ -z "$INRAWCHANNAME" ]] && export INRAWCHANNAME=tf-builder-pipe-0 # Name of the pipe from which to retrieve data from TfBuilder
[[ -z "$CTF_DIR" ]] && export CTF_DIR=/data/tf/compressed # Destination for CTF files
[[ -z "$CALIB_DIR" ]] && export CALIB_DIR=/data/calibration # Destination for calibration data files
if [[ -z "$EPN2EOS_METAFILES_DIR" ]] && [[ "0$WORKFLOWMODE" != "0print" ]]; then
  export EPN2EOS_METAFILES_DIR=/data/epn2eos_tool/epn2eos # Directory for epn2eos metadata files
fi
if [[ $USER == "epn" ]]; then
  if [[ -z "$GEN_TOPO_WORKDIR" ]]; then
    mkdir -p /var/tmp/gen_topo
    export GEN_TOPO_WORKDIR=/var/tmp/gen_topo # Directory for O2DPG repository checkout and XML cache. If this directory is cleared, gen_topo will regenerate necessary content the next time it runs. The directory should remain persistent to cache workflows.