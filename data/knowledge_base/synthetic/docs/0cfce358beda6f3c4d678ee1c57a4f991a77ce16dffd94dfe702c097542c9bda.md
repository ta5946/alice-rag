## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/DATA/production/configurations/asyncCalib/createCorrectionMap.sh

**Start chunk id:** 0cfce358beda6f3c4d678ee1c57a4f991a77ce16dffd94dfe702c097542c9bda

## Content

# job is over all files
if [[ "$mergePattern" == "all" ]]; then
  filePattern=".*"
fi

fileList=inputFileList.txt
voxResOutFile=TPCDebugVoxRes_${mergePattern}.root
splineOutFile=TPCFastTransform_${mergePattern}.root

[[ -z "${ALIEN_JDL_MAPKNOTSY}" ]] && ALIEN_JDL_MAPKNOTSY=10
[[ -z "${ALIEN_JDL_MAPKNOTSZ}" ]] && ALIEN_JDL_MAPKNOTSZ=20

# ===| create input list |=====================================================
sed -rn 's|.*turl="([^"]*)".*|\1|p' $inputCollection | grep "$filePattern" | sort -n > ${fileList}

declare -i nLines=$(wc -l ${fileList} | awk '{print $1}')
if [[ $nLines -eq 0 ]]; then
  echo "ERROR: Could not locate lines matching '${mergePattern}' in file '${inputCollection}'. Cannot proceed with SCD correction."
  exit
fi
echo "Processing residuals for $nLines input files"

---

# ===| create tree with residuals |=============================================
cmd="root.exe -q -x -l -n $O2_ROOT/share/macro/staticMapCreator.C+'(\"${fileList}\", ${ALIEN_JDL_LPMRUNNUMBER}, \"${voxResOutFile}\")' &> residuals.log"
echo "executing: '$cmd'"
if [[ $ALIEN_JDL_DONTEXTRACTTPCCALIB != "1" ]]; then
  eval $cmd
  if [[ ! -s ${voxResOutFile} ]]; then
    echo "ERROR: Output file '${voxResOutFile}' was not generated or is empty. Cannot proceed with SCD correction."
    exit
  fi
fi

---

# ===| create spline object |===================================================
cmd="root.exe -q -x -l -n $O2_ROOT/share/macro/TPCFastTransformInit.C'(\"${voxResOutFile}\", \"${splineOutFile}\")' &> splines.log"
if [[ $(grep 'TPCFastTransformInit(' $O2_ROOT/share/macro/TPCFastTransformInit.C) =~ nKnots ]]; then
  cmd="root.exe -q -x -l -n $O2_ROOT/share/macro/TPCFastTransformInit.C'(${ALIEN_JDL_MAPKNOTSY}, ${ALIEN_JDL_MAPKNOTSZ}, \"${voxResOutFile}\", \"${splineOutFile}\")' &> splines.log"
fi
echo "executing: '$cmd'"
if [[ $ALIEN_JDL_DONTEXTRACTTPCCALIB != "1" ]]; then
  eval $cmd
fi

---

#!/bin/bash

# The script generates correction maps for a list of input files.
# It requires two input parameters:
# - the xml collection of the o2tpc_residuals*.root files produced for a single run
# - the pattern of the calibration interval obtained from the 'createJobList.sh' macro.
# The script produces two output files:
# - TPCDebugVoxRes*.root, containing the tree of extracted residuals
# - TPCFastTransform*.root, containing the spline object for reconstruction.

# ===| input parameters & output file names  |==================================
inputCollection=$1
mergePattern=$2
filePattern="o2tpc_residuals_${mergePattern}\.root"

# This could be used for the old file format
if [[ $ALIEN_JDL_OLDFILENAME == "1" ]]; then
  filePattern="o2tpc_residuals${mergePattern}.*\.root"
fi

# The job processes all files
if [[ "$mergePattern" == "all" ]]; then
  filePattern=".*"
fi