## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/GRID/utils/runGRIDContainerized.sh

**Start chunk id:** e0335b933f207bec12fdb6e5d4718010d7ad5357e0e4e8e86326ec2e39addcc2

## Content

**Question:** What happens if no script is provided as an argument to the script?

**Answer:** If no script is provided as an argument to the script, it will display an error message prompting the user to provide a script to run and then exit with a status code of 1.

---

**Question:** What steps does the script take to ensure it is running in a container environment, and how does it handle different hardware architectures?

**Answer:** The script ensures it is running in a container environment by first validating the provided script to run. It then checks the hardware architecture using `uname -i` and identifies if the architecture is either ARM (`aarch64`) or X86 (`x86_64`). For ARM architectures, it sets a variable `ISAARCH64` to "1". It uses a default Singularity container, which is specified by the environment variable `APPTAINER_CONTAINER`, and falls back to `/cvmfs/alice.cern.ch/containers/fs/singularity/default` if the variable is not set. If the detected architecture is not ARM or X86, the script exits. Additionally, it creates a temporary work directory within `/tmp/alien-job-XXXXXX` if one is not specified externally.

---

**Question:** What specific action is taken if the architecture detected is not "aarch64" or "x86_64"?

**Answer:** If the detected architecture is not "aarch64" or "x86_64", the script will output "Invalid architecture ${ARCH} detected. Exiting" and terminate with an exit code of 1.

---

**Question:** What action is taken if the working directory does not exist?

**Answer:** If the working directory does not exist, an error message is printed to the console indicating that the directory ${WORK_DIR} does not exist, and the script exits with a status of 1.

---

**Question:** What steps are taken in the script to ensure that the working directory exists and to handle the absence of certificate files?

**Answer:** The script first checks if the working directory exists using the condition `if [ ! -d "${WORK_DIR}" ]; then`. If the directory does not exist, it outputs a message indicating the directory does not exist and advises to create it before running the script, followed by exiting with code 1.

To handle the absence of certificate files, the script searches for the `tokencert*pem` and `tokenkey*pem` files in the `/tmp` directory, owned by the current user, and copies them to the working directory if found. If neither certificate nor key file is found, it outputs a message suggesting to initialize a token using `alien-init-token` and exits with code 1. Specifically, it copies the certificate file to `${WORK_DIR}/usercert.pem` and the key file to `${WORK_DIR}/userkey.pem`. Furthermore, the script sets environment variables `JALIEN_TOKEN_CERT` and `JALIEN_TOKEN_KEY` in `${WORK_DIR}/envfile` pointing to these copied files.

---

**Question:** What are the specific commands and conditions used to ensure that the necessary certificate files exist in the `/tmp` directory before they are copied to the `WORK_DIR`, and what happens if the certificate files are not found?

**Answer:** The specific commands and conditions used to ensure that the necessary certificate files exist in the `/tmp` directory before they are copied to the `WORK_DIR` are as follows:

- The script first searches for certificate files in the `/tmp` directory using the `find` command, looking for files named `tokencert*pem` and `tokenkey*pem` that belong to the current user.
- If no certificate files are found, a message is printed indicating that no certificate file was found and suggesting to initialize a token with `alien-init-token` or similar commands. The script then exits with a status code of 1.
- If certificate files are found, they are copied to the `WORK_DIR` with the names `usercert.pem` and `userkey.pem`.
- After the certificate files are copied, the script creates an `envfile` in the `WORK_DIR` and sets the environment variables `JALIEN_TOKEN_CERT` and `JALIEN_TOKEN_KEY` to point to the copied certificate files.

If the certificate files are not found, the script prints an error message and exits, preventing further execution of the script.

---

**Question:** What is the command used to launch a job in the work directory using the specified container?

**Answer:** The command used to launch a job in the work directory using the specified container is:

/cvmfs/alice.cern.ch/containers/bin/apptainer/current${ISAARCH64+"-aarch64"}/bin/apptainer exec -C -B /cvmfs:/cvmfs,${WORK_DIR}:/workdir  --pwd /workdir --env-file ${WORK_DIR}/envfile ${APPTAINER_CONTAINER} /workdir/job.sh

---

**Question:** What is the purpose of the `-B` flag in the given Apptainer command and what directories does it bind mount?

**Answer:** The `-B` flag in the given Apptainer command is used to bind mount directories from the host to the container. Specifically, it binds mounts `/cvmfs` from the host to `/cvmfs` in the container, and `${WORK_DIR}` from the host to `/workdir` in the container. This allows the container to access files and directories from the host filesystem while running the job script.

---

**Question:** What specific environment variable must be set for the script within the container to correctly read the environment file located in the work directory?

**Answer:** The specific environment variable that must be set for the script within the container to correctly read the environment file located in the work directory is `APPTAINER_CONTAINER`. This variable should point to the container image, and the script should reference `${APPTAINER_CONTAINER}` to access the environment file at the correct path `${WORK_DIR}/envfile`.