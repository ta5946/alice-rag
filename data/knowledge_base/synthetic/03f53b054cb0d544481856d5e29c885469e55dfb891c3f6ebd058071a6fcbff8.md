## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/DATA/production/qc-workflow.sh

**Start chunk id:** 03f53b054cb0d544481856d5e29c885469e55dfb891c3f6ebd058071a6fcbff8

## Content

**Question:** What additional match queries and track sources are added if the ITS-TPC-TRD or ITS-TPC-TOF sources are enabled for K0 reconstruction?

**Answer:** If ITS-TPC-TRD is enabled for K0 reconstruction, the additional match queries added are:

- `trigITSTPCTRD:TRD/TRGREC_ITSTPC/0`
- `trackITSTPCTRD:TRD/MATCH_ITSTPC/0`

The corresponding track sources added are:

- `ITS-TPC-TRD`

If ITS-TPC-TOF is enabled for K0 reconstruction, the additional match query added is:

- `matchITSTPCTOF:TOF/MTC_ITSTPC/0`

---

**Question:** What is the purpose of the `QC_JSON_GLOBAL` variable and how is it set in the given script?

**Answer:** The `QC_JSON_GLOBAL` variable is used to store the path to a global quality control JSON configuration file. It is set at the end of the script, specifically if it is not already defined. The value assigned to `QC_JSON_GLOBAL` is `$O2DPG_ROOT/DATA/production/qc-sync/qc-global.json`. This ensures that the variable is only initialized once, and the assignment is made only if the variable is empty or not set.

---

**Question:** What are the specific track sources configured for the tracking task in the QC_DETECTOR_CONFIG_OVERRIDE setting?

**Answer:** The specific track sources configured for the tracking task in the QC_DETECTOR_CONFIG_OVERRIDE setting are ITS-TPC-TRD, TPC-TRD.

---

**Question:** What is the value of the environment variable `QC_JSON_MID` if the `MID_RECO` processing step is present?

**Answer:** The value of the environment variable `QC_JSON_MID` will be set to `$O2DPG_ROOT/DATA/production/qc-sync/mid.json` if the `MID_RECO` processing step is present.

---

**Question:** What sequence of commands is added to the `ITSTPCMatchQuery` variable when the TPC-TRD-TOF source is detected, and what is the purpose of these commands?

**Answer:** When the TPC-TRD-TOF source is detected, the following sequence of commands is added to the `ITSTPCMatchQuery` variable:

```plaintext
ITSTPCMatchQuery+=";matchTPCTRDTOF:TOF/MTC_TPCTRD/0"
```

The purpose of these commands is to match tracks from the TPC-TRD-TOF combination and specify the corresponding TPC-TRD-TOF match container in the TOF/MTC_TPCTRD/0 path. This facilitates the alignment and tracking of particles using the combined information from the TPC, TRD, and TOF detectors.

---

**Question:** What condition must be met for the variable `QC_JSON_CTF_SIZE` to be set to a specific URL?

**Answer:** The variable `QC_JSON_CTF_SIZE` must be set to a specific URL if the following conditions are met:
- The processing step `ENTROPY_ENCODER` is present.
- The environment variable `WORKFLOW_DETECTORS_CTF` is not empty.
- The environment variable `WORKFLOW_DETECTORS_CTF` is not set to "NONE".
- The detector `CTP` is present.

---

**Question:** What is the value of `QC_JSON_EMC` when the beam type is PbPb and the CTP detector is present?

**Answer:** apricot://o2/components/qc/ANY/any/emc-qcmn-epnall-withCTP-PbPb

---

**Question:** What is the sequence of conditions checked to set the `QC_JSON_GLO_MFTMCH` variable, and what file is assigned to it in each condition?

**Answer:** The sequence of conditions checked to set the `QC_JSON_GLO_MFTMCH` variable and the file assigned to it in each condition are as follows:

1. If both MFT, MCH, and MID detectors are present, and the matching QC conditions MFTMCH and MCHMID are met, then:
   - `QC_JSON_GLO_MFTMCH` is set to the file: `$O2DPG_ROOT/DATA/production/qc-async/mftmchmid-tracks.json`

2. If both MFT and MCH detectors are present, and the matching QC condition MFTMCH is met, then:
   - `QC_JSON_GLO_MFTMCH` is set to the file: `$O2DPG_ROOT/DATA/production/qc-async/mftmch-tracks.json`

3. If both MCH and MID detectors are present, and the matching QC condition MCHMID is met, then:
   - `QC_JSON_GLO_MCHMID` (a different variable from `QC_JSON_GLO_MFTMCH`) is set to the file: `$O2DPG_ROOT/DATA/production/qc-async/mchmid-tracks.json`

---

**Question:** Which JSON configuration files are used for the ITS, TPC, and TOF quality control processes, and where are they located by default?

**Answer:** For the ITS, TPC, and TOF quality control processes, the following JSON configuration files are used by default:

- ITS: $O2DPG_ROOT/DATA/production/qc-async/its.json
- TPC: $O2DPG_ROOT/DATA/production/qc-async/tpc.json
- TOF: $O2DPG_ROOT/DATA/production/qc-async/tof.json

These files are located within the directory specified by the environment variable O2DPG_ROOT, specifically in the subdirectory DATA/production/qc-async.

---

**Question:** What condition determines whether the K0s part is enabled or disabled in the script, and what are the specific actions taken in each case?

**Answer:** The K0s part is determined to be enabled or disabled based on the `SYNCMODE` and `EPNSYNCMODE` variables. If either `SYNCMODE` or `EPNSYNCMODE` is set to 1, the K0s part is enabled, and specific actions are taken to modify the configuration files. In this case, the script performs modifications to the `.dataSamplingPolicies` and `trackSourcesK0` settings, utilizing the `jq` command to update the query and track sources accordingly. If neither `SYNCMODE` nor `EPNSYNCMODE` is 1, the K0s part is considered disabled, and the script creates a temporary file without making any changes to the data sampling policies or track sources.

---

**Question:** What value is assigned to `QC_JSON_GLO_MFTMCH` if only MFT and MCH detectors are present and their matching QC is available?

**Answer:** [[ -z "${QC_JSON_GLO_MFTMCH:-}" ]] && QC_JSON_GLO_MFTMCH=apricot://o2/components/qc/ANY/any/glo-mftmch-mtch-qcmn-epn

---

**Question:** What condition must be met for the TOF matching QC JSON to be added in the script?

**Answer:** For the TOF matching QC JSON to be added in the script, the following conditions must be met:
- The TOF detector must be present, indicated by `has_detector_qc TOF`.
- The workflow must include TOF matching, which is checked by the regex `$WORKFLOW_DETECTORS_QC =~ (^|,)"TOF_MATCH"(,|$)`.
- The environment variable `QC_JSON_TOF_MATCH` must be defined and not empty.

---

**Question:** What are the main components of the ALICE O2 event structure and what is the purpose of each component in the data processing flow?

**Answer:** In the ALICE O2 event structure, the main components and their purposes in the data processing flow are as follows:

1. **Header Information**: This component contains metadata about the event, such as the event number, time stamp, and collision vertex coordinates. It serves as a reference point for all subsequent data and helps in organizing and identifying events.

2. **Particle Data**: This section holds the primary information about particles detected, including their type, momentum, position, and other kinematic properties. It is essential for analyzing particle interactions and tracking their trajectories.

3. **Track Information**: Here, detailed data about individual tracks is stored, such as track parameters, charge, and impact parameters. This is crucial for reconstructing the paths of particles and understanding their behavior in the collision.

4. **Cluster Data**: This component includes information about clusters, which are groups of particles that are detected together. It aids in the identification and analysis of particle interactions and the structure of the collision.

5. **Geometry Information**: This part provides details about the detector setup, including the position and orientation of various detector components. It is vital for accurately interpreting the data and aligning it with the physical setup of the experiment.

6. **Trigger Information**: This section contains information about the trigger conditions that were met, indicating the type of collision and the level of energy involved. It is fundamental for selecting and prioritizing events for further analysis.

7. **Calibration Data**: This component includes calibration information necessary for converting raw data into meaningful physical quantities. It ensures the accuracy and reliability of the data processing.

8. **User Data**: This area allows for storing additional user-defined information, which can be useful for specific analysis needs or for customizing the data processing workflow.

Each component plays a critical role in the overall data processing flow, facilitating the analysis of particle interactions and providing a structured framework for data interpretation in the ALICE O2 framework.

---

**Question:** What happens if neither the ZDC detector is present nor the ZDC_RECO processing step is active?

**Answer:** If neither the ZDC detector is present nor the ZDC_RECO processing step is active, then the variable QC_JSON_ZDC is not set, leaving it empty.

---

**Question:** What command and condition are used to check if a QC JSON file is valid, and what action is taken if the file is invalid?

**Answer:** The command used to check if a QC JSON file is valid is `jq -rM '""' > /dev/null < $TMP_FILENAME`. If the file is invalid, the action taken is to echo an error message "Invalid QC JSON $2" to standard error and exit with status 1.

---

**Question:** What is the purpose of the `FETCHTMPDIR` variable and how is it set in the script?

**Answer:** The `FETCHTMPDIR` variable is used to store the path of a temporary directory created for fetching JSON files. It is set using the `mktemp` command with the `-d` and `-t` options, which creates a unique directory in the temporary directory, named with a prefix of `GEN_TOPO_DOWNLOAD_JSON`.

---

**Question:** What is the sequence of conditions and actions taken for setting the `QC_JSON_PID_FT0TOF` variable in the given script?

**Answer:** The sequence of conditions and actions taken for setting the `QC_JSON_PID_FT0TOF` variable in the given script is as follows:

1. First, it checks if the `QC_JSON_PID_FT0TOF` variable is not set using `[[ -z "${QC_JSON_PID_FT0TOF:-}" ]]`.
2. If `QC_JSON_PID_FT0TOF` is not set:
   - It verifies if both `ITS-TPC` and `ITS-TPC-TRD` have tof matching sources using `has_tof_matching_source ITS-TPC && has_tof_matching_source ITS-TPC-TRD`. If true, it sets `QC_JSON_PID_FT0TOF` to `$O2DPG_ROOT/DATA/production/qc-async/pidft0tofwtrd.json`.
   - If the above condition is not met, it checks if `ITS-TPC` has a tof matching source using `has_tof_matching_source ITS-TPC`. If true, it sets `QC_JSON_PID_FT0TOF` to `$O2DPG_ROOT/DATA/production/qc-async/pidft0tof.json`.
3. The script does not set `QC_JSON_PID_FT0TOF` if the above conditions are not met.

This sequence ensures that the appropriate JSON file for PID analysis with TOF matching is selected based on the available sources.

---

**Question:** What is the purpose of the `MERGED_JSON_FILENAME` variable in the given script?

**Answer:** The `MERGED_JSON_FILENAME` variable in the given script is used to store the name of the merged JSON file that is created by aggregating the input JSON files, including global QC configuration, detector-specific overrides, and other JSON files provided in the `JSON_FILES` variable. This merged JSON file serves as a central configuration file for the QC (Quality Control) workflow, combining multiple sources of QC tasks, checks, external tasks, postprocessing steps, and data sampling policies into a single document.

---

**Question:** What actions are taken if the environment variable `QC_REDIRECT_MERGER_TO_LOCALHOST` is set to `1`?

**Answer:** If the environment variable `QC_REDIRECT_MERGER_TO_LOCALHOST` is set to `1`, the following actions are taken:

1. A `sed` command modifies the `MERGED_JSON_FILENAME` file in place, replacing the `"remoteMachine"` entry with `"127.0.0.1"`.
2. A backup of the modified file is created with the `.bak` extension.
3. The backup file is then removed.
4. A string is appended to `QC_CONFIG_OVERRIDE` to set the database host to `ccdb-test.cern.ch:8080`.

---

**Question:** What modifications are made to the JSON file when the SYNCMODE or EPNSYNCMODE is set to 1, and how do these modifications differ from the case when SYNCMODE or EPNSYNCMODE is not set to 1?

**Answer:** When SYNCMODE or EPNSYNCMODE is set to 1, the JSON file is modified to include specific configurations for the ITSTPCmSampK0 data sampling policy and the MTCITSTPC task. Specifically, the query for the ITSTPCmSampK0 data sampling policy is set to the value of $ITSTPCMatchQuery, and the track sources and K0 quality control parameters for the MTCITSTPC task are configured with the values of $TRACKSOURCESK0 and false, respectively.

In contrast, when SYNCMODE or EPNSYNCMODE is not set to 1, the modifications apply to a different task, GLOMatchTrITSTPC, and involve setting the query for the global match task to the value of $ITSTPCMatchQuery, and configuring the track sources and K0 quality control parameters with the values of $TRACKSOURCESK0 and false, respectively.

---

**Question:** What is the condition under which the variable `QC_JSON_ZDC` is set to `$O2DPG_ROOT/DATA/production/qc-sync/zdc.json`?

**Answer:** The variable `QC_JSON_ZDC` is set to `$O2DPG_ROOT/DATA/production/qc-sync/zdc.json` if the `ZDC_RECO` processing step is present.

---

**Question:** What condition must be met for the script to set the `QC_JSON_TOF_MATCH` variable, and what are the two specific sources checked for this condition?

**Answer:** For the script to set the `QC_JSON_TOF_MATCH` variable, the condition must be that both `has_tof_matching_source ITS-TPC` and `has_tof_matching_source ITS-TPC-TRD` return true. The two specific sources checked for this condition are `ITS-TPC` and `ITS-TPC-TRD`.

---

**Question:** What is the sequence of conditions and actions taken for setting the `QC_JSON_EMC` variable based on the `BEAMTYPE`?

**Answer:** The sequence for setting the `QC_JSON_EMC` variable based on `BEAMTYPE` involves the following steps:

1. Check if the `QC_JSON_EMC` variable is empty using `[[ -z "${QC_JSON_EMC:-}" ]]`.
2. If `QC_JSON_EMC` is empty, proceed to determine the `BEAMTYPE`.
3. If `BEAMTYPE` is "PbPb":
   - Set `QC_JSON_EMC` to `$O2DPG_ROOT/DATA/production/qc-async/emc_PbPb.json`.
4. If `BEAMTYPE` is not "PbPb":
   - Set `QC_JSON_EMC` to `$O2DPG_ROOT/DATA/production/qc-async/emc.json`.

---

**Question:** What additional condition is checked when fetching QC JSON from an apricot server, and how does it affect the URL formation?

**Answer:** When fetching QC JSON from an apricot server, an additional condition checks if the URL contains a "?", which affects how the URL is formed. If the URL does contain a "?", it uses the format:
```
${GEN_TOPO_QC_APRICOT_SERVER}/${2/apricot:\/\/o2\//}\&run_type=${RUNTYPE:-}\&beam_type=${BEAMTYPE:-}\&process=true
```
Otherwise, it uses:
```
${GEN_TOPO_QC_APRICOT_SERVER}/${2/apricot:\/\/o2\//}?run_type=${RUNTYPE:-}\&beam_type=${BEAMTYPE:-}\&process=true
```

---

**Question:** What will be the value of `QC_JSON_TOF_MATCH` if the TOF matching source is neither ITS-TPC-TRD nor ITS-TPC?

**Answer:** QC_JSON_TOF_MATCH will not be set if the TOF matching source is neither ITS-TPC-TRD nor ITS-TPC.

---

**Question:** What condition must be met for the variable `HAS_K0_ENABLED` to be set using `jq` on the `qc.tasks.MTCITSTPC.taskParameters.doK0QC` field from the `LOCAL_FILENAME` JSON file?

**Answer:** The variable `HAS_K0_ENABLED` must be set using `jq` on the `qc.tasks.MTCITSTPC.taskParameters.doK0QC` field from the `LOCAL_FILENAME` JSON file if the following conditions are met:

1. The `BEAMTYPE` is not "cosmic".
2. Either the processing step `MATCH_SECVTX` is present or there is a detector matching for `SECVTX`.
3. The `SYNCMODE` is 1.
4. The `EPNSYNCMODE` is 1.

---

**Question:** What is the condition for setting the `QC_JSON_GLO_MFTMCH` variable, and what is the default value if the condition is met?

**Answer:** The `QC_JSON_GLO_MFTMCH` variable is set if the following conditions are met:
- `has_detectors_reco MFT MCH MID` is true and both `has_matching_qc MFTMCH` and `has_matching_qc MCHMID` are true.
The default value for `QC_JSON_GLO_MFTMCH` is `$O2DPG_ROOT/DATA/production/qc-sync/glo-mftmchmid-mtch-qcmn-epn.json` if the condition is satisfied.

---

**Question:** What will happen if the variable `QC_JSON_CTF_SIZE` is set but the `add_pipe_separated` function is commented out?

**Answer:** If the variable `QC_JSON_CTF_SIZE` is set but the `add_pipe_separated` function is commented out, the CTF QC will not be added to the JSON output. The relevant line in the document is:

```bash
#  add_pipe_separated QC_DETECTOR_CONFIG_OVERRIDE '.qc.tasks.CTFSize.taskParameters.detectors=\"${WORKFLOW_DETECTORS}\"'
```

This line would normally add the CTF QC with the specified configuration. Since it is commented out, the CTF QC will not be added, even though `QC_JSON_CTF_SIZE` is set.

---

**Question:** What is the purpose of the `add_W` function call in the given script, and what does it do with the provided parameters?

**Answer:** The `add_W o2-qc "--config json://$QC_JSON_FROM_OUTSIDE ${QC_CONFIG_PARAM} ${QC_CONFIG}"` function call is used to add a monitoring task to a workflow manager in the context of the ALICE O2 simulation. Specifically, it configures the o2-qc tool to use a JSON configuration file specified by the environment variable `QC_JSON_FROM_OUTSIDE`. The `-W` option is likely being used to define a worker task in a grid or batch system. The `--config` parameter is set to point to the JSON configuration file, while `QC_CONFIG_PARAM` and `QC_CONFIG` are appended to customize the behavior, such as setting the host and additional configuration options. This command ensures that the monitoring tool runs with the specified configuration file and parameters, enabling the monitoring of the simulation or analysis process.

---

**Question:** Under what conditions will the Tracking and PHTrackMatch tasks be deactivated for TRD quality checks?

**Answer:** The Tracking and PHTrackMatch tasks will be deactivated for TRD quality checks if either of the following conditions is met:
- There is no matching quality check set for ITSTPCTRD or
- There are no detectors in reco mode for ITS, TPC, and TRD.

---

**Question:** What happens if both `QC_JSON_FROM_OUTSIDE` and `GEN_TOPO_QC_JSON_FILE` are not set, and the EPNSYNCMODE is 1 or if `GEN_TOPO_LOAD_QC_JSON_FROM_CONSUL` is set to 1?

**Answer:** If both `QC_JSON_FROM_OUTSIDE` and `GEN_TOPO_QC_JSON_FILE` are not set, and the EPNSYNCMODE is 1 or if `GEN_TOPO_LOAD_QC_JSON_FROM_CONSUL` is set to 1, then the following actions are taken:

1. If `QC_JSON_TPC` is not set, it will be assigned the value `apricot://o2/components/qc/ANY/any/tpc-full-qcmn`.
2. If `QC_JSON_ITS` is not set, it will be assigned the value `apricot://o2/components/qc/ANY/any/its-qcmn-epn-full`.
3. If `QC_JSON_MFT` is not set and the MFT detector is present with the MFT_RECO processing step, `QC_JSON_MFT` will be assigned the value `apricot://o2/components/qc/ANY/any/mft-full-qcmn`.
4. If the MFT detector is present but the MFT_RECO processing step is not, `QC_JSON_MFT` will be assigned the value `apricot://o2/components/qc/ANY/any/mft-full-no-tracks-qcmn`.