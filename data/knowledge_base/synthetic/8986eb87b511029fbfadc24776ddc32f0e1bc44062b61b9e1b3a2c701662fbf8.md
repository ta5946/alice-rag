## Metadata

**Document link:** https://github.com/AliceO2Group/O2DPG/blob/master/GRID/utils/runGRIDContainerized.sh

**Start chunk id:** 8986eb87b511029fbfadc24776ddc32f0e1bc44062b61b9e1b3a2c701662fbf8

## Content

**Question:** What steps are taken in the script to ensure that the working directory exists and to handle the absence of certificate files?

**Answer:** The script first checks if the working directory exists using the condition `if [ ! -d "${WORK_DIR}" ]; then`. If the directory does not exist, it outputs a message indicating the directory does not exist and advises to create it before running the script, followed by exiting with code 1.

To handle the absence of certificate files, the script searches for the `tokencert*pem` and `tokenkey*pem` files in the `/tmp` directory, owned by the current user, and copies them to the working directory if found. If neither certificate nor key file is found, it outputs a message suggesting to initialize a token using `alien-init-token` and exits with code 1. Specifically, it copies the certificate file to `${WORK_DIR}/usercert.pem` and the key file to `${WORK_DIR}/userkey.pem`. Furthermore, the script sets environment variables `JALIEN_TOKEN_CERT` and `JALIEN_TOKEN_KEY` in `${WORK_DIR}/envfile` pointing to these copied files.

---

**Question:** What is the purpose of the `-B` flag in the given Apptainer command and what directories does it bind mount?

**Answer:** The `-B` flag in the given Apptainer command is used to bind mount directories from the host to the container. Specifically, it binds mounts `/cvmfs` from the host to `/cvmfs` in the container, and `${WORK_DIR}` from the host to `/workdir` in the container. This allows the container to access files and directories from the host filesystem while running the job script.

---

**Question:** What steps does the script take to ensure it is running in a container environment, and how does it handle different hardware architectures?

**Answer:** The script ensures it is running in a container environment by first validating the provided script to run. It then checks the hardware architecture using `uname -i` and identifies if the architecture is either ARM (`aarch64`) or X86 (`x86_64`). For ARM architectures, it sets a variable `ISAARCH64` to "1". It uses a default Singularity container, which is specified by the environment variable `APPTAINER_CONTAINER`, and falls back to `/cvmfs/alice.cern.ch/containers/fs/singularity/default` if the variable is not set. If the detected architecture is not ARM or X86, the script exits. Additionally, it creates a temporary work directory within `/tmp/alien-job-XXXXXX` if one is not specified externally.